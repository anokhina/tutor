<!DOCTYPE html>
<!--
Copyright 2017 Veronica Anokhina.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style type="text/css">
html, body {
    /*height:99%;*/
    width:100%;
    padding:0px;
    margin:0px;
}   
.inline {
    display: inline-block;
    padding-top: 2px;
}  
textarea { 
    resize:vertical; 
    padding: 0px;
    margin: 0px;    
}

/* Style the tab */
div.tab {
    overflow: hidden;
    border: 1px solid #ccc;
    background-color: #e5e5e5;
}

/* Style the buttons inside the tab */
div.tab button {
    background-color: inherit;
    float: left;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 4px 6px;
    transition: 0.3s;
    font-size: large;
}

/* Change background color of buttons on hover */
div.tab button:hover {
    background-color: #ddd;
}

/* Create an active/current tablink class */
div.tab button.active {
    background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
    display: none;
    padding: 0px;
    border: 1px solid #ccc;
    border-top: none;
    background-color: #f1f1f1;
}

.tcontent {
    padding: 5px;
}

/* Style the close button */
.topright {
    float: right;
    cursor: pointer;
    font-size: large;
    padding: 0px 4px 0px 0px;
}

.topright:hover {color: red;}

#opstatus {
    background-color: #bbb;
}
.controldiv {
    position: fixed;
    width: 100%;
    top: 0;
    z-index: 200;
}
.controlleddiv {
    position: relative;
    top: 50px;
}
.rowbg {
    background-color: #ccc;
}
.rowbgm {
    background-color: #ddd;
}
.rowbgl {
    background-color: #f1f1f1;
}
.Reset {
    margin-top: 5px;
    margin-bottom: 5px;
}
  </style>

<body>

<script type="text/javascript" src="jslib/UTIL.js"></script>
<script type="text/javascript" src="jslib/UTILDB.js"></script>
<script type="text/javascript" src="jslib/UTILIO.js"></script>

<script>

function newEvent() {
    document.getElementById('eid').value = "";
    document.getElementById('ename').value = "";
    document.getElementById('ememo').value = "";
    document.getElementById('elen').value = 1;
    document.getElementById('edate').value = document.getElementById('edate').value = new Date().toISOString().substr(0, 10);
}
function addEvent() {
    var ename = document.getElementById('ename').value, 
        ememo = document.getElementById('ememo').value, 
        elen = document.getElementById('elen').value, 
        etag = document.getElementById('etag').value, 
        edate = document.getElementById('edate').value;//TODO check
    if (edate) {
        edate = new Date(edate).toISOString().substr(0, 10);
    }
    addEventDB(db, {edate:edate, ename:ename, ememo:ememo, elen:elen, etag:etag});
    showEvents(db, 2);
}
function saveEvent() {
    var eid = document.getElementById('eid').value, 
        ename = document.getElementById('ename').value, 
        ememo = document.getElementById('ememo').value, 
        elen = document.getElementById('elen').value, 
        etag = document.getElementById('etag').value, 
        edate = document.getElementById('edate').value;//TODO check
    if (edate) {
        edate = new Date(edate).toISOString().substr(0, 10);
    }
    
    if (eid && confirm("Save changes for [" + eid + "] " + ename) == true) {
        saveEventDB(db, {id: eid, edate:edate, ename:ename, ememo:ememo, elen:elen, etag:etag});
        showEvents(db, 2);
    }    
}
function delEvent() {
    var eid = document.getElementById('eid').value, 
        ename = document.getElementById('ename').value, 
        ememo = document.getElementById('ememo').value, 
        elen = document.getElementById('elen').value, 
        edate = document.getElementById('edate').value;//TODO check
    if (edate) {
        edate = new Date(edate).toISOString().substr(0, 10);
    }
    
    if (confirm("Delete [" + eid + "] " + ename) == true) {
        deleteEventDB(db, eid);
        showEvents(db, 2);
    }    
}
function showHtml(obj) {
    //if (obj.id)
    processById(db, obj.id, showHtmlObj);
}
function showHtmlObj(obj) {
    var frame = document.getElementById("theFrame");
          
    var doc = document.implementation.createHTMLDocument("");
    doc.body.innerHTML = obj.ememo;

    var destDocument = frame.contentDocument;
    var newNode = destDocument.importNode(doc.documentElement, true);

    destDocument.replaceChild(newNode, destDocument.documentElement);
    openTab({ currentTarget: document.getElementById("buttonView") }, "View");
}
function viewMemo() {
    showHtmlObj ({ ememo: document.getElementById("ememo").value });
}

function editEvent(obj) {
    //if (obj.id)
    processById(db, obj.id, editEventObj);
}
function editEventObj(obj) {
    //TODO check form changes
    ///////////////obj.id 
    var eid = document.getElementById('eid').value, 
        ename = document.getElementById('ename').value;

    if (eid || ename) {
        if (confirm("Discard unsaved changes for [" + eid + "] " + ename) == false) {
            return;
        }
    }
    
    //ename, ememo, id, elen, pdate, edate, dlen
    document.getElementById('eid').value = obj["id"];
    document.getElementById('ename').value = obj["ename"];
    document.getElementById('ememo').value = obj["ememo"];
    document.getElementById('elen').value = obj["elen"];
    document.getElementById('etag').value = obj["etag"];
    document.getElementById('edate').value = null;
    try {
        document.getElementById('edate').value = new Date(obj["edate"]).toISOString().substr(0, 10);
    } catch (e) {}
    openTab({ currentTarget: document.getElementById("buttonEdit") }, "Edit");

}
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    if (evt) {
        evt.currentTarget.className += " active";
    }
    window.scrollTo(0, 0);
}
function showStatus(m, o, exc) {
    var now = new Date().toISOString().slice(0,19).replace("T", " ");
    if (!o) {
        o = m;
    }
    var msg = now + ": <pre>" + UTIL.escapeHTML(o) + "</pre>";
    var msgSh = now + ": " + UTIL.escapeHTML(m);
    var statDiv = document.getElementById('opstatus');
    if (statDiv) {
        statDiv.innerHTML = msgSh;
    }
    var errDiv = document.getElementById('errorDiv');
    if (errDiv) {
        errDiv.innerHTML = msg + "<p>" + errDiv.innerHTML;
    }
    if (exc) {
        console.log(exc);
    }
}

function searchFormReset() {
    document.getElementById("searchForm").reset();
    var zeroDate = new Date();
    zeroDate.setTime(0);
    var futureDate = new Date();
    futureDate.setFullYear(futureDate.getFullYear()+100);
    document.getElementById('fromdate').value = zeroDate.toISOString().substr(0, 10);
    document.getElementById('todate').value = futureDate.toISOString().substr(0, 10);
}
function saveObj2FS(obj, filePrefix) {
    var filenameUname = "-" + "events" + "-";
    if (filePrefix === undefined ) {
        filePrefix = "exportData";
    }
    UTILIO.saveAs(UTILIO.text2blob(UTIL.objDB2text(obj)), filePrefix+filenameUname+UTIL.date2text(new Date())+".json");
}
function exportData() {
    showEvents(db, null, saveObj2FS );
}
function importData(obj) {
    console.log(obj);
    //fillTable(obj);
    if (confirm("Will import data from file? All data to be overwritten") == true) {
        importTable(obj, 0, []);
    }
}
</script>

<div class="controldiv">

    <div id="opstatus">Ok</div>

    <div class="tab">
      <button class="tablinks" onclick="openTab(event, 'Find')" id="defaultOpen">Find</button>
      <button class="tablinks" onclick="openTab(event, 'Edit')" id="buttonEdit">Edit</button>
      <button class="tablinks" onclick="openTab(event, 'Import')">Import</button>
      <button class="tablinks" onclick="openTab(event, 'View')" id="buttonView">View</button>
      <button class="tablinks" onclick="openTab(event, 'Errors')">Errors</button>
    </div>
</div>


<div class="controlleddiv">


    <div id="View" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <iframe id="theFrame" srcdoc="" width="100%"></iframe>
        </div>
    </div>

    <div id="Edit" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <form id="editForm">
            <table border=0 style="width:100%">
            <tr><td>
            <input type="text" readonly="true" id="eidprefix" name="eidprefix"/>
            </td></tr><tr><td>
            <input type="text" readonly="true" id="eid" name="eid"/>
            <div class="inline">Date: <input type="date" id="edate" name="edate" /></div>
            <div class="inline">Length: <input type="text" id="elen" name="elen" value="1" type="number" size="4" min="0" maxlength="3" oninput="this.value=this.value.slice(0,this.maxLength||1/1);parseInt(this.value);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
            <div class="inline">Tag: <input type="text" id="etag" name="etag" type="number" size="4" min="-1" maxlength="3" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value = parseInt(this.value); this.value=(this.value   < parseInt(this.min)) ? (parseInt(this.min)) : isNaN(parseInt(this.value)) ? 0 : this.value"/></div>
            <div>Name:</div><input type="text" id="ename" name="ename" style="width:100%"/>
            </td></tr><tr><td><div class="inline-no">Memo: <textarea rows="5" type="text" id="ememo" name="ememo" style="width:100%" ></textarea></div>
            </td></tr><tr><td>
            <input type="button" onclick="delEvent()" value="Del"/>
            <input type="button" onclick="newEvent()" value="New"/>
            <input type="button" onclick="addEvent()" value="Add"/>
            <input type="button" onclick="saveEvent()" value="Save"/>
            <input type="button" onclick="viewMemo()" value="View memo"/>
            </td></tr>
            </table>
            </form>
        </div>
    </div>

    <div id="Import" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <input type="button" onclick="exportData()" value="Export"/>
            <form id="exportForm">
            <table style="width:100%"><tr>
            <td>
            <button type="reset" value="Reset" class="Reset">Reset</button>
            Import: <input type="file" id="files1" name="files1[]" />
            </td>
            </tr>
            </table>
            </form>
        </div>
    </div>

    <div id="Find" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <form id="searchForm" onsubmit="showEvents(db, 2); return false;">
            <table border=0 style="width:100%"><tr>
            <td>
            <input type="submit" value="Log">
            <input type="button" onclick="searchFormReset()" value="Reset"/>
            </td></tr><tr><td>
            <div class="inline">From date: <input type="date" id="fromdate" name="fromdate" /></div>
            <div class="inline">To date: <input type="date" id="todate" name="todate" /></div>
            <div>Name:</div><input type="text" id="fename" name="fename" style="width:100%" value="test%"/>
            <div class="inline">Tag: <input type="text" id="fetag" name="fetag" type="number" size="4" min="-1" maxlength="3" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value = parseInt(this.value); this.value=(this.value   < parseInt(this.min)) ? (parseInt(this.min)) : isNaN(parseInt(this.value)) ? '' : this.value"/></div>
            </td></tr><tr><td>
            <input type="button" onclick="document.getElementById('eoffset').value = 0; showEvents(db, 2);" value="Begin>"/>
            <input type="button" onclick="if(parseInt(document.getElementById('eoffset').value) >= parseInt(document.getElementById('elimit').value)) { document.getElementById('eoffset').value= parseInt(document.getElementById('eoffset').value) - parseInt(document.getElementById('elimit').value);showEvents(db, 2);}" value="&lt;Prev"/>

            <input type="button" onclick="document.getElementById('eoffset').value = parseInt(document.getElementById('eoffset').value) + parseInt(document.getElementById('elimit').value) ;showEvents(db, 2);" value="Next>"/>
            <input type="button" onclick="document.getElementById('eoffset').value = LAST_OFFSET; showEvents(db, 2);" value="Last offset>"/>
            <div id="countDiv" class="inline" style="padding-left:5px;"></div>
            </td></tr><tr><td>
            <div class="inline">Limit: <input type="text" id="elimit" name="elimit" value="30" size="4" min="5" maxlength="3" onchange="document.getElementById('eoffset').step=this.value;" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
            <div class="inline">Offset: <input id="eoffset" name="eoffset" value="0" step="30" type="number" min="0" maxlength="40" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
            </td></tr><tr><td>
            <input type="checkbox" id="showAsHTML"/>As Html
            </td></tr>
            </table>
            </form>
        </div>
    </div>

    <div id="Errors" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <span onclick="document.getElementById('errorDiv').innerHTML='<p>'" class="topright">&empty;&nbsp;</span>
        <div class="tcontent">
        <div id="errorDiv">Ok</div>
        </div>
    </div>
    
<table id="eventListTable" width="100%" style="margin-top: .5em;" >
</table>

</div>

<script>
newEvent();
searchFormReset();
document.getElementById('files1').addEventListener('change', 
    function(evt) {
        new UTILIO.FileOpenerText(function(text){
            try {
                var cfg = JSON.parse(text);
                importData(cfg);
            } catch (e) {
                console.log("parse json error", e);
                showStatus("parse json error");
            }
        }).handleFileSelect(evt);
    }, false);

    var __idprefix = null;
    var db = openDatabase('sevnEvents', '1.0', 'Events db', 20 * 1024 * 1024);
//UTILDB.dropTables(db, ["events", "idprefix"]);
//UTILDB.dropViews(db, ["v_events"]);    
    db.transaction(
    //SELECT ROWID, * FROM events ORDER BY edate DESC, ename ASC
        function(transaction) {
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS events ' +
                '  (id TEXT NOT NULL PRIMARY KEY, ' +
                '   edate DATE NOT NULL,'  +
                '   elen INTEGER NOT NULL,'  +
                '   ename TEXT NOT NULL,' +
                '   etag INTEGER,' +
                '   ememo TEXT);'
            );
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS idprefix ' +
                '  (id INTEGER NOT NULL PRIMARY KEY, ' +
                '   name TEXT);'
            );
        }
    );
    db.transaction(
        function(transaction) {
            transaction.executeSql(
                'ALTER TABLE events ' +
                '  ADD COLUMN ' +
                '    etag INTEGER'
            );
        }
    );    
    getPrefix(db);
    
function addEventDB(db, evt /*edate, ename, ememo, elen*/) {
    var id = __idprefix + "-" + UTIL.generateGuid();
    db.transaction(function (tx) {
        tx.executeSql('INSERT INTO events (id, edate, ename, ememo, elen, etag) VALUES (?,?,?,?,?, ?)', [evt.id, evt.edate, evt.ename, evt.ememo, evt.elen, evt.etag], 
            function(transaction, results){ 
                showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
                //console.log(results); 
            }, 
            function(err) { 
                showStatus("Error");
                //console.log(err);
            }
        );
    });
}
function replaceEventDB(db, evt /*{id, edate, ename, ememo, elen}*/, errLines, callback) {
    db.transaction(function (tx) {
        tx.executeSql('INSERT INTO events (id, edate, ename, ememo, elen, etag) VALUES (?,?,?,?,?,?)', [evt.id, evt.edate, evt.ename, evt.ememo, evt.elen, evt.etag], 
            function(transaction, results){ 
                showStatus("Inserted or updated: " + results.rowsAffected + " rows,  id=" + results.insertId);
                //console.log(results); 
                if (callback) callback();
            }, 
            function(err) { 
                showStatus("Error");
                console.log(err);
                saveEventDB(db, evt /*id, edate, ename, ememo, elen*/, errLines, callback);
            }
        );
    });
}
function saveEventDB(db, evt /*id, edate, ename, ememo, elen*/, errLines, callback) {
     db.transaction(function (tx) {
        tx.executeSql('UPDATE events SET edate = ?, ename = ?, ememo = ?, elen = ?, etag = ? WHERE id = ? ', [ evt.edate, evt.ename, evt.ememo, evt.elen, evt.etag, evt.id], 
            function(transaction, results){ 
                showStatus("Updated: " + results.rowsAffected);
                //console.log(results); 
                if (callback) callback();
            }, 
            function(err) { 
                showStatus("Error");
                if (errLines) {
                    errLines.push({id: evt.id, edate: evt.edate, ename: evt.ename, ememo: evt.ememo, elen: evt.elen, errLines: evt.errLines, etag:evt.etag});
                }
                //console.log(err);
                if (callback) callback();
            }
        );
     });
}    
function deleteEventDB(db, id) {
     db.transaction(function (tx) {
        tx.executeSql('DELETE FROM events WHERE id = ? ', [id], 
            function(transaction, results){ 
                showStatus("Deleted: " + results.rowsAffected);
                //console.log(results); 
            }, 
            function(err) { 
                showStatus("Error");
                //console.log(err);
            }
        );
     });
}

function importTable(results_rows, i, errLines) {
    //ename, ememo, id, elen, pdate, edate, dlen
    if (i < results_rows.length) {
        var rowIt = rowItem(results_rows,i);
        replaceEventDB(db, rowIt/*["id"], rowIt["edate"], rowIt["ename"], rowIt["ememo"], rowIt["elen"]*/, errLines, function() {
            importTable(results_rows, i+1, errLines)
        });
    } else {
        if (errLines && errLines.length > 0) {
            saveObj2FS(toObject(errLines), "importError");
        }
    }
}
function fillTable(results_rows) {
    var len = results_rows.length,
        offset = parseInt(document.getElementById('eoffset').value),
        showAsHTML = document.getElementById('showAsHTML').checked;
    if(isNaN(offset)) offset = 0;
                
    var table = document.getElementById("eventListTable");
    while(table.rows.length > 0) {
        table.deleteRow(0);
    }

    //ename, ememo, id, elen, pdate, edate, dlen
    var columnNames = {id: "", etag:"", edate: "", dlen: "", ename: "", elen: "", ememo: ""};
    var trow = 0;
    var row;
    for (var i = 0; i < len; i++) {
        row = table.insertRow(trow++);
        if (i == 0) {
            row.classList.add("rowbg");

            var j = 0;
            
            var cellNum = row.insertCell(j);
            j++;
            var element = document.createElement("div");
            cellNum.appendChild(element);
            element.innerHTML = "N";
            cellNum.style.width = "1%";
            
            for (var p in columnNames) {
                if (p == "id") {
                } else {
                    var cell = row.insertCell(j);
                    j++;
                    var element = document.createElement("div");
                    cell.appendChild(element);
                    element.innerHTML = UTIL.escapeHTML(p);
                }
                if (p == "ename" || p == "ememo" || p == "id" || p == "edate" || p == "etag") {} else {
                    cell.style.width = "1%";
                }
            }
            row = table.insertRow(trow++);
        }
        row.classList.add("rowbgl");
        
        var j = 0;
        
        var cellNum = row.insertCell(j);
        j++;
        var element = document.createElement("div");
        cellNum.appendChild(element);
        element.innerHTML = "" + (offset+i+1);
        cellNum.style.width = "1%";
        
        var rowIt = rowItem(results_rows,i);
        for (var p in columnNames) {
            if (p == "id") {
                var obj = {};
                obj.id = rowIt.id;
                cellNum.setAttribute("onclick", "editEvent("+JSON.stringify(obj)+")");
            } else {
                var cell = row.insertCell(j);
                j++;
                var element = document.createElement("div");
                var cellVal = rowIt[p];
                if (p == "ememo") {
                    if (showAsHTML) {
                        element = document.createElement("iframe");
                        element.srcdoc = cellVal;
                        element.setAttribute("onload", "setFrameSize(this)");
                    } else {
                        cellVal = cellVal.substr(0, Math.min(cellVal.length, 20));
                        element.innerHTML = UTIL.escapeHTML(cellVal);
                    }
                } else if (p == "etag") {
                    var chbox  = document.createElement("input");
                    chbox.type = "checkbox";
                    var cellValInt = parseInt(cellVal);
                    if (isNaN(cellValInt)) {} else {
                        if (cellValInt == -1) {
                            chbox.checked = true;
                        }
                    }
                    var elementLabel = document.createTextNode(UTIL.escapeHTML(cellVal));
                    element.appendChild(chbox);
                    element.appendChild(elementLabel);
                } else {
                    element.innerHTML = UTIL.escapeHTML(cellVal);
                }
                cell.appendChild(element);
            }
            if (p == "ename" || p == "ememo" || p == "id" || p == "edate" || p == "etag") {} else {
                cell.style.width = "1%";
            }
            if (p == "ememo") {
                var obj = {};
                obj.id = rowIt.id;
                cell.setAttribute("onclick", "showHtml("+JSON.stringify(obj)+")");
            }
        }

        //console.log(i, results_rows.item(i));
    }
}
function setFrameSize(frame) {
    frame.style.height=frame.contentDocument.body.scrollHeight +'px';
    frame.style.border = "0px";
    frame.contentDocument.body.style.padding = "0px";
    frame.contentDocument.body.style.margin = "0px";

}

function rowItem (results_rows, i) {
    if ( "item" in results_rows ) {
        return results_rows.item(i);
    } else {
        return results_rows[i];
    }
}

function processById(db, id, callback) {
    //ename, ememo, id, elen, edate
    var sql = "SELECT * FROM events WHERE id = ?";
    if (callback) db.transaction(function (tx) {
        tx.executeSql(sql, [id], 
            function (tx, results) {
                var len = results.rows.length;
                var obj = { id: "", ename: "", ememo: "", elen: "", edate: "", etag: ""};
                if (len > 0) {
                    var rowIt = rowItem(results.rows,0);
                    obj.id = rowIt.id;
                    obj.ename = rowIt.ename;
                    obj.ememo = rowIt.ememo;
                    obj.elen = rowIt.elen;
                    obj.edate = rowIt.edate;
                    obj.etag = rowIt.etag;
                }
                callback(obj);
            },
            function(err) { 
                //console.log(err);
                showStatus("Error");
            }
        );    
    });
}

var LAST_OFFSET = 0;
function showEvents(db, isCount, callback) {
    db.transaction(function (tx) {
        //date(l/1000,'unixepoch','localtime') //sqlite ms to date
        var date = new Date().toISOString().substr(0, 10); //TODO UTC

        var limit = parseInt(document.getElementById('elimit').value), 
            offset = parseInt(document.getElementById('eoffset').value),
            fename = document.getElementById('fename').value,
            fetag = document.getElementById('fetag').value,
            date1 = new Date(document.getElementById('fromdate').value).toISOString().substr(0, 10),
            date2 = new Date(document.getElementById('todate').value).toISOString().substr(0, 10);
        if (isNaN(limit) || limit <= 0) {
            limit = 1;
        }
        if (isNaN(offset) || offset < 0) {
            offset = 0;
        }
        //date(l/1000,'unixepoch','localtime')
        //dlen is wrong if from date more then prev event date
        var sqlparam = [date, date, date1, date, date2, date, date1, date2,
            date1, date2, date1, date2, limit, offset];
        var sqlparamCount = [date, date, date1, date, date2, date, date1, date2,
            date1, date2, date1, date2];
        var sqlBasic = 
"WITH jt1 AS " + "\n" +
"(SELECT etag, ename, ememo, id, elen, l AS pdate, r AS edate, CAST ((julianday(r)-julianday(l)) AS INTEGER) AS dlen FROM ( " + "\n" +
" SELECT etag, ename, ememo, id, elen, l, min(r) AS r FROM ( " + "\n" +
//FAKE
" SELECT '' AS etag, ename, edate AS l, ? AS r , 'FAKE' AS ememo, '' as id, '' AS elen FROM events " +  "\n" +
" WHERE " +  "\n" +
" ? >= ? AND ? <= ? AND edate < ? AND edate >= ? AND edate <= ? "+  "\n" +
" UNION ALL " +  "\n" + //FAKE
" SELECT t2.etag, t1.ename, t1.edate AS l, t2.edate AS r, t2.ememo, t2.id, t2.elen "+ "\n" +
"  FROM events t1 "+ "\n" +
"  JOIN events t2 "+ "\n" +
"    ON (t1.ename = t2.ename) "+ "\n" +
" WHERE t1.edate < t2.edate AND t1.edate >= ? AND t2.edate <= ? "+ "\n" +
" ) GROUP BY ename, l "+ "\n" +
" )) " + "\n" +
" SELECT * FROM jt1 " + "\n" +
" UNION ALL " + "\n" +
" SELECT etag, ename, ememo, id, elen, '' AS pdate, edate, 0 AS dlen FROM events " + "\n" +
" WHERE id NOT IN (SELECT id FROM jt1) AND edate BETWEEN ? AND ? " + "\n" +
" ORDER BY edate DESC, ename ASC "+  "\n";
        if (fename || fetag) {
            var fetagSql = "", fenameSql = "", fetagSql1 = "", fenameSql1 = "";
            if (fename && fetag) {
                fenameSql = " ename LIKE ? ";
                fenameSql1 = " t1.ename LIKE ? ";
                fetagSql = " AND etag == ? ";
                fetagSql1 = " AND t1.etag == ? ";
                sqlparam = [date, fename, fetag, date, date1, date, date2, date, date1, date2,
                    fename, fetag, date1, date2, date1, date2, fename, fetag, limit, offset];
                sqlparamCount = [date, fename, fetag, date, date1, date, date2, date, date1, date2,
                    fename, fetag, date1, date2, date1, date2, fename, fetag];
            } else if (fename) {
                fenameSql = " ename LIKE ? ";
                fenameSql1 = " t1.ename LIKE ? ";
                sqlparam = [date, fename, date, date1, date, date2, date, date1, date2,
                    fename, date1, date2, date1, date2, fename, limit, offset];
                sqlparamCount = [date, fename, date, date1, date, date2, date, date1, date2,
                    fename, date1, date2, date1, date2, fename];
            } else {
                fetagSql = " etag == ? ";
                fetagSql1 = " t1.etag == ? ";
                sqlparam = [date, fetag, date, date1, date, date2, date, date1, date2,
                    fetag, date1, date2, date1, date2, fetag, limit, offset];
                sqlparamCount = [date, fetag, date, date1, date, date2, date, date1, date2,
                    fetag, date1, date2, date1, date2, fetag];
            }
sqlBasic = 
"WITH jt1 AS " + "\n" +
"(SELECT etag, ename, ememo, id, elen, l AS pdate, r AS edate, CAST ((julianday(r)-julianday(l)) AS INTEGER) AS dlen FROM ( " + "\n" +
" SELECT etag, ename, ememo, id, elen, l, min(r) AS r FROM ( " +  "\n" +
//FAKE
" SELECT '' AS etag, ename, edate AS l, ? AS r , 'FAKE' AS ememo, '' as id, '' AS elen FROM events " +  "\n" +
" WHERE " + fenameSql + fetagSql + "\n" +
" AND " +  "\n" +
" ? >= ? AND ? <= ? AND edate < ? AND edate >= ? AND edate <= ? "+  "\n" +
" UNION ALL " +  "\n" +//FAKE
" SELECT t2.etag, t1.ename, t1.edate AS l, t2.edate AS r, t2.ememo, t2.id, t2.elen "+ "\n" +
"  FROM events t1 "+ "\n" +
"  JOIN events t2 "+ "\n" +
"    ON (t1.ename = t2.ename) AND "+ fenameSql1 + fetagSql1 + "\n" +
" WHERE t1.edate < t2.edate AND t1.edate >= ? AND t2.edate <= ? "+ "\n" +
" ) GROUP BY ename, l "+ "\n" +
" )) " + "\n" +
" SELECT * FROM jt1 " + "\n" +
" UNION ALL " + "\n" +
" SELECT etag, ename, ememo, id, elen, '' AS pdate, edate, 0 AS dlen FROM events " + "\n" +
" WHERE id NOT IN (SELECT id FROM jt1) AND edate BETWEEN ? AND ? AND " + fenameSql + fetagSql + "\n" +
" ORDER BY edate DESC, ename ASC "+  "\n";
        }
        var sql = sqlBasic + " LIMIT ? OFFSET ? ";
        var sqlCount = "SELECT count(*) AS cnt FROM (" + sqlBasic + ")";

        if (isCount) {
            tx.executeSql(sqlCount, sqlparamCount, 
                function (tx, results) {
                    var rowIt = rowItem(results.rows,0);
                    var cnt = parseInt(rowIt["cnt"]);
                    if (isNaN(cnt)) {
                        cnt = 0;
                    }
                    LAST_OFFSET = cnt;
                    LAST_OFFSET = Math.floor(LAST_OFFSET / limit) * limit;
                    if (LAST_OFFSET == cnt && LAST_OFFSET > 0) {
                        LAST_OFFSET = LAST_OFFSET - limit;
                    }
                    document.getElementById("countDiv").innerHTML = rowIt["cnt"];
                },
                function(err) { 
                    //console.log(err);
                    showStatus("Error",sqlCount);
                }
            );
        }
        
        if (!isCount || isCount && isCount == 2) {
            tx.executeSql(sql, sqlparam, 
                function (tx, results) {
                    if (callback) {
                        callback(results.rows);
                    } else {
                        fillTable(results.rows)
                    }
                },
                function(err) { 
                    //console.log(err);
                    showStatus("Error", sql);
                }
            );
        }
    });
}    
function getPrefix(db) {
    db.transaction(function (tx) {
        tx.executeSql('SELECT name FROM idprefix WHERE id = 1', [], 
            function (tx, results) {
                var len = results.rows.length;
                if (len > 0) {
                    for (var i = 0; i < len; i++) {
                        __idprefix = results.rows.item(i)["name"];
                    }
                } else {
                    
                    while (__idprefix == null || __idprefix == "") {
                        __idprefix = prompt("Please enter device id", UTIL.generateGuid());
                    }
                    
                    tx.executeSql('INSERT INTO idprefix (id, name) VALUES (?,?)', [1, __idprefix], 
                        function(transaction, results){ 
                            //showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
                            console.log(results); 
                        }, 
                        function(err) { 
                            //showStatus("Error");
                            console.log(err);
                        }
                    );                
                }
                document.getElementById('eidprefix').value = __idprefix;
            },
            function(err) { 
                console.log(err);
            }
        );
    });
}    
showEvents(db, 2);
</script>
</body>
</html>