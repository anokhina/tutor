<!DOCTYPE html>
<!--
Copyright 2017 Veronica Anokhina.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style type="text/css">
html, body {
    /*height:99%;*/
    width:99%;
}   
.inline {
    display: inline-block;
    padding-top: 2px;
}  
  </style>

<body>

<script>
function toObject(arr) {
    var ret = {};
    for (var i = 0; i < arr.length; ++i) {
        ret[i] = arr[i];
    }
    ret.length = arr.length;
    return ret;
}
var __escape = document.createElement('textarea');
function escapeHTML(html) {
    __escape.textContent = html;
    return __escape.innerHTML;
}

function unescapeHTML(html) {
    __escape.innerHTML = html;
    return __escape.textContent;
}
function generateGuid() {
    return Math.random().toString(36).substring(2, 15) +
        Math.random().toString(36).substring(2, 15);
}    
function dropTables(db, names) {
    db.transaction(
        function(transaction) {
            names.forEach(function(name) {
                transaction.executeSql(
                    'DROP TABLE IF EXISTS ' + name
                );
            });
        }
    );
}
function dropViews(db, names) {
    db.transaction(
        function(transaction) {
            names.forEach(function(name) {
                transaction.executeSql(
                    'DROP VIEW IF EXISTS ' + name
                );
            });
        }
    );
}

function isFunction(v) {
    return (v && typeof v === "function");
}
function newEvent() {
    document.getElementById('eid').value = "";
    document.getElementById('ename').value = "";
    document.getElementById('ememo').value = "";
    document.getElementById('elen').value = 1;
    document.getElementById('edate').value = document.getElementById('edate').value = new Date().toISOString().substr(0, 10);
}
function addEvent() {
    var ename = document.getElementById('ename').value, 
        ememo = document.getElementById('ememo').value, 
        elen = document.getElementById('elen').value, 
        edate = document.getElementById('edate').value;//TODO check
    if (edate) {
        edate = new Date(edate).toISOString().substr(0, 10);
    }
    addEventDB(db, edate, ename, ememo, elen);
    showEvents(db);
}
function saveEvent() {
    var eid = document.getElementById('eid').value, 
        ename = document.getElementById('ename').value, 
        ememo = document.getElementById('ememo').value, 
        elen = document.getElementById('elen').value, 
        edate = document.getElementById('edate').value;//TODO check
    if (edate) {
        edate = new Date(edate).toISOString().substr(0, 10);
    }
    
    if (eid && confirm("Save changes for [" + eid + "] " + ename) == true) {
        saveEventDB(db, eid, edate, ename, ememo, elen);
        showEvents(db);
    }    
}
function delEvent() {
    var eid = document.getElementById('eid').value, 
        ename = document.getElementById('ename').value, 
        ememo = document.getElementById('ememo').value, 
        elen = document.getElementById('elen').value, 
        edate = document.getElementById('edate').value;//TODO check
    if (edate) {
        edate = new Date(edate).toISOString().substr(0, 10);
    }
    
    if (confirm("Delete [" + eid + "] " + ename) == true) {
        deleteEventDB(db, eid);
        showEvents(db);
    }    
}
function editEvent(obj) {
    //TODO check form changes
    var eid = document.getElementById('eid').value, 
        ename = document.getElementById('ename').value;

    if (eid || ename) {
        if (confirm("Discard unsaved changes for [" + eid + "] " + ename) == false) {
            return;
        }
    }
    
    //ename, ememo, id, elen, pdate, edate, dlen
    document.getElementById('eid').value = obj["id"];
    document.getElementById('ename').value = obj["ename"];
    document.getElementById('ememo').value = obj["ememo"];
    document.getElementById('elen').value = obj["elen"];
    document.getElementById('edate').value = document.getElementById('edate').value = new Date(obj["edate"]).toISOString().substr(0, 10);
}
function showStatus(o) {
    document.getElementById('opstatus').innerHTML = new Date().toISOString() + ": " + escapeHTML(o);
}
function searchFormReset() {
    document.getElementById("searchForm").reset();
    var zeroDate = new Date();
    zeroDate.setTime(0);
    var futureDate = new Date();
    futureDate.setFullYear(futureDate.getFullYear()+100);
    document.getElementById('fromdate').value = zeroDate.toISOString().substr(0, 10);
    document.getElementById('todate').value = futureDate.toISOString().substr(0, 10);
}
function saveObj2FS(obj, filePrefix) {
    console.log(obj, JSON.stringify( obj, null, 2 ));
    var text = JSON.stringify( obj, null, 2 );
    var obj1 = JSON.parse(text);
    obj1.length = obj.length;
    text = JSON.stringify( obj1, null, 2 );
    
    var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    var todayDate = new Date().toISOString().replace(/[T\.Z]/g, "_");
    var filenameUname = "-" + "events" + "-";
    if (filePrefix) {
    } else {
        filePrefix = "exportData";
    }
    saveAs(blob, filePrefix+filenameUname+todayDate+".json");
}
function exportData() {
    showEvents(db, saveObj2FS );
}
function importData(obj) {
    console.log(obj);
    //fillTable(obj);
    if (confirm("Will import data from file? All data to be overwritten") == true) {
        importTable(obj, 0, []);
    }
}
function saveAs(data, filename) {
    var blob = new Blob([data], {type: "text/plain;charset=utf-8"});
    if (window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveBlob(blob, filename);
    } else {
        var elem = window.document.createElement('a');
        elem.href = window.URL.createObjectURL(blob);
        elem.download = filename;        
        document.body.appendChild(elem);
        elem.click();        
        document.body.removeChild(elem);
    }
}
function handleFileSelect(evt) {
    if (window.File && window.FileReader && window.FileList && window.Blob) {

    } else {
        alert('The File APIs are not fully supported in this browser.');
        return;
    }

    var files = evt.target.files;

    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
        var reader = new FileReader();
        reader.readAsText (f);
        reader.onload = function(e) {
            var text = reader.result;
            try {
                var cfg = JSON.parse(text);
                importData(cfg);
            } catch (e) {
                console.log("parse json error", e);
                showStatus("parse json error");
            }
        };
    }
}
</script>

<div id="controls">
<form id="editForm">
<table border=0 style="width:100%"><tr>
<td>&nbsp;<div id="opstatus" class="inline">Ok</div>
</td></tr><tr><td>
<input type="text" readonly="true" id="eidprefix" name="eidprefix"/>
</td></tr><tr><td>
<input type="text" readonly="true" id="eid" name="eid"/>
<div class="inline">Date: <input type="date" id="edate" name="edate" /></div>
<div class="inline">Length: <input type="text" id="elen" name="elen" value="1" type="number" size="4" min="0" maxlength="3" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
<div>Name:</div><input type="text" id="ename" name="ename" style="width:99%"/>
</td></tr><tr><td><div class="inline-no">Memo: <textarea rows="5" type="text" id="ememo" name="ememo" style="width:99%" ></textarea></div>
</td></tr><tr><td>
<input type="button" onclick="delEvent()" value="Del"/>
<input type="button" onclick="newEvent()" value="New"/>
<input type="button" onclick="addEvent()" value="Add"/>
<input type="button" onclick="saveEvent()" value="Save"/>
</td></tr>
</table>
</form>

<form id="exportForm">
<table border=1 style="width:100%"><tr>
<td>
<input type="button" onclick="exportData()" value="Export"/>
Import: <input type="file" id="files" name="files[]" />
<button type="reset" value="Reset">Reset</button>
</td>
</tr>
</table>
</form>

<form id="searchForm" onsubmit="showEvents(db); return false;">
<table border=0 style="width:100%"><tr>
<td>
<input type="submit" value="Log">
<input type="button" onclick="searchFormReset()" value="Reset"/>
</td></tr><tr><td>
<div class="inline">From date: <input type="date" id="fromdate" name="fromdate" /></div>
<div class="inline">To date: <input type="date" id="todate" name="todate" /></div>
<div>Name:</div><input type="text" id="fename" name="fename" style="width:99%"/>
</td></tr><tr><td>
<div class="inline">Limit: <input type="text" id="elimit" name="elimit" value="30" size="4" min="5" maxlength="3" onchange="document.getElementById('eoffset').step=this.value;" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
<div class="inline">Offset: <input id="eoffset" name="eoffset" value="0" step="30" type="number" min="0" maxlength="40" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
</td></tr>
</table>
</form>
</div>

<table id="eventListTable" border="1" width="99%" style="margin-top: .5em;" >
</table>

<script>
newEvent();
searchFormReset();
document.getElementById('files').addEventListener('change', handleFileSelect, false);

    var __idprefix = null;
    var db = openDatabase('sevnEvents', '1.0', 'Events db', 20 * 1024 * 1024);
//dropTables(db, ["events", "idprefix"]);
//dropViews(db, ["v_events"]);    
    db.transaction(
    //SELECT ROWID, * FROM events ORDER BY edate DESC, ename ASC
        function(transaction) {
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS events ' +
                '  (id TEXT NOT NULL PRIMARY KEY, ' +
                '   edate DATE NOT NULL,'  +
                '   elen INTEGER NOT NULL,'  +
                '   ename TEXT NOT NULL,' +
                '   ememo TEXT);'
            );
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS idprefix ' +
                '  (id INTEGER NOT NULL PRIMARY KEY, ' +
                '   name TEXT);'
            );
        }
    );
    getPrefix(db);
    
function addEventDB(db, edate, ename, ememo, elen) {
    var id = __idprefix + "-" + generateGuid();
    db.transaction(function (tx) {
        tx.executeSql('INSERT INTO events (id, edate, ename, ememo, elen) VALUES (?,?,?,?,?)', [id, edate, ename, ememo, elen], 
            function(transaction, results){ 
                showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
                //console.log(results); 
            }, 
            function(err) { 
                showStatus("Error");
                //console.log(err);
            }
        );
    });
}
function replaceEventDB(db, id, edate, ename, ememo, elen, errLines, callback) {
    db.transaction(function (tx) {
        tx.executeSql('INSERT INTO events (id, edate, ename, ememo, elen) VALUES (?,?,?,?,?)', [id, edate, ename, ememo, elen], 
            function(transaction, results){ 
                showStatus("Inserted or updated: " + results.rowsAffected + " rows,  id=" + results.insertId);
                //console.log(results); 
                if (callback) callback();
            }, 
            function(err) { 
                showStatus("Error");
                console.log(err);
                saveEventDB(db, id, edate, ename, ememo, elen, errLines, callback);
            }
        );
    });
}
function saveEventDB(db, id, edate, ename, ememo, elen, errLines, callback) {
     db.transaction(function (tx) {
        tx.executeSql('UPDATE events SET edate = ?, ename = ?, ememo = ?, elen = ? WHERE id = ? ', [ edate, ename, ememo, elen, id], 
            function(transaction, results){ 
                showStatus("Updated: " + results.rowsAffected);
                //console.log(results); 
                if (callback) callback();
            }, 
            function(err) { 
                showStatus("Error");
                if (errLines) {
                    errLines.push({id: id, edate: edate, ename: ename, ememo: ememo, elen: elen, errLines: errLines});
                }
                //console.log(err);
                if (callback) callback();
            }
        );
     });
}    
function deleteEventDB(db, id) {
     db.transaction(function (tx) {
        tx.executeSql('DELETE FROM events WHERE id = ? ', [id], 
            function(transaction, results){ 
                showStatus("Deleted: " + results.rowsAffected);
                //console.log(results); 
            }, 
            function(err) { 
                showStatus("Error");
                //console.log(err);
            }
        );
     });
}

function importTable(results_rows, i, errLines) {
    //ename, ememo, id, elen, pdate, edate, dlen
    if (i < results_rows.length) {
        var rowIt = rowItem(results_rows,i);
        replaceEventDB(db, rowIt["id"], rowIt["edate"], rowIt["ename"], rowIt["ememo"], rowIt["elen"], errLines, function() {
            importTable(results_rows, i+1, errLines)
        });
    } else {
        if (errLines && errLines.length > 0) {
            saveObj2FS(toObject(errLines), "importError");
        }
    }
}
function fillTable(results_rows) {
    var len = results_rows.length;
                
    var table = document.getElementById("eventListTable");
    while(table.rows.length > 0) {
        table.deleteRow(0);
    }

    //ename, ememo, id, elen, pdate, edate, dlen
    var columnNames = {id: "", edate: "", dlen: "", ename: "", elen: "", ememo: ""};
    var trow = 0;
    var row;
    for (var i = 0; i < len; i++) {
        row = table.insertRow(trow++);
        if (i == 0) {
            var j = 0;
            for (var p in columnNames) {
                var cell = row.insertCell(j);
                j++;
                var element = document.createElement("div");
                //element.setAttribute("id", wid);
                cell.appendChild(element);
                //TODO escape
                element.innerHTML = escapeHTML(p);
            }
            row = table.insertRow(trow++);
        }
        var j = 0;
        for (var p in columnNames) {
            var cell = row.insertCell(j);
            j++;
            var element = document.createElement("div");
            //element.setAttribute("id", wid);
            cell.appendChild(element);
            //TODO escape
            var rowIt = rowItem(results_rows,i);
            element.innerHTML = escapeHTML(rowIt[p]);
            if (p == "id") {
                cell.setAttribute("onclick", "editEvent("+JSON.stringify(rowIt)+")");
            }
        }

        //console.log(i, results_rows.item(i));
    }
}

function rowItem (results_rows, i) {
    if ( "item" in results_rows ) {
        return results_rows.item(i);
    } else {
        return results_rows[i];
    }
}

function showEvents(db, callback) {
    db.transaction(function (tx) {
        //date(l/1000,'unixepoch','localtime') //sqlite ms to date
        var limit = document.getElementById('elimit').value, 
            offset = document.getElementById('eoffset').value,
            fename = document.getElementById('fename').value,
            date1 = new Date(document.getElementById('fromdate').value).toISOString().substr(0, 10),
            date2 = new Date(document.getElementById('todate').value).toISOString().substr(0, 10);
        //date(l/1000,'unixepoch','localtime')
        //dlen is wrong if from date more then prev event date
        var sqlparam = [date1, date2, date1, date2, limit, offset];
        var sql = 
"WITH jt1 AS " +
"(SELECT ename, ememo, id, elen, l AS pdate, r AS edate, CAST ((julianday(r)-julianday(l)) AS INTEGER) AS dlen FROM ( " +
" SELECT ename, ememo, id, elen, l, min(r) AS r FROM ( " +
" SELECT t1.ename, t1.edate AS l, t2.edate AS r, t2.ememo, t2.id, t2.elen "+
"  FROM events t1 "+
"  JOIN events t2 "+
"    ON (t1.ename = t2.ename) "+
" WHERE t1.edate < t2.edate AND t1.edate >= ? AND t2.edate <= ? "+
" ) GROUP BY ename, l "+
" )) " +
" SELECT * FROM jt1 " +
" UNION ALL " +
" SELECT ename, ememo, id, elen, '' AS pdate, edate, 0 AS dlen FROM events " +
" WHERE id NOT IN (SELECT id FROM jt1) AND edate BETWEEN ? AND ? " +
" ORDER BY edate DESC, ename ASC " +
" LIMIT ? OFFSET ? " +
";";
        if (fename) {
            sqlparam = [fename, date1, date2, date1, date2, fename, limit, offset];
sql = 
"WITH jt1 AS " +
"(SELECT ename, ememo, id, elen, l AS pdate, r AS edate, CAST ((julianday(r)-julianday(l)) AS INTEGER) AS dlen FROM ( " +
" SELECT ename, ememo, id, elen, l, min(r) AS r FROM ( " +
" SELECT t1.ename, t1.edate AS l, t2.edate AS r, t2.ememo, t2.id, t2.elen "+
"  FROM events t1 "+
"  JOIN events t2 "+
"    ON (t1.ename = t2.ename) AND t1.ename LIKE ? "+
" WHERE t1.edate < t2.edate AND t1.edate >= ? AND t2.edate <= ? "+
" ) GROUP BY ename, l "+
" )) " +
" SELECT * FROM jt1 " +
" UNION ALL " +
" SELECT ename, ememo, id, elen, '' AS pdate, edate, 0 AS dlen FROM events " +
" WHERE id NOT IN (SELECT id FROM jt1) AND edate BETWEEN ? AND ? AND ename LIKE ? " +
" ORDER BY edate DESC, ename ASC " +
" LIMIT ? OFFSET ? " +
";";        
        }
        tx.executeSql(sql, sqlparam, 
            function (tx, results) {
                if (callback) {
                    callback(results.rows);
                } else {
                    fillTable(results.rows)
                }
            },
            function(err) { 
                //console.log(err);
                showStatus("Error");
            }
        );
    });
}    
function showTable(db, table) {
    db.transaction(function (tx) {
        tx.executeSql('SELECT ROWID, * FROM ' + table, [], 
            function (tx, results) {
                var len = results.rows.length;
                var msg = "<p>Found rows: " + len + "</p>";
                console.log(msg);
        
                for (var i = 0; i < len; i++) {
                    console.log(i, results.rows.item(i));
                }
            },
            function(err) { 
                console.log(err);
            }
        );
    });
}    
function getPrefix(db) {
    db.transaction(function (tx) {
        tx.executeSql('SELECT name FROM idprefix WHERE id = 1', [], 
            function (tx, results) {
                var len = results.rows.length;
                if (len > 0) {
                    for (var i = 0; i < len; i++) {
                        __idprefix = results.rows.item(i)["name"];
                    }
                } else {
                    
                    while (__idprefix == null || __idprefix == "") {
                        __idprefix = prompt("Please enter device id", generateGuid());
                    }
                    
                    tx.executeSql('INSERT INTO idprefix (id, name) VALUES (?,?)', [1, __idprefix], 
                        function(transaction, results){ 
                            //showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
                            console.log(results); 
                        }, 
                        function(err) { 
                            //showStatus("Error");
                            console.log(err);
                        }
                    );                
                }
                document.getElementById('eidprefix').value = __idprefix;
            },
            function(err) { 
                console.log(err);
            }
        );
    });
}    
</script>
</body>
</html>