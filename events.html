<!DOCTYPE html>
<!--
Copyright 2017 Veronica Anokhina.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style type="text/css">
html, body {
    /*height:99%;*/
    width:100%;
    padding:0px;
    margin:0px;
}   
.inline {
    display: inline-block;
    padding-top: 2px;
}  
textarea { 
    resize:vertical; 
    padding: 0px;
    margin: 0px;    
}

/* Style the tab */
div.tab {
    overflow: hidden;
    border: 1px solid #ccc;
    background-color: #e5e5e5;
}

/* Style the buttons inside the tab */
div.tab button {
    background-color: inherit;
    float: left;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 4px 6px;
    transition: 0.3s;
    font-size: large;
}

/* Change background color of buttons on hover */
div.tab button:hover {
    background-color: #ddd;
}

/* Create an active/current tablink class */
div.tab button.active {
    background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
    display: none;
    padding: 0px;
    border: 1px solid #ccc;
    border-top: none;
    background-color: #f1f1f1;
}

.tcontent {
    padding: 5px;
}

/* Style the close button */
.topright {
    float: right;
    cursor: pointer;
    font-size: large;
    padding: 0px 4px 0px 0px;
}

.topright:hover {color: red;}

#opstatus {
    background-color: #bbb;
}
.controldiv {
    position: fixed;
    width: 100%;
    top: 0;
    z-index: 200;
}
.controlleddiv {
    position: relative;
    top: 50px;
}
.rowbg {
    background-color: #ccc;
}
.rowbgm {
    background-color: #ddd;
}
.rowbgl {
    background-color: #f1f1f1;
}
.Reset {
    margin-top: 5px;
    margin-bottom: 5px;
}
  </style>

<body>

<script type="text/javascript" src="jslib/UTIL.js"></script>
<script type="text/javascript" src="jslib/UTILDB.js"></script>
<script type="text/javascript" src="jslib/UTILIO.js"></script>

<script>

function newEvent() {
    document.getElementById('eid').value = "";
    document.getElementById('ename').value = "";
    document.getElementById('ememo').value = "";
    document.getElementById('elen').value = 1;
    document.getElementById('edate').value = document.getElementById('edate').value = new Date().toISOString().substr(0, 10);
}
function addEvent() {
    var ename = document.getElementById('ename').value, 
        ememo = document.getElementById('ememo').value, 
        elen = document.getElementById('elen').value, 
        edate = document.getElementById('edate').value;//TODO check
    if (edate) {
        edate = new Date(edate).toISOString().substr(0, 10);
    }
    addEventDB(db, edate, ename, ememo, elen);
    showEvents(db);
}
function saveEvent() {
    var eid = document.getElementById('eid').value, 
        ename = document.getElementById('ename').value, 
        ememo = document.getElementById('ememo').value, 
        elen = document.getElementById('elen').value, 
        edate = document.getElementById('edate').value;//TODO check
    if (edate) {
        edate = new Date(edate).toISOString().substr(0, 10);
    }
    
    if (eid && confirm("Save changes for [" + eid + "] " + ename) == true) {
        saveEventDB(db, eid, edate, ename, ememo, elen);
        showEvents(db);
    }    
}
function delEvent() {
    var eid = document.getElementById('eid').value, 
        ename = document.getElementById('ename').value, 
        ememo = document.getElementById('ememo').value, 
        elen = document.getElementById('elen').value, 
        edate = document.getElementById('edate').value;//TODO check
    if (edate) {
        edate = new Date(edate).toISOString().substr(0, 10);
    }
    
    if (confirm("Delete [" + eid + "] " + ename) == true) {
        deleteEventDB(db, eid);
        showEvents(db);
    }    
}
function editEvent(obj) {
    //TODO check form changes
    var eid = document.getElementById('eid').value, 
        ename = document.getElementById('ename').value;

    if (eid || ename) {
        if (confirm("Discard unsaved changes for [" + eid + "] " + ename) == false) {
            return;
        }
    }
    
    //ename, ememo, id, elen, pdate, edate, dlen
    document.getElementById('eid').value = obj["id"];
    document.getElementById('ename').value = obj["ename"];
    document.getElementById('ememo').value = obj["ememo"];
    document.getElementById('elen').value = obj["elen"];
    document.getElementById('edate').value = document.getElementById('edate').value = new Date(obj["edate"]).toISOString().substr(0, 10);
    openTab({ currentTarget: document.getElementById("buttonEdit") }, "Edit");

}
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    if (evt) {
        evt.currentTarget.className += " active";
    }
    window.scrollTo(0, 0);
}
function showStatus(m, o, exc) {
    var now = new Date().toISOString().slice(0,19).replace("T", " ");
    if (!o) {
        o = m;
    }
    var msg = now + ": " + UTIL.escapeHTML(o);
    var msgSh = now + ": " + UTIL.escapeHTML(m);
    var statDiv = document.getElementById('opstatus');
    if (statDiv) {
        statDiv.innerHTML = msgSh;
    }
    var errDiv = document.getElementById('errorDiv');
    if (errDiv) {
        errDiv.innerHTML = msg + "<p>" + errDiv.innerHTML;
    }
    if (exc) {
        console.log(exc);
    }
}

function searchFormReset() {
    document.getElementById("searchForm").reset();
    var zeroDate = new Date();
    zeroDate.setTime(0);
    var futureDate = new Date();
    futureDate.setFullYear(futureDate.getFullYear()+100);
    document.getElementById('fromdate').value = zeroDate.toISOString().substr(0, 10);
    document.getElementById('todate').value = futureDate.toISOString().substr(0, 10);
}
function saveObj2FS(obj, filePrefix) {
    var filenameUname = "-" + "events" + "-";
    if (filePrefix === undefined ) {
        filePrefix = "exportData";
    }
    UTILIO.saveAs(UTILIO.text2blob(UTIL.objDB2text(obj)), filePrefix+filenameUname+UTIL.date2text(new Date())+".json");
}
function exportData() {
    showEvents(db, saveObj2FS );
}
function importData(obj) {
    console.log(obj);
    //fillTable(obj);
    if (confirm("Will import data from file? All data to be overwritten") == true) {
        importTable(obj, 0, []);
    }
}
</script>

<div class="controldiv">

    <div id="opstatus">Ok</div>

    <div class="tab">
      <button class="tablinks" onclick="openTab(event, 'Find')" id="defaultOpen">Find</button>
      <button class="tablinks" onclick="openTab(event, 'Edit')" id="buttonEdit">Edit</button>
      <button class="tablinks" onclick="openTab(event, 'Import')">Import</button>
      <button class="tablinks" onclick="openTab(event, 'Errors')">Errors</button>
    </div>
</div>


<div class="controlleddiv">

    <div id="Edit" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <form id="editForm">
            <table border=0 style="width:100%">
            <tr><td>
            <input type="text" readonly="true" id="eidprefix" name="eidprefix"/>
            </td></tr><tr><td>
            <input type="text" readonly="true" id="eid" name="eid"/>
            <div class="inline">Date: <input type="date" id="edate" name="edate" /></div>
            <div class="inline">Length: <input type="text" id="elen" name="elen" value="1" type="number" size="4" min="0" maxlength="3" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
            <div>Name:</div><input type="text" id="ename" name="ename" style="width:100%"/>
            </td></tr><tr><td><div class="inline-no">Memo: <textarea rows="5" type="text" id="ememo" name="ememo" style="width:100%" ></textarea></div>
            </td></tr><tr><td>
            <input type="button" onclick="delEvent()" value="Del"/>
            <input type="button" onclick="newEvent()" value="New"/>
            <input type="button" onclick="addEvent()" value="Add"/>
            <input type="button" onclick="saveEvent()" value="Save"/>
            </td></tr>
            </table>
            </form>
        </div>
    </div>

    <div id="Import" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <input type="button" onclick="exportData()" value="Export"/>
            <form id="exportForm">
            <table style="width:100%"><tr>
            <td>
            <button type="reset" value="Reset" class="Reset">Reset</button>
            Import: <input type="file" id="files1" name="files1[]" />
            </td>
            </tr>
            </table>
            </form>
        </div>
    </div>

    <div id="Find" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <form id="searchForm" onsubmit="showEvents(db); return false;">
            <table border=0 style="width:100%"><tr>
            <td>
            <input type="submit" value="Log">
            <input type="button" onclick="searchFormReset()" value="Reset"/>
            </td></tr><tr><td>
            <div class="inline">From date: <input type="date" id="fromdate" name="fromdate" /></div>
            <div class="inline">To date: <input type="date" id="todate" name="todate" /></div>
            <div>Name:</div><input type="text" id="fename" name="fename" style="width:100%" value="test%"/>
            </td></tr><tr><td>
            <div class="inline">Limit: <input type="text" id="elimit" name="elimit" value="30" size="4" min="5" maxlength="3" onchange="document.getElementById('eoffset').step=this.value;" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
            <div class="inline">Offset: <input id="eoffset" name="eoffset" value="0" step="30" type="number" min="0" maxlength="40" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
            </td></tr>
            </table>
            </form>
        </div>
    </div>

    <div id="Errors" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <span onclick="document.getElementById('errorDiv').innerHTML='<p>'" class="topright">&empty;&nbsp;</span>
        <div class="tcontent">
        <div id="errorDiv">Ok</div>
        </div>
    </div>
    
<table id="eventListTable" width="100%" style="margin-top: .5em;" >
</table>

</div>

<script>
newEvent();
searchFormReset();
document.getElementById('files1').addEventListener('change', 
    function(evt) {
        new UTILIO.FileOpenerText(function(text){
            try {
                var cfg = JSON.parse(text);
                importData(cfg);
            } catch (e) {
                console.log("parse json error", e);
                showStatus("parse json error");
            }
        }).handleFileSelect(evt);
    }, false);

    var __idprefix = null;
    var db = openDatabase('sevnEvents', '1.0', 'Events db', 20 * 1024 * 1024);
//UTILDB.dropTables(db, ["events", "idprefix"]);
//UTILDB.dropViews(db, ["v_events"]);    
    db.transaction(
    //SELECT ROWID, * FROM events ORDER BY edate DESC, ename ASC
        function(transaction) {
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS events ' +
                '  (id TEXT NOT NULL PRIMARY KEY, ' +
                '   edate DATE NOT NULL,'  +
                '   elen INTEGER NOT NULL,'  +
                '   ename TEXT NOT NULL,' +
                '   ememo TEXT);'
            );
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS idprefix ' +
                '  (id INTEGER NOT NULL PRIMARY KEY, ' +
                '   name TEXT);'
            );
        }
    );
    getPrefix(db);
    
function addEventDB(db, edate, ename, ememo, elen) {
    var id = __idprefix + "-" + UTIL.generateGuid();
    db.transaction(function (tx) {
        tx.executeSql('INSERT INTO events (id, edate, ename, ememo, elen) VALUES (?,?,?,?,?)', [id, edate, ename, ememo, elen], 
            function(transaction, results){ 
                showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
                //console.log(results); 
            }, 
            function(err) { 
                showStatus("Error");
                //console.log(err);
            }
        );
    });
}
function replaceEventDB(db, id, edate, ename, ememo, elen, errLines, callback) {
    db.transaction(function (tx) {
        tx.executeSql('INSERT INTO events (id, edate, ename, ememo, elen) VALUES (?,?,?,?,?)', [id, edate, ename, ememo, elen], 
            function(transaction, results){ 
                showStatus("Inserted or updated: " + results.rowsAffected + " rows,  id=" + results.insertId);
                //console.log(results); 
                if (callback) callback();
            }, 
            function(err) { 
                showStatus("Error");
                console.log(err);
                saveEventDB(db, id, edate, ename, ememo, elen, errLines, callback);
            }
        );
    });
}
function saveEventDB(db, id, edate, ename, ememo, elen, errLines, callback) {
     db.transaction(function (tx) {
        tx.executeSql('UPDATE events SET edate = ?, ename = ?, ememo = ?, elen = ? WHERE id = ? ', [ edate, ename, ememo, elen, id], 
            function(transaction, results){ 
                showStatus("Updated: " + results.rowsAffected);
                //console.log(results); 
                if (callback) callback();
            }, 
            function(err) { 
                showStatus("Error");
                if (errLines) {
                    errLines.push({id: id, edate: edate, ename: ename, ememo: ememo, elen: elen, errLines: errLines});
                }
                //console.log(err);
                if (callback) callback();
            }
        );
     });
}    
function deleteEventDB(db, id) {
     db.transaction(function (tx) {
        tx.executeSql('DELETE FROM events WHERE id = ? ', [id], 
            function(transaction, results){ 
                showStatus("Deleted: " + results.rowsAffected);
                //console.log(results); 
            }, 
            function(err) { 
                showStatus("Error");
                //console.log(err);
            }
        );
     });
}

function importTable(results_rows, i, errLines) {
    //ename, ememo, id, elen, pdate, edate, dlen
    if (i < results_rows.length) {
        var rowIt = rowItem(results_rows,i);
        replaceEventDB(db, rowIt["id"], rowIt["edate"], rowIt["ename"], rowIt["ememo"], rowIt["elen"], errLines, function() {
            importTable(results_rows, i+1, errLines)
        });
    } else {
        if (errLines && errLines.length > 0) {
            saveObj2FS(toObject(errLines), "importError");
        }
    }
}
function fillTable(results_rows) {
    var len = results_rows.length;
                
    var table = document.getElementById("eventListTable");
    while(table.rows.length > 0) {
        table.deleteRow(0);
    }

    //ename, ememo, id, elen, pdate, edate, dlen
    var columnNames = {id: "", edate: "", dlen: "", ename: "", elen: "", ememo: ""};
    var trow = 0;
    var row;
    for (var i = 0; i < len; i++) {
        row = table.insertRow(trow++);
        if (i == 0) {
            row.classList.add("rowbg");

            var j = 0;
            for (var p in columnNames) {
                var cell = row.insertCell(j);
                j++;
                var element = document.createElement("div");
                //element.setAttribute("id", wid);
                cell.appendChild(element);
                //TODO escape
                element.innerHTML = UTIL.escapeHTML(p);
            }
            row = table.insertRow(trow++);
        }
        row.classList.add("rowbgl");
        var j = 0;
        for (var p in columnNames) {
            var cell = row.insertCell(j);
            j++;
            var element = document.createElement("div");
            //element.setAttribute("id", wid);
            cell.appendChild(element);
            //TODO escape
            var rowIt = rowItem(results_rows,i);
            element.innerHTML = UTIL.escapeHTML(rowIt[p]);
            if (p == "id") {
                cell.setAttribute("onclick", "editEvent("+JSON.stringify(rowIt)+")");
            }
        }

        //console.log(i, results_rows.item(i));
    }
}

function rowItem (results_rows, i) {
    if ( "item" in results_rows ) {
        return results_rows.item(i);
    } else {
        return results_rows[i];
    }
}

function showEvents(db, callback) {
    db.transaction(function (tx) {
        //date(l/1000,'unixepoch','localtime') //sqlite ms to date
        var limit = document.getElementById('elimit').value, 
            offset = document.getElementById('eoffset').value,
            fename = document.getElementById('fename').value,
            date1 = new Date(document.getElementById('fromdate').value).toISOString().substr(0, 10),
            date2 = new Date(document.getElementById('todate').value).toISOString().substr(0, 10);
        //date(l/1000,'unixepoch','localtime')
        //dlen is wrong if from date more then prev event date
        var sqlparam = [date1, date2, date1, date2, limit, offset];
        var sql = 
"WITH jt1 AS " +
"(SELECT ename, ememo, id, elen, l AS pdate, r AS edate, CAST ((julianday(r)-julianday(l)) AS INTEGER) AS dlen FROM ( " +
" SELECT ename, ememo, id, elen, l, min(r) AS r FROM ( " +
" SELECT t1.ename, t1.edate AS l, t2.edate AS r, t2.ememo, t2.id, t2.elen "+
"  FROM events t1 "+
"  JOIN events t2 "+
"    ON (t1.ename = t2.ename) "+
" WHERE t1.edate < t2.edate AND t1.edate >= ? AND t2.edate <= ? "+
" ) GROUP BY ename, l "+
" )) " +
" SELECT * FROM jt1 " +
" UNION ALL " +
" SELECT ename, ememo, id, elen, '' AS pdate, edate, 0 AS dlen FROM events " +
" WHERE id NOT IN (SELECT id FROM jt1) AND edate BETWEEN ? AND ? " +
" ORDER BY edate DESC, ename ASC " +
" LIMIT ? OFFSET ? " +
";";
        if (fename) {
            sqlparam = [fename, date1, date2, date1, date2, fename, limit, offset];
sql = 
"WITH jt1 AS " +
"(SELECT ename, ememo, id, elen, l AS pdate, r AS edate, CAST ((julianday(r)-julianday(l)) AS INTEGER) AS dlen FROM ( " +
" SELECT ename, ememo, id, elen, l, min(r) AS r FROM ( " +
" SELECT t1.ename, t1.edate AS l, t2.edate AS r, t2.ememo, t2.id, t2.elen "+
"  FROM events t1 "+
"  JOIN events t2 "+
"    ON (t1.ename = t2.ename) AND t1.ename LIKE ? "+
" WHERE t1.edate < t2.edate AND t1.edate >= ? AND t2.edate <= ? "+
" ) GROUP BY ename, l "+
" )) " +
" SELECT * FROM jt1 " +
" UNION ALL " +
" SELECT ename, ememo, id, elen, '' AS pdate, edate, 0 AS dlen FROM events " +
" WHERE id NOT IN (SELECT id FROM jt1) AND edate BETWEEN ? AND ? AND ename LIKE ? " +
" ORDER BY edate DESC, ename ASC " +
" LIMIT ? OFFSET ? " +
";";        
        }
        tx.executeSql(sql, sqlparam, 
            function (tx, results) {
                if (callback) {
                    callback(results.rows);
                } else {
                    fillTable(results.rows)
                }
            },
            function(err) { 
                //console.log(err);
                showStatus("Error");
            }
        );
    });
}    
function getPrefix(db) {
    db.transaction(function (tx) {
        tx.executeSql('SELECT name FROM idprefix WHERE id = 1', [], 
            function (tx, results) {
                var len = results.rows.length;
                if (len > 0) {
                    for (var i = 0; i < len; i++) {
                        __idprefix = results.rows.item(i)["name"];
                    }
                } else {
                    
                    while (__idprefix == null || __idprefix == "") {
                        __idprefix = prompt("Please enter device id", UTIL.generateGuid());
                    }
                    
                    tx.executeSql('INSERT INTO idprefix (id, name) VALUES (?,?)', [1, __idprefix], 
                        function(transaction, results){ 
                            //showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
                            console.log(results); 
                        }, 
                        function(err) { 
                            //showStatus("Error");
                            console.log(err);
                        }
                    );                
                }
                document.getElementById('eidprefix').value = __idprefix;
            },
            function(err) { 
                console.log(err);
            }
        );
    });
}    
showEvents(db);
</script>
</body>
</html>