<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Покупки</title>

<link type="text/css" rel="stylesheet" href="extlib/jsgrid/jsgrid.min.css" />
<link type="text/css" rel="stylesheet" href="extlib/jsgrid/jsgrid-theme.min.css" />

<script type="text/javascript" src="extlib/jquery-3.3.1.js"></script>

<script type="text/javascript" src="extlib/jsgrid/jsgrid.min.js"></script>
<script type="text/javascript" src="extlib/jsgrid/i18n/jsgrid-ru.js"></script>

<script type="text/javascript" src="jslib/UTIL.js"></script>
<script type="text/javascript" src="jslib/UTILDB.js"></script>
<script type="text/javascript" src="jslib/UTILIO.js"></script>
<script>
//http://js-grid.com/docs/#grid-controller
//http://api.jquery.com/
//https://barcodes.olegon.ru/api/card/name/4607031758328
//resize column
//https://github.com/tabalinas/jsgrid/issues/9

function HTML5DateField(config) {
    jsGrid.TextField.call(this, config);
};

function alterFields(op, field, grid, item, $row, target) {
    grid.fields.forEach(function (f) {
        if ("alterField" in f && f.alterField) {
            f.alterField(op, grid, item, $row, target, field);
        }
    });
}
function validateField(field, grid, item, $row, target) {
    var ret = [];
    if ("validate" in field && field.validate) {
        var args = {
            item: item,
            itemIndex: grid._rowIndex($row),
            row: $row
        };
        var fieldValue = grid._getItemFieldValue(item, field);
        ret = grid._validation.validate($.extend({
            value: fieldValue,
            rules: field.validate
        }, args));
    }
    if (target) {
        var toolTipText = "";
        if (ret.length > 0) {
            toolTipText = ret.join("\n");
            $(target).addClass("error");
        } else {
            $(target).removeClass("error");
        }
        target.title = toolTipText;//TODO show in status
        showStatus(field.name + ":" + toolTipText);
    }
    return ret;
}
jsGrid.TextField.prototype.insertTemplate = function() {
            if(!this.inserting)
                return "";

            var grid = this._grid,
                $result = this.insertControl = this._createTextBox(),
                field = this;

            $result.focusout(function(e) {
                var row = grid._insertRow;
                var item = grid._getInsertItem();
                var isval = validateField(field, grid, item, row, e.target);
                if (isval.length === 0) {
                    alterFields(1,field, grid, item, row, e.target);
                }
            });
            $result.focusin(function(e) {
                var row = grid._insertRow;
                var item = grid._getInsertItem();
                if ("alterField" in field && field.alterField) {
                    field.alterField(1,grid, item, row, e.target);
                }
            });

            return $result;
        };
jsGrid.TextField.prototype.editTemplate = function(value, item) {
            if(!this.editing)
                return this.itemTemplate.apply(this, arguments);

            var grid = this._grid,
                $result = this.editControl = this._createTextBox(),
                field = this;
            $result.val(value);

            $result.focusout(function(e) {
                var row = grid._getEditRow();
                var item = grid._getEditedItem();
                var isval = validateField(field, grid, item, row, e.target);
                if (isval.length === 0) {
                    alterFields(2,field, grid, item, row, e.target);
                }
            });
            $result.focusin(function(e) {
                var row = grid._getEditRow();
                var item = grid._getEditedItem();
                if ("alterField" in field && field.alterField) {
                    field.alterField(2,grid, item, row, e.target);
                }
            });

            return $result;
        };

HTML5DateField.prototype = new jsGrid.TextField({
 
    css: "datetime-field",            // redefine general property 'css'
    align: "center",              // redefine general property 'align'
 
    myCustomProperty: "foo",      // custom property
    readOnly: false,
 
    _createTextBox: function() {
        return $("<input>").attr("type", "datetime-local")
            .prop("readonly", !!this.readOnly);
    },
        
    sorter: function(date1, date2) {
        return new Date(date1) - new Date(date2);
    },
 
/* 
    itemTemplate: function(value, item) {
        //return new Date(value).toISOString();
        return value;
    },
    
    insertTemplate: function(value) {
        this._insertPicker = $("<input>").attr("type", "datetime-local");
        if (this.inserting) {
            return this._insertPicker;
        }
        return this.itemTemplate(value);
    },
 
    editTemplate: function(value) {
        this._editPicker = $("<input>").attr("type", "datetime-local");
        this._editPicker.val(value);
        //this._editPicker.val(UTIL.localDateString(new Date()));
        if (this.editing) {
            return this._editPicker;
        }
        return this.itemTemplate(value);
    },
    
    filterTemplate: function(value) {
        this._filterPicker = $("<input>").attr("type", "datetime-local");
        this._filterPicker.val(value);
        //this._filterPicker.val(UTIL.localDateString(new Date()));
        if (this.filtering) {
            return this._filterPicker;
        }
        return this.itemTemplate(value);
    },
 
    insertValue: function() {
        return this._insertPicker.val();
    },
 
    editValue: function() {
        return this._editPicker.val();
    },
    
    filterValue: function() {
        return this._filterPicker.val();
    }
    */
});
 
jsGrid.fields.date = HTML5DateField;    
    
</script>
  <style type="text/css">
html, body {
    /*height:99%;*/
    width:100%;
    padding:0px;
    margin:0px;
}   
.inline {
    display: inline-block;
    padding-top: 2px;
}  
textarea { 
    resize:vertical; 
    padding: 0px;
    margin: 0px;    
}

/* Style the tab */
div.tab {
    overflow: hidden;
    border: 1px solid #ccc;
    background-color: #e5e5e5;
}

/* Style the buttons inside the tab */
div.tab button {
    background-color: inherit;
    float: left;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 4px 6px;
    transition: 0.3s;
    font-size: large;
}

/* Change background color of buttons on hover */
div.tab button:hover {
    background-color: #ddd;
}

/* Create an active/current tablink class */
div.tab button.active {
    background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
    display: none;
    padding: 0px;
    border: 1px solid #ccc;
    border-top: none;
    background-color: #f1f1f1;
}

.tcontent {
    padding: 5px;
}

/* Style the close button */
.topright {
    float: right;
    cursor: pointer;
    font-size: large;
    padding: 0px 4px 0px 0px;
}

.topright:hover {color: red;}

#opstatus {
    background-color: #bbb;
}
.controldiv {
    position: fixed;
    width: 100%;
    top: 0;
    z-index: 200;
}
.controlleddiv {
    position: relative;
    top: 50px;
}
.rowbg {
    background-color: #ccc;
}
.rowbgm {
    background-color: #ddd;
}
.rowbgl {
    background-color: #f1f1f1;
}
.Reset {
    margin-top: 5px;
    margin-bottom: 5px;
}
#drop_zone {
    border: 2px dashed #bbb;
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px;
    border-radius: 5px;
    padding: 25px;
    text-align: center;
    color: #bbb;
}

.hideOverflow {
    overflow: hidden;
}

.jsgrid-cell {
    padding: 1px;
}
.jsgrid-header-cell {
    padding: 1px;
}
.jsgrid {
    /*overflow: scroll;*/
}
.jsgrid-grid-body {
    padding-bottom: 20px;
}
#selObj {
    margin-top: 50px;
    width: 100%;
    height: 100%;
}
.hidden {
    display: none;
}
.jsgrid-insert-row > td > input {
    background-color: #e3ffe5;
}
.error {
    border-color: red !important;
}
.jsgrid-insert-row .required > input, .jsgrid-edit-row .required > input {
    border-color: orange;
}
  </style>

</head>
<body>

<div class="controldiv">

    <div id="opstatus">Ok</div>

    <div class="tab">
      <button class="tablinks" onclick="openTab(event, 'Shops', '#jsGridShops')" id="tabShops">Shops</button>
      <button class="tablinks" onclick="openTab(event, 'Bills', '#jsGridBills')" id="tabBills">&amp;Bills</button>
      <button class="tablinks" onclick="openTab(event, 'BillList', '#jsGridBillList')" id="tabBillList">&amp;List</button>
      <button class="tablinks" onclick="openTab(event, 'Category', '#jsGridCategories')" id="tabCategory">Categories</button>
      <button class="tablinks" onclick="openTab(event, 'Product', '#jsGridProducts')" id="tabProduct">Products</button>
      <button class="tablinks" onclick="openTab(event, 'ProdCat', '#jsGridProductCats');" id="tabProdCat">&amp;Categories</button>
      <button class="tablinks" onclick="openTab(event, 'ProdShop', '#jsGridProductShops');" id="tabProdShop">&amp;Shops</button>
      <button class="tablinks" onclick="openTab(event, 'Errors')">Errors</button>
    </div>
</div>
<div class="controlleddiv">


    <div id="Shops" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <div id="jsGridControlShops"></div>
            <div id="jsGridPagerShops"></div>
            <div id="jsGridShops"></div>
        </div>
    </div>
    <div id="Bills" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <div id="jsGridControlBills"></div>
            <div id="jsGridPagerBills"></div>
            <div id="jsGridBills"></div>
        </div>
    </div>
    <div id="BillList" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <div id="jsGridControlBillList"></div>
            <div id="jsGridPagerBillList"></div>
            <div id="jsGridBillList"></div>
        </div>
    </div>
    <div id="Category" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <div id="jsGridControlCategories"></div>
            <div id="jsGridPagerCategories"></div>
            <div id="jsGridCategories"></div>
        </div>
    </div>
    <div id="Product" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <div id="jsGridControlProducts"></div>
            <div id="jsGridPagerProducts"></div>
            <div id="jsGridProducts"></div>
        </div>
    </div>
    <div id="ProdCat" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <div id="jsGridControlProductCats"></div>
            <div id="jsGridPagerProductCats"></div>
            <div id="jsGridProductCats"></div>
        </div>
    </div>
    <div id="ProdShop" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <div id="jsGridControlProductShops"></div>
            <div id="jsGridPagerProductShops"></div>
            <div id="jsGridProductShops"></div>
        </div>
    </div>
    
    <div id="Errors" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <span onclick="document.getElementById('errorDiv').innerHTML='<p>'" class="topright">&empty;&nbsp;</span>
        <div class="tcontent">
        <div id="errorDiv">Ok</div>
        </div>
    </div>
    
</div>

<textarea id="selObj" rows="4" cols="50">
</textarea>
<div style = "display:none;">
            <div id="jsGridPager"></div>
            <div id="jsGrid"></div>
</div>

</body>

<script>

function ObjectWrapper(obj) {
    this.listeners = [];
    this.obj = obj;
    this.set = function(param, v)  {
        var oldVal = this.get(param);
        this.obj[param] = v;
        var arr = this.listeners;
        for(var i = 0; i < arr.length; i++) {
            arr[i](this.obj, param, oldVal, v);
        }
    }
    this.get = function(param)  {
        if ( param && param in this.obj ) {
            return this.obj[param];
        }
        return undefined;
    }
    this.addListener = function(fn) {
        this.listeners.push(fn);
    }
    this.removeListener = function(fn) {
        var arr = this.listeners;
        for(var i = 0; i < arr.length; i++) {
            if(arr[i] === fn) {
                arr.splice(i, 1);
                break;
            }
        }    
    }
}
function normalizeParam(arr) {
    for (var i = 0; i < arr.length; i++) {
        if (arr[i] === undefined) {
            arr[i] = null;
        }
    }
    return arr;
}
var SHOPPING = {
    pageSize : 3,
    pageButtonCount: 5,
    val: new ObjectWrapper({})
};
SHOPPING.val.addListener(function(obj){
    $("#selObj").val(JSON.stringify(obj, null, 4));
});
//    var id = __idprefix + "-" + UTIL.generateGuid();

    var db = openDatabase('sevnShopping', '1.0', 'Shopping db', 20 * 1024 * 1024);
    db.transaction(
        function(transaction) {
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS shops ' +
                '  (id TEXT NOT NULL PRIMARY KEY, ' +
                '   name TEXT NOT NULL,' +
                '   memo TEXT);'
            );
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS categories ' +
                '  (id TEXT NOT NULL PRIMARY KEY, ' +
                '   name TEXT NOT NULL,' +
                '   memo TEXT);'
            );
            //https://barcodes.olegon.ru/4612705550566
            //https://barcodes.olegon.ru/api/card/name/4612705550566
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS products ' +
                '  (id TEXT NOT NULL PRIMARY KEY, ' +
                '   idcode TEXT,' +
                '   name TEXT NOT NULL,' +
                '   memo TEXT);'
            );
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS prodcat ' +
                '  (prodid TEXT NOT NULL, ' +
                '   catid  TEXT NOT NULL,' +
                '   FOREIGN KEY(prodid) REFERENCES products(id)' +
                '   FOREIGN KEY(catid) REFERENCES categories(id), PRIMARY KEY(prodid, catid) );'
            );
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS shop_prod_code ' +
                '  (id     TEXT NOT NULL PRIMARY KEY, ' +
                '   name   TEXT NOT NULL,' +
                '   prodid TEXT NOT NULL,' +
                '   shopid TEXT NOT NULL,' +
                '   FOREIGN KEY(prodid) REFERENCES products(id)' +
                '   FOREIGN KEY(shopid) REFERENCES shops(id), ' +
                '   CONSTRAINT uniq_shop_prod_code UNIQUE(prodid, shopid) );'
            );
            /*
дата с временем
сумма
признак расчетаЖ прихода
порядковый номер документа (ФД)
заводской номер накопителя (ФН)
фискальный признак документа (ФП)            
            
номер фискального документа;
фискальный признак документа;
номер смены;
порядковый номер за смену;
вид налогообложения и другие.


ГАРАНТ.РУ: http://www.garant.ru/news/1099746/#ixzz5B46EuNDf
            
Параметр "n" отражает не вид системы налогообложения, а вид документа: 
1 - Приход 
2 - Возврат прихода 
4 - Расход 
5 - Возврат расхода 
7 - Коррекция прихода 
9 - Коррекция расхода            
            */
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS shop_bill ' +
                '  (id           TEXT NOT NULL PRIMARY KEY, ' +
                '   name         TEXT NOT NULL,' +
                '   memo         TEXT ,' +
                '   billdate     datetime default current_timestamp,' +
                '   qrcode       TEXT ,' +
                '   discountpct  INTEGER DEFAULT 0,'  +
                '   discount     INTEGER DEFAULT 0,'  +
                '   money        INTEGER DEFAULT 0,'  +
                '   shopid       TEXT NOT NULL,' +
                '   FOREIGN KEY(shopid) REFERENCES shops(id) ' +
                '   );'
            );
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS shop_bill_prod ' +
                '  (id           TEXT NOT NULL PRIMARY KEY, ' +
                '   memo         TEXT ,' +
                '   money        INTEGER DEFAULT 0,'  +
                '   discountpct  INTEGER DEFAULT 0,'  +
                '   discount     INTEGER DEFAULT 0,'  +
                '   cnt          INTEGER DEFAULT 0,'  +
                '   summoney     INTEGER DEFAULT 0,'  +
                '   shopbillid   TEXT NOT NULL,' +
                '   prodid       TEXT NOT NULL,' +
                '   FOREIGN KEY(shopbillid) REFERENCES shop_bill(id), ' +
                '   FOREIGN KEY(prodid) REFERENCES products(id) ' +
                '   );'
            );
        }
    );

    UTILDB.showTable(db, "shop_bill_prod");
function showStatus(m, o, exc) {
    var now = new Date().toISOString().slice(0,19).replace("T", " ");
    if (!o) {
        o = m;
    }
    var msg = now + ": <pre>" + UTIL.escapeHTML(o) + "</pre>";
    var msgSh = now + ": " + UTIL.escapeHTML(m);
    var statDiv = document.getElementById('opstatus');
    if (statDiv) {
        statDiv.innerHTML = msgSh;
    }
    var errDiv = document.getElementById('errorDiv');
    if (errDiv) {
        errDiv.innerHTML = msg + "<p>" + errDiv.innerHTML;
    }
    if (exc) {
        console.log(exc);
    }
}

function openTab(evt, tabName, gridname) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    if (evt) {
        evt.currentTarget.className += " active";
    }
    window.scrollTo(0, 0);
    if (gridname && $(gridname)) {
        $(gridname).data('JSGrid').search();
    }
}

function rowItem (results_rows, i) {
    if ( "item" in results_rows ) {
        return results_rows.item(i);
    } else {
        return results_rows[i];
    }
}
function isEmpty(obj) {
    if (obj) {
        if (obj.length > 0) {
            return false;
        }
    }
    return true;
}

function dict(cfg) {
    jsGrid.locale("ru");
    
    if ("divName" in cfg) {
        cfg.div = "#jsGrid" + cfg.divName;
        cfg.divPager = "#jsGridPager" + cfg.divName;
        cfg.divControl = "#jsGridControl" + cfg.divName;
    }
 
    $(cfg.div).jsGrid({
        width: "100%",
        height: "auto",
        
        pageLoading: true,        
 
        inserting: true,
        
        filtering: true,
        editing: true,
        sorting: true,
        paging: true,
        autoload: !true,
 
        pagerContainer : $(cfg.divPager),
        pageSize: SHOPPING.pageSize,
        pageButtonCount: SHOPPING.pageButtonCount,
 
        onDataLoaded: function(args) {
            var filter = this.getFilter();
            if (args.data.data.length == 1) {
                if (!isEmpty(filter.id)) {
                    cfg.val.set(cfg.valName, args.data.data[0]);
                }
            } else {
                cfg.val.set(cfg.valName, null);
            }
            console.log(cfg.val);
        },
        
        controller: {
            loadData: function (filter) {
                var pageIndex = filter.pageIndex;
                var pageSize = filter.pageSize;
                var sortField = cfg.sortField;
                var sortOrder = "asc";
                if ("sortField" in filter) {
                    sortField = filter.sortField;
                }
                if ("sortOrder" in filter) {
                    sortOrder = filter.sortOrder;
                }
                var whereClause = "";
                var sqlArgsCnt = [];
                var sqlArgs = [pageSize, ((pageIndex - 1) * pageSize)];
                var filterVal = null;
                
                for (var j = 0; j < cfg.fieldNames.length; j++) {
                    var k = cfg.fieldNames[j];
                    filterVal = filter[k];
                    if (!isEmpty(filterVal)) {
                        if (whereClause.length > 0) {
                            whereClause = " AND " + whereClause;
                        }
                        whereClause = (" " + k + " LIKE ? ") + whereClause;
                        sqlArgs.splice(0, 0, "%" + filterVal + "%");
                        sqlArgsCnt.splice(0, 0, "%" + filterVal + "%");
                    }
                }
                
                filterVal = filter["id"];
                if (!isEmpty(filterVal)) {
                    if (whereClause.length > 0) {
                        whereClause = " AND " + whereClause;
                    }
                    whereClause = " id = ? " + whereClause;
                    sqlArgs.splice(0, 0, filterVal);
                    sqlArgsCnt.splice(0, 0, filterVal);
                }
                if (whereClause.length > 0) {
                    whereClause = "WHERE " + whereClause;
                }
                
                console.log(filter, whereClause);
                return new Promise(function(resolve, reject) {
                    var itemsCount = 0;
                    
                    db.transaction(function (tx) {
                        tx.executeSql("SELECT count(*) AS cnt FROM " + cfg.table + " " + whereClause, sqlArgsCnt, 
                            function (tx, results) {
                                var len = results.rows.length;
                                if (len > 0) {
                                    var rowIt = rowItem(results.rows,0);
                                    itemsCount = rowIt.cnt;
                                    
                                    if (itemsCount > 0) {
                                        tx.executeSql("SELECT * FROM " + cfg.table + " " + whereClause + " ORDER BY " + sortField + " " + sortOrder + " LIMIT ? OFFSET ? ", sqlArgs, 
                                            function (tx, results) {
                                                var len = results.rows.length;
                                                var arr = [];
                                                for(var i = 0; i < len; i++) {
                                                    var rowIt = rowItem(results.rows,i);
                                                    var obj = {};
                                                    for (var j = 0; j < cfg.fieldNames.length; j++) {
                                                        var k = cfg.fieldNames[j];
                                                        obj[k] = rowIt[k];
                                                    }
                                                    obj.id = rowIt.id;
                                                    arr.push(obj);
                                                }
                                                resolve({ data: arr, itemsCount: itemsCount });
                                            },
                                            function(err) { 
                                                showStatus("Error", null, err);
                                                reject(err);
                                            }
                                        );    
                                    } else {
                                        resolve({ data: [], itemsCount: itemsCount });
                                    }
                                    
                                } else {
                                    reject();
                                }
                            },
                            function(err) { 
                                showStatus("Error", null, err);
                                reject(err);
                            }
                        );    

                    });
                    
                });
            },
            insertItem: function(item) { 
                console.log(item);
                var id = cfg.idPrefix+UTIL.generateGuid();
                if (item.id) {
                    id = item.id;
                }
                    
                var namesStr = "";
                var paramStr = "";
                var paramArr = [];
                for (var j = 0; j < cfg.fieldNames.length; j++) {
                    var k = cfg.fieldNames[j];
                    if (paramArr.length > 0) {
                        namesStr += ", ";
                        paramStr += ", ";
                    }
                    namesStr += k;
                    paramStr += "?";
                    paramArr.push(item[k]);
                }
                if (paramArr.length > 0) {
                    namesStr += ", ";
                    paramStr += ", ";
                }
                namesStr += "id";
                paramStr += "?";
                paramArr.push(id);
                
                return new Promise(function(resolve, reject) {

                    db.transaction(function (tx) {
                        tx.executeSql('INSERT INTO ' + cfg.table + ' (' + namesStr + ') VALUES (' + paramStr + ')', 
                            paramArr, 
                            function(transaction, results){ 
                                showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
                                item.id = id;
                                resolve(item);
                            }, 
                            function(err) { 
                                showStatus("Error", null, err);
                                reject(err);
                            }
                        );
                    });
                });
            },
            updateItem: function(item) { 
                console.log(item);
                var namesStr = "";
                var paramArr = [];
                for (var j = 0; j < cfg.fieldNames.length; j++) {
                    var k = cfg.fieldNames[j];
                    if (paramArr.length > 0) {
                        namesStr += ", ";
                    }
                    namesStr += k;
                    namesStr += " = ?";
                    paramArr.push(item[k]);
                }
                paramArr.push(item["id"]);

                return new Promise(function(resolve, reject) {
                     db.transaction(function (tx) {
                        tx.executeSql("UPDATE " + cfg.table + " SET " + namesStr + " WHERE id = ? ", 
                            paramArr, 
                            function(transaction, results){ 
                                showStatus("Updated: " + results.rowsAffected);
                                if (results.rowsAffected < 1) {
                                    reject();
                                } else {
                                    resolve(item);
                                }
                            }, 
                            function(err) { 
                                showStatus("Error", null, err);
                                reject(err);
                            }
                        );
                     });
                });
            },
            deleteItem: function(item) { 
                console.log(item);
                return new Promise(function(resolve, reject) {
                    db.transaction(function (tx) {
                        tx.executeSql('DELETE FROM ' + cfg.table + ' WHERE id = ? ', [item.id], 
                            function(transaction, results){ 
                                showStatus("Deleted: " + results.rowsAffected);
                                resolve(item);
                            }, 
                            function(err) { 
                                showStatus("Error", null, err);
                                reject(err);
                            }
                        );
                    });
                });
            }
        }, 
        
        selectedRow: false,
        rowClick: function(args) {
            if ( this.selectedRow ) { this.selectedRow.children('.jsgrid-cell').css('background-color', ''); }
            var $row = this.rowByItem(args.item);
            $row.children('.jsgrid-cell').css('background-color','#F7B64B');
            this.selectedRow = $row;
        },
        rowDoubleClick: function(args) {
            var item = args.item;
            
            this.clearFilter();
            for (var i = 0; i < this.fields.length; i++) {
                var field = this.fields[i];
                if(field.filtering) {
                
                    var props = field.name.split('.');
                    var prop = props[0];
                    
                    if ("id" == prop) {
                        field.filterControl.val(item.id);
                        break;
                    }
                }
            }
            
            this.search(this.getFilter());
            this.option("inserting", false);
            this.option("filtering", true);
        },
 
        fields: cfg.fields
    });

    if ("createColControls" in cfg && !cfg.createColControls) {} else {
        createColControls(cfg);
    }
}

function dictBindMain(cfg) {
    jsGrid.locale("ru");
 
    if ("divName" in cfg) {
        cfg.div = "#jsGrid" + cfg.divName;
        cfg.divPager = "#jsGridPager" + cfg.divName;
        cfg.divControl = "#jsGridControl" + cfg.divName;
    }
    $(cfg.div).jsGrid({
        width: "100%",
        height: "auto",
        
        pageLoading: true,        
 
        inserting: true,
        
        filtering: true,
        editing: true,
        sorting: true,
        paging: true,
        autoload: !true,
 
        pagerContainer : $(cfg.divPager),
        pageSize: SHOPPING.pageSize,
        pageButtonCount: SHOPPING.pageButtonCount,
 
        onDataLoaded: function(args) {
            if ("valName" in cfg && cfg.valName) {
                var filter = this.getFilter();
                if (args.data.data.length == 1) {
                    if (!isEmpty(filter.id)) {
                        cfg.val.set(cfg.valName, args.data.data[0]);
                    }
                } else {
                    cfg.val.set(cfg.valName, null);
                }
                console.log(cfg.val);
            }
        },
        
        controller: {
            loadData: function (filter) {
/*
                'CREATE TABLE IF NOT EXISTS prodcat ' +
                '  (prodid TEXT NOT NULL, ' +
                '   catid  TEXT NOT NULL,' +
                '   FOREIGN KEY(prodid) REFERENCES products(id)' +
                '   FOREIGN KEY(catid) REFERENCES categories(id), PRIMARY KEY(prodid, catid) );'
                
                SELECT * from 
*/
                var sqlArgsCnt = [];
                var mainSqlParam = cfg.mainSqlParam(cfg);
                if (mainSqlParam && mainSqlParam.length > 0 || cfg.mainSqlParamEmpty ) {
                    sqlArgsCnt = sqlArgsCnt.concat(mainSqlParam);
                } else {
                    return new Promise(function(resolve, reject) {
                        resolve({ data: [], itemsCount: 0 });
                    });
                }
                var pageIndex = filter.pageIndex;
                var pageSize = filter.pageSize;
                var sortField = cfg.sortField;
                var sortOrder = "asc";
                if ("sortField" in filter) {
                    sortField = filter.sortField;
                }
                if ("sortOrder" in filter) {
                    sortOrder = filter.sortOrder;
                }
                var filterClause = "";
                
                var sqlArgs = [];
                sqlArgs = sqlArgs.concat(mainSqlParam);
                
                for (var j = 0; j < cfg.fieldNames.length; j++) {
                    var k = cfg.fieldNames[j];
                    filterVal = filter[k];
                    if (!isEmpty(filterVal)) {
                        if (filterClause.length > 0) {
                            filterClause += " AND ";
                        }
                        filterClause += (" " + k + " LIKE ? ");
                        sqlArgs.push("%" + filterVal + "%");
                        sqlArgsCnt.push("%" + filterVal + "%");
                    }
                }
                if (filterClause.length > 0) {
                    filterClause = " WHERE " + filterClause;
                }
                
                sqlArgs.push(pageSize);
                sqlArgs.push((pageIndex - 1) * pageSize);
                
                var mainsql = cfg.mainsql(cfg);
                var sqlCnt = "SELECT count(*) AS cnt FROM (" + mainsql + ") " + filterClause;
                var sql = "SELECT * FROM (" + mainsql + 
                    " ) " + filterClause + 
                    " ORDER BY " + sortField + " " + sortOrder + 
                    " LIMIT ? OFFSET ? ";


                return new Promise(function(resolve, reject) {
                    var itemsCount = 0;
                    
                    db.transaction(function (tx) {
                        tx.executeSql(sqlCnt, sqlArgsCnt, 
                            function (tx, results) {
                                var len = results.rows.length;
                                if (len > 0) {
                                    var rowIt = rowItem(results.rows,0);
                                    itemsCount = rowIt.cnt;
                                    
                                    if (itemsCount > 0) {
                                        tx.executeSql(sql, sqlArgs, 
                                            function (tx, results) {
                                                var len = results.rows.length;
                                                var arr = [];
                                                for(var i = 0; i < len; i++) {
                                                    var rowIt = rowItem(results.rows,i);
                                                    var obj = {};
                                                    for (var j = 0; j < cfg.fieldNames.length; j++) {
                                                        var k = cfg.fieldNames[j];
                                                        obj[k] = rowIt[k];
                                                    }
                                                    arr.push(obj);
                                                }
                                                resolve({ data: arr, itemsCount: itemsCount });
                                            },
                                            function(err) { 
                                                showStatus("Error", null, err);
                                                reject(err);
                                            }
                                        );    
                                    } else {
                                        resolve({ data: [], itemsCount: itemsCount });
                                    }
                                    
                                } else {
                                    reject();
                                }
                            },
                            function(err) { 
                                showStatus("Error", null, err);
                                reject(err);
                            }
                        );    

                    });
                    
                });
            },
            insertItem: function(item) { 
                console.log(item);
                var prm = cfg.insertItemParams(item, cfg);

                return new Promise(function(resolve, reject) {
                    if (prm.paramArr.length > 0) {
                        db.transaction(function (tx) {
                            tx.executeSql('INSERT INTO ' + cfg.table + ' (' + prm.namesStr + ') VALUES (' + prm.paramStr + ')', 
                                prm.paramArr, 
                                function(transaction, results){ 
                                    showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
                                    resolve(item);
                                }, 
                                function(err) { 
                                    showStatus("Error", null, err);
                                    reject(err);
                                }
                            );
                        });
                    } else {
                        reject();
                    }
                });
            },
            updateItem: function(item) { 
                console.log(item);
                var prm = cfg.updateItemParams(item, cfg);

                return new Promise(function(resolve, reject) {
                    if (prm.paramArr.length > 0) {
                     db.transaction(function (tx) {
                        tx.executeSql("UPDATE " + cfg.table + " SET " + prm.namesStr + " WHERE " + prm.whereStr, 
                            prm.paramArr, 
                            function(transaction, results){ 
                                showStatus("Updated: " + results.rowsAffected);
                                if (results.rowsAffected < 1) {
                                    reject();
                                } else {
                                    resolve(item);
                                }
                            }, 
                            function(err) { 
                                showStatus("Error", null, err);
                                reject(err);
                            }
                        );
                     });
                    } else {
                        reject();
                    }
                });
            },
            deleteItem: function(item) { 
                console.log(item);
                var grid = this;
                return new Promise(function(resolve, reject) {
                    db.transaction(function (tx) {
                        tx.executeSql(cfg.deleteSql(item, grid, cfg), cfg.deleteSqlParam(item, grid, cfg), 
                            function(transaction, results){ 
                                showStatus("Deleted: " + results.rowsAffected);
                                resolve(item);
                            }, 
                            function(err) { 
                                showStatus("Error", null, err);
                                reject(err);
                            }
                        );
                    });
                });
            }
        }, 
        
        selectedRow: false,
        rowClick: function(args) {
            if ( this.selectedRow ) { this.selectedRow.children('.jsgrid-cell').css('background-color', ''); }
            var $row = this.rowByItem(args.item);
            $row.children('.jsgrid-cell').css('background-color','#F7B64B');
            this.selectedRow = $row;
        },
        
        rowDoubleClick: function(args) {
            var item = args.item;
            
            this.clearFilter();
            for (var i = 0; i < this.fields.length; i++) {
                var field = this.fields[i];
                if(field.filtering) {
                
                    var props = field.name.split('.');
                    var prop = props[0];
                    
                    if ("id" == prop) {
                        field.filterControl.val(item.id);
                        break;
                    }
                }
            }
            
            this.search(this.getFilter());
            this.option("inserting", false);
            this.option("filtering", true);
        },

        fields: cfg.fields
    });

    if ("createColControls" in cfg && !cfg.createColControls) {} else {
        createColControls(cfg);
    }
}


/*
//user field
//https://github.com/tabalinas/jsgrid/issues/865

var gridSettings = JSON.parse(localStorage.getItem("gridSettings"));
var grid = $("#jsGrid").data("JSGrid");

grid.search(gridSettings.filter).done(function() {
    grid.sort({
    	field: gridSettings.sorting.sortField,
        order: gridSettings.sorting.sortOrder
    }).done(function() {
        grid.option("pageIndex", gridSettings.pageIndex);
    });
});

$("#saveSettings").on("click", function() {
    localStorage.setItem("gridSettings", JSON.stringify({
    	sorting: grid._sortingParams(),
        pageIndex: grid.option("pageIndex"),
        filter: grid.getFilter()
    }));
});
*/

dict({
    val: SHOPPING.val,
    valName: "shop",
    divName: "Shops",
    sortField: "name",
    table: "shops",
    fieldNames: ["name", "memo"], 
    idPrefix: "shop",
    fields: [
        { name: "id", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "name", title: "Name", type: "text", width: 150, validate: "required", css: "required" },
        { name: "memo", title: "Comment", type: "text", width: 200, sorting: false },
        { type: "control" }
    ]
    
});

dict({
    val: SHOPPING.val,
    valName: "category",
    divName: "Categories",
    sortField: "name",
    table: "categories",
    fieldNames: ["name", "memo"], 
    idPrefix: "cat",
    fields: [
        { name: "id", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "name", title: "Name", type: "text", width: 150, validate: "required", css: "required" },
        { name: "memo", title: "Comment", type: "text", width: 200, sorting: false },
        { type: "control" }
    ]
    
});

dict({
    val: SHOPPING.val,
    valName: "product",
    divName: "Products",
    sortField: "name",
    table: "products",
    fieldNames: ["idcode", "name", "memo"], 
    idPrefix: "prod",
    fields: [
        { name: "id", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "idcode", type: "text", width: 100, css: "hideOverflow" },
        { name: "name", title: "Name", type: "text", width: 150, validate: "required" },
        { name: "memo", title: "Comment", type: "text", width: 200, sorting: false },
        { type: "control" }
    ]
    
});

/*
                'CREATE TABLE IF NOT EXISTS prodcat ' +
                '  (prodid TEXT NOT NULL, ' +
                '   catid  TEXT NOT NULL,' +
                '   FOREIGN KEY(prodid) REFERENCES products(id)' +
                '   FOREIGN KEY(catid) REFERENCES categories(id), PRIMARY KEY(prodid, catid) );'
*/

dictBindMain({
    val: SHOPPING.val,
    valName: null, //"product",
    divName: "ProductCats",
    sortField: "catname",
    table: "prodcat",
    fieldNames: ["prodid", "catid", "prodidcode", "prodname", "catname"], 
    mainSqlParamEmpty: true,
    mainsql: function(cfg) {
        var prod = cfg.val.get("product");
        if (prod) {
            return "SELECT tb.prodid as prodid, tb.catid as catid, tc.name as catname, tp.name as prodname, tp.idcode as prodidcode FROM prodcat " +
                        " tb, products tp, categories tc WHERE prodid = ? AND tb.prodid = tp.id AND tb.catid = tc.id ";
        } else {
            return "SELECT tb.prodid as prodid, tb.catid as catid, tc.name as catname, tp.name as prodname, tp.idcode as prodidcode FROM prodcat " +
                        " tb, products tp, categories tc WHERE tb.prodid = tp.id AND tb.catid = tc.id ";
        }
    },
    mainSqlParam: function(cfg) {
        var prod = cfg.val.get("product");
        if (prod) {
            return [prod.id];
        }
        return [];
    },
    insertItemParams: function(item, cfg) { 
        var ret = {};
        ret.namesStr = "prodid, catid";
        ret.paramStr = "?, ?";
        var paramArr = [];
        if (cfg.val.get("category") 
            && cfg.val.get("product")) {
            
            paramArr.push(cfg.val.get("product").id);
            paramArr.push(cfg.val.get("category").id);
        }
        ret.paramArr = paramArr;
        return ret;
    },
    updateItemParams: function(item, cfg) { 
        var ret = {};
        ret.namesStr = "";
        ret.whereStr = "id = ?"
        var paramArr = [];
        /* //there is no update
        for (var j = 0; j < cfg.fieldNames.length; j++) {
            var k = cfg.fieldNames[j];
            if (paramArr.length > 0) {
                ret.namesStr += ", ";
            }
            ret.namesStr += k;
            ret.namesStr += " = ?";
            paramArr.push(item[k]);
        }
        paramArr.push(item["id"]);
        */
        ret.paramArr = paramArr;
        return ret;
    },
    
    deleteSql: function(item) {
        return 'DELETE FROM prodcat WHERE prodid = ? AND catid = ?';
    },
    deleteSqlParam: function(item) {
        return [item.prodid, item.catid];
    },
    fields: [
        { name: "prodid", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "catid", type: "text", width: 50, css: "hideOverflow", editing: false },
//        { name: "prodidcode", type: "text", width: 100, css: "hideOverflow", editing: false },
//        { name: "prodname", title: "Product", type: "text", width: 150, editing: false },
        { name: "catname", title: "Category", type: "text", width: 150, editing: false },
        { type: "control" }
    ]
    
}, true);

/*
                'CREATE TABLE IF NOT EXISTS shop_prod_code ' +
                '  (id     TEXT NOT NULL PRIMARY KEY, ' +
                '   name   TEXT NOT NULL,' +
                '   prodid TEXT NOT NULL,' +
                '   shopid TEXT NOT NULL,' +
                '   FOREIGN KEY(prodid) REFERENCES products(id)' +
                '   FOREIGN KEY(shopid) REFERENCES shops(id), ' +
                '   CONSTRAINT uniq_shop_prod_code UNIQUE(prodid, shopid) );'
*/
dictBindMain({
    val: SHOPPING.val,
    valName: null, //"product",
    divName: "ProductShops",
    sortField: "prodname", //
    table: "shop_prod_code", //
    fieldNames: ["id", "name", "prodid", "shopid", "prodidcode", "prodname", "shopname"], //
    mainSqlParamEmpty: true,
    mainsql: function (cfg) { //
        var prod = cfg.val.get("shop");
        if (prod) {
            return "SELECT tb.id as id, tb.name as name, tb.prodid as prodid, tb.shopid as shopid, tc.name as shopname, tp.name as prodname, tp.idcode as prodidcode FROM shop_prod_code " +
                        " tb, products tp, shops tc WHERE shopid = ? AND tb.prodid = tp.id AND tb.shopid = tc.id ";
        } else {
            return "SELECT tb.id as id, tb.name as name, tb.prodid as prodid, tb.shopid as shopid, tc.name as shopname, tp.name as prodname, tp.idcode as prodidcode FROM shop_prod_code " +
                        " tb, products tp, shops tc WHERE tb.prodid = tp.id AND tb.shopid = tc.id ";
        }
    },
    mainSqlParam: function(cfg) { //
        var prod = cfg.val.get("shop");
        if (prod) {
            return [prod.id];
        }
        return [];
    },
    insertItemParams: function(item, cfg) { //
        var ret = {};
        ret.namesStr = "prodid, shopid, id, name";
        ret.paramStr = "?, ?, ?, ?";
        var paramArr = [];
        if (cfg.val.get("product") 
            && cfg.val.get("shop")) {
            
            paramArr.push(cfg.val.get("product").id);
            paramArr.push(cfg.val.get("shop").id);
            var id = "spc" + UTIL.generateGuid();
            if (!isEmpty(item.id)) {
                id = item.id;
            }
            
            paramArr.push(id);
            paramArr.push(item.name);
        }
        ret.paramArr = paramArr;
        return ret;
    },
    updateItemParams: function(item, cfg) { //
        var ret = {};
        ret.namesStr = " name = ? ";
        ret.whereStr = "id = ?"
        var paramArr = [];
        paramArr.push(item["name"]);
        paramArr.push(item["id"]);
        ret.paramArr = paramArr;
        return ret;
    },
    
    deleteSql: function(item) { //
        return 'DELETE FROM shop_prod_code WHERE id = ?';
    },
    deleteSqlParam: function(item) { //
        return [item.id];
    },
    fields: [ //
        { name: "id", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "name", title: "Shop Code", type: "text", width: 150, editing: true },
        { name: "prodid", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "shopid", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "prodidcode", title: "Code", type: "text", width: 100, css: "hideOverflow", editing: false },
        { name: "prodname", title: "Product", type: "text", width: 150, editing: false },
//        { name: "shopname", title: "Category", type: "text", width: 150, editing: false },
        { type: "control" }
    ]
    
});
function createColControls(cfg) {
    var controldiv = $(cfg.divControl);
    var fields = $(cfg.div).data('JSGrid').fields;
    for(var i = 0; i < fields.length; i++) {
        var v = fields[i];
        if (v.type !== "control") {
            var n = v.name;
            if ("title" in v && v.title) {
                n = v.title;
            }
            (function(controldiv, cfgdiv, fname, n) {
                var chboxdiv = $('<div class="inline"></div>');
                chboxdiv.appendTo(controldiv);
                var chbox = $('<input type="checkbox" checked=true />');
                chbox.appendTo(chboxdiv);
                var chboxLabel = $("<span>"+n+"</span>");
                chboxLabel.appendTo(chboxdiv);
                
                chboxLabel.click (function() {
                    chbox.click();
                });
                chbox.click(function() {
                    //$(cfgdiv).jsGrid("fieldOption", fname, "visible", chbox[0].checked);
                    var fieldCss = $(cfgdiv).jsGrid("fieldOption", fname, "css");
                    if (chbox[0].checked) {
                        fieldCss = fieldCss.replace(" hidden", "");
                    } else {
                        fieldCss += " hidden";
                    }
                    $(cfgdiv).jsGrid("fieldOption", fname, "css", fieldCss);
                    console.log(fieldCss);
                });
            })(controldiv, cfg.div, v.name, n);
        }
    };
}


/*
                'CREATE TABLE IF NOT EXISTS shop_bill ' +
                '  (id           TEXT NOT NULL PRIMARY KEY, ' +
                '   name         TEXT NOT NULL,' +
                '   memo         TEXT ,' +
                '   billdate     datetime default current_timestamp,' +
                '   qrcode       TEXT ,' +
                '   discountpct  INTEGER DEFAULT 0,'  +
                '   discount     INTEGER DEFAULT 0,'  +
                '   money        INTEGER DEFAULT 0,'  +
                '   shopid       TEXT NOT NULL,' +
                '   FOREIGN KEY(shopid) REFERENCES shops(id) ' +
                '   );'

*/
dictBindMain({
    val: SHOPPING.val,
    valName: "bill",
    divName: "Bills",
    sortField: "name", //
    table: "shop_bill", //
    fieldNames: ["id", "name", "memo", "billdate", "qrcode", "discountpct", "discount", "money", "shopid", "shopname"], //
    mainsql: function (cfg) { //
        var prod = cfg.val.get("shop");
        if (prod) {
            return "SELECT tb.id as id, tb.name as name, tb.memo as memo, tb.billdate as billdate, tb.qrcode as qrcode, tb.discountpct as discountpct, "+
                   " tb.discount as discount, tb.money as money, tb.shopid as shopid, tc.name as shopname FROM shop_bill " +
                        " tb, shops tc WHERE shopid = ? AND tb.shopid = tc.id ";
        }
        return "SELECT tb.id as id, tb.name as name, tb.memo as memo, tb.billdate as billdate, tb.qrcode as qrcode, tb.discountpct as discountpct, "+
               " tb.discount as discount, tb.money as money, tb.shopid as shopid, tc.name as shopname FROM shop_bill " +
                    " tb, shops tc WHERE tb.shopid = tc.id ";
    },
    mainSqlParamEmpty: true,
    mainSqlParam: function(cfg) { //
        var prod = cfg.val.get("shop");
        if (prod) {
            return [prod.id];
        }
        return [];
    },
    updateFields: ["name", "memo", "billdate", "qrcode", "discountpct", "discount", "money"],
    insertItemParams: function(item, cfg) { //
        var ret = {};
        ret.namesStr = "shopid, id, name, memo, billdate, qrcode, discountpct, discount, money";
        ret.paramStr = "?, ?, ?, ?, ?, ?, ?, ?, ?";
        var paramArr = [];
        if (cfg.val.get("shop")) {
            
            paramArr.push(cfg.val.get("shop").id);
            var id = "bill" + UTIL.generateGuid();
            if (!isEmpty(item.id)) {
                id = item.id;
            }
            
            paramArr.push(id);
            
            this.updateFields.forEach(function(el){
                paramArr.push(item[el]);
            });
        }
        ret.paramArr = normalizeParam(paramArr);
        return ret;
    },
    updateItemParams: function(item, cfg) { //
        var ret = {};
        ret.namesStr = "";
        ret.whereStr = "id = ?"
        var paramArr = [];
        
        for (var i = 0; i < this.updateFields.length; i++) {
            if (i > 0) {
                ret.namesStr += ", ";
            }
            var el = this.updateFields[i];
            ret.namesStr += (el + " = ? ");
            paramArr.push(item[el]);
            
        }
        paramArr.push(item["id"]);
        ret.paramArr = normalizeParam(paramArr);
        return ret;
    },
    
    deleteSql: function(item) { //
        return 'DELETE FROM shop_bill WHERE id = ?';
    },
    deleteSqlParam: function(item) { //
        return [item.id];
    },
    fields: [ //["billdate"]
        { name: "id", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "name", type: "text", width: 150, editing: true },
        { name: "shopid", type: "text", width: 50, css: "hideOverflow", editing: false },
        
        { name: "billdate", type: "date", width: 200 },
//        { name: "shopname", title: "Shop", type: "text", width: 150, editing: false },
        { name: "memo", title: "Comment", type: "text", width: 100, sorting: false },
        { name: "qrcode", title: "QRCode", type: "text", width: 100, sorting: false },
        
        { name: "discountpct", type: "number", width: 100 },
        { name: "discount", type: "number", width: 100 },
        { name: "money", type: "number", width: 100 },

        { type: "control" }
    ]
    
});

/*
                'CREATE TABLE IF NOT EXISTS shop_bill_prod ' +
                '  (id           TEXT NOT NULL PRIMARY KEY, ' +
                '   memo         TEXT ,' +
                '   money        INTEGER DEFAULT 0,'  +
                '   discountpct  INTEGER DEFAULT 0,'  +
                '   discount     INTEGER DEFAULT 0,'  +
                '   cnt          INTEGER DEFAULT 0,'  +
                '   summoney     INTEGER DEFAULT 0,'  +
                '   shopbillid   TEXT NOT NULL,' +
                '   prodid       TEXT NOT NULL,' +
                '   FOREIGN KEY(shopbillid) REFERENCES shop_bill(id), ' +
                '   FOREIGN KEY(prodid) REFERENCES products(id) ' +
                '   );'

*/
dictBindMain({
    val: SHOPPING.val,
    valName: null, 
    divName: "BillList",
    sortField: "billdate", //
    table: "shop_bill_prod", //
    fieldNames: ["id", "memo", "money", "discountpct", "discount",  "cnt", "summoney", "shopbillid", "prodid", "prodname", "shopname", "billdate"], //
    mainsql: function (cfg) { //
        var prod = cfg.val.get("bill");
        if (prod) {
            return "SELECT tb.id as id, tb.memo as memo, tb.money as money, tb.discountpct as discountpct, "+
                   " tb.discount as discount, tb.cnt as cnt, tb.summoney as summoney, tb.shopbillid as shopbillid, tb.prodid as prodid, " +
                   "ts.billdate as billdate, tc.name as shopname, tp.name as prodname FROM shop_bill_prod " +
                        " tb, shop_bill ts, products tp, shops tc WHERE shopbillid = ? AND tb.shopbillid = ts.id AND ts.shopid = tc.id " +
                        " AND tb.prodid = tp.id " ;
        }
            return "SELECT tb.id as id, tb.memo as memo, tb.money as money, tb.discountpct as discountpct, "+
                   " tb.discount as discount, tb.cnt as cnt, tb.summoney as summoney, tb.shopbillid as shopbillid, tb.prodid as prodid, " +
                   "ts.billdate as billdate, tc.name as shopname, tp.name as prodname FROM shop_bill_prod " +
                        " tb, shop_bill ts, products tp, shops tc WHERE tb.shopbillid = ts.id AND ts.shopid = tc.id " +
                        " AND tb.prodid = tp.id " ;
    },
    mainSqlParamEmpty: true,
    mainSqlParam: function(cfg) { //
        var prod = cfg.val.get("bill");
        if (prod) {
            return [prod.id];
        }
        return [];
    },
    updateFields: ["memo", "money", "discountpct", "discount",  "cnt", "summoney"],
    insertItemParams: function(item, cfg) { //
        var ret = {};
        ret.namesStr = "shopbillid, prodid, id, memo, money, discountpct, discount, cnt, summoney";
        ret.paramStr = "?, ?, ?, ?, ?, ?, ?, ?, ?";
        var paramArr = [];
        if (cfg.val.get("product") && cfg.val.get("bill")) {
            
            paramArr.push(cfg.val.get("bill").id);
            paramArr.push(cfg.val.get("product").id);
            var id = "bpr" + UTIL.generateGuid();
            if (!isEmpty(item.id)) {
                id = item.id;
            }
            
            paramArr.push(id);
            
            this.updateFields.forEach(function(el){
                paramArr.push(item[el]);
            });
        }
        debugger;
        ret.paramArr = normalizeParam(paramArr);
        return ret;
    },
    updateItemParams: function(item, cfg) { //
        var ret = {};
        ret.namesStr = "";
        ret.whereStr = "id = ?"
        var paramArr = [];
        
        for (var i = 0; i < this.updateFields.length; i++) {
            if (i > 0) {
                ret.namesStr += ", ";
            }
            var el = this.updateFields[i];
            ret.namesStr += (el + " = ? ");
            paramArr.push(item[el]);
            
        }
        paramArr.push(item["id"]);
        ret.paramArr = normalizeParam(paramArr);
        return ret;
    },
    
    deleteSql: function(item) { //
        return 'DELETE FROM shop_bill_prod WHERE id = ?';
    },
    deleteSqlParam: function(item) { //
        return [item.id];
    },
    fields: [
        { name: "id", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "memo", title: "Comment", type: "text", width: 100, sorting: false },
        { name: "money", type: "number", width: 100 },
        { name: "discountpct", type: "number", width: 100 },
        { name: "discount", type: "number", width: 100 },
        { name: "cnt", type: "number", width: 100, 
            validate: [ 
                "required", 
                {
                    message: "wrong value",
                    validator: function(value, item, param) { 
                        //debugger;
                        return true;
                    },
                    param: []
                }
                ] },
        { name: "summoney", type: "number", width: 100, validate: [ "required" ], css: "required", alterField: function(op, grid, item, row, target, field) {
            if (field && (field.name == "money" || field.name == "discount" || field.name == "discountpct" || field.name == "cnt") ||
                !field) {
                var summoney = parseFloat(item.summoney);
                if (isNaN(summoney) || summoney <= 0) {
                    var money = parseFloat(item.money);
                    if (!isNaN(money) && money >= 0) {
                        var discount = parseFloat(item.discount);
                        var cnt = parseFloat(item.cnt);
                        if (isNaN(cnt) || cnt <= 0) {
                            cnt = 1;
                        }
                        if (isNaN(discount) || discount <= 0) {
                            discount = 0;
                        }
                        summoney = (money - discount) * cnt;
                        item.summoney = summoney;
                        var idx = $.inArray(this, grid.fields);
                        var $cell = row.children().eq(idx);
                        $cell.children("input").val(summoney);
                    }
                }
            }
        } },
        { name: "shopbillid", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "prodid", type: "text", width: 50, css: "hideOverflow", editing: false },
        { name: "prodname", title: "Product", type: "text", width: 150, editing: false },
//        { name: "shopname", title: "Shop", type: "text", width: 150, editing: false },
        { name: "billdate", type: "date", width: 200, editing: false, inserting: false },
        { type: "control" }
    ]
    
});
////////////////////////////////////////////// 
$(function() {    
    var clients = [
        { "Name": "Otto Clay", "Age": 25, "Country": 1, "Address": "Ap #897-1459 Quam Avenue", "Married": false },
        { "Name": "Connor Johnston", "Age": 45, "Country": 2, "Address": "Ap #370-4647 Dis Av.", "Married": true },
        { "Name": "Lacey Hess", "Age": 29, "Country": 3, "Address": "Ap #365-8835 Integer St.", "Married": false },
        { "Name": "Timothy Henson", "Age": 56, "Country": 1, "Address": "911-5143 Luctus Ave", "Married": true },
        { "Name": "Ramona Benton", "Age": 32, "Country": 3, "Address": "Ap #614-689 Vehicula Street", "Married": false }
    ];
 
    var countries = [
        { Name: "", Id: 0 },
        { Name: "United States", Id: 1 },
        { Name: "Canada", Id: 2 },
        { Name: "United Kingdom", Id: 3 }
    ];
 
    jsGrid.locale("ru");
 
    $("#jsGrid").jsGrid({
        width: "100%",
        height: "auto",
        
        pageLoading: true,        
 
        inserting: true,
        
        filtering: true,
        editing: true,
        sorting: true,
        paging: true,
        autoload: true,
 
        pagerContainer : $("#jsGridPager"),
        pageSize: 3,
        pageButtonCount: 5,
 
        deleteConfirm: "Do you really want to delete the client?",        
 
        //data: clients,
        controller: {
            loadData: function (filter) {
                console.log(filter);
                return new Promise(function(resolve, reject) {
                    resolve({ data: clients, itemsCount: 5 });
                });
                //return { data: clients, itemsCount: 5 };
                //return clients;
            }
        }, 
        
        selectedRow: false,
        rowClick: function(args) {
            if ( this.selectedRow ) { this.selectedRow.children('.jsgrid-cell').css('background-color', ''); }
            var $row = this.rowByItem(args.item);
            $row.children('.jsgrid-cell').css('background-color','#F7B64B');
            this.selectedRow = $row;
        },        
 
        fields: [
            { name: "Name", type: "text", width: 150, validate: "required" },
            { name: "Age", type: "number", width: 50 },
            { name: "Address", type: "text", width: 200 },
            { name: "Country", type: "select", items: countries, valueField: "Id", textField: "Name" },
            { name: "Married", type: "checkbox", title: "Is Married", sorting: false },
            { type: "control" }
        ]
    });
});    
</script>

</html>