<!DOCTYPE html>
<html>
<meta charset="UTF-8">

  <style type="text/css">
 .control, .control input {
     font-size: large
 }
.lastClicked { 
    color: green !important;
    border: 3px solid green !important;
}
.lworden { 
    border-radius: 9px;
}
.noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.showword {
    background-color: yellow;
}
.inline {
    display: inline-block;
    padding: 2px;
}
  </style>

<body class="noselect">

<script>
function makeUtterance(lang, rate) {
    var ret = new SpeechSynthesisUtterance();
    ret.lang = lang;
    ret.rate = rate;
    return ret;
}

var utterance = {
    en: makeUtterance("en-UK", 1)
    //, ru: makeUtterance("ru-Ru", 1)
    , ru: null
};

var lastClicked = null;
var wordrate = {};
var wordsid = [];

function saveAs(data, filename) {
    var blob = new Blob([data], {type: "text/plain;charset=utf-8"});
    if (window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveBlob(blob, filename);
    } else {
        var elem = window.document.createElement('a');
        elem.href = window.URL.createObjectURL(blob);
        elem.download = filename;        
        document.body.appendChild(elem);
        elem.click();        
        document.body.removeChild(elem);
    }
}

function saveSettings() {
    var uname = document.getElementById('uname').value;
    if (! (uname && uname.trim().length > 0)) {
        alert("No user name");
        return;
    }
    var settings = { words : [], wordrate : {} };
    var uname = document.getElementById('uname').value;
    if (uname) {
        settings.uname = uname.trim();
    }
    var theme = document.getElementById('theme').value;
    if (theme) {
        settings.theme = theme.trim();
    }

    settings.words = wordsid;
    settings.wordrate = wordrate;
    var text = JSON.stringify( settings );
    var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    var todayDate = new Date().toISOString().replace(/[T\.Z]/g, "_");
    var filenameUname = "-" + uname + "-" + theme + "-";
    //var filenameUname = uname.replace(/[^a-zA-Z0-9_-а-яА-Я]/gi, '_').toLowerCase();
    saveAs(blob, "configData"+filenameUname+todayDate+".json");
    return settings;
}

function loadSettings(cfg) { 

    if ("words" in cfg) {
        clearWords();
        document.getElementById('uname').value = "";
        if ("uname" in cfg) {
            document.getElementById('uname').value = cfg.uname;
        }

        document.getElementById('theme').value = "";
        if ("theme" in cfg) {
            document.getElementById('theme').value = cfg.theme;
        }

        var wordDivs = [];
        var other = [];

        if ("wordrate" in cfg) {
            wordrate = cfg.wordrate;
        } else {
            wordrate = {};
        }

        let words = cfg.words.sort(function(a, b){
            var awr = 0;
            var bwr = 0;
            if (a.id in wordrate) {
                awr = wordrate[a.id];
            }
            if (b.id in wordrate) {
                bwr = wordrate[b.id];
            }
            return (awr < bwr);
        });
        if (words.length > 0) addWord(words[0], wordDivs, wordsid, other, words, 1);
    } else {
        alert("Wrong settings");
    }
}

function wordClicked(p) {
    var uname = document.getElementById('uname').value;
    if (! (uname && uname.trim().length > 0)) {
        alert("No user name");
        return;
    }
    var sayIt = utterance[p.lang] && p.innerText && p.innerText.length > 1;
    if (sayIt) {
        utterance[p.lang].text = p.innerText;
        speechSynthesis.speak(utterance[p.lang]);
    }
    p.classList.add("lastClicked");
    setTimeout(function(){
        if (lastClicked) {
//////        
            lastClicked.obj.classList.remove("lastClicked");
            var lc = lastClicked.obj;
            let w1id = p.id.substring(p.lang.length);
            let w2id = lc.id.substring(lc.lang.length);
            if(lc === p) {
                lastClicked.cnt = lastClicked.cnt + 1;
                let lccnt = lastClicked.cnt;

                if (lccnt > 2) {
                    var showwords = document.querySelectorAll(".id" + w2id);
                    showwords.forEach(function(e){
                        e.classList.add("showword");
                    });
                    setTimeout(function(){
                        showwords.forEach(function(e){
//////        
                            e.classList.remove("showword");
                });
                    }, 3000);
                } else {
                    if (w1id in wordrate) {
                        var w1 = wordrate[w1id];
                        wordrate[w1id] = w1-1;
                    } else {
                        wordrate[w1id] = -1;
                    }
                }

                if (!sayIt && utterance[p.lang]) {
                    utterance[p.lang].text = p.innerHTML;
                    speechSynthesis.speak(utterance[p.lang]);
                }
                p.setAttribute("title", "" + wordrate[w1id]);
                lastClicked.obj.classList.add("lastClicked");
                return;
            }

            if (p.lang != lc.lang) {
                if (w1id === w2id) {
                    setTimeout(function(){
                        document.body.removeChild(p);
                        document.body.removeChild(lc);
                        placedWords = document.querySelectorAll(".lword").length;
                        if (placedWords <= 0) {
                            var startAgain = false;
                            for (k in wordrate) {
                                if (wordrate[k] <= 5) {
                                    startAgain = true;
                                    break;
                                }
                            }
                            var cfg = saveSettings();
                            if (startAgain) {
                                loadSettings(cfg);
                            } else {
                                alert("THE END");
                            }
                        }
                    }, 500);
                    lastClicked = null;

                    if (w1id in wordrate) {
                        var w1 = wordrate[w1id];
                        wordrate[w1id] = w1+1;
                    } else {
                        wordrate[w1id] = 1;
                    }
                } else {
                    lastClicked = null;
                    if (w1id in wordrate) {
                        var w1 = wordrate[w1id];
                        wordrate[w1id] = w1-1;
                    } else {
                        wordrate[w1id] = -1;
                    }
                    if (w2id in wordrate) {
                        var w2 = wordrate[w2id];
                        wordrate[w2id] = w2-1;
                    } else {
                        wordrate[w2id] = -1;
                    }
                    p.setAttribute("title", "" + wordrate[w1id]);
                    lc.setAttribute("title", "" + wordrate[w2id]);
                }
//////        
                p.classList.remove("lastClicked");
            } else {
                lastClicked = {obj : p, cnt : 1};
            }
        } else {
            lastClicked = {obj : p, cnt : 1};
        }
        if (lastClicked) {
            lastClicked.obj.classList.add("lastClicked");
        }
    }, 100);
}
function printWord(element, w, wid, lng, col, callback) {
    var isPicture = w.startsWith("img:");

    element.setAttribute("onclick", "wordClicked(this)");
    element.setAttribute("id", lng+wid);
    element.setAttribute("lang", lng);
    if (wid in wordrate) {
        element.setAttribute("title", wordrate[wid]);
    } else {
        element.setAttribute("title", "0");
    }

    if (!isPicture) {
        element.innerHTML = w;
    }
    element.style.color = col;
    element.style.position = "absolute";
    moveDiv(element);
    element.style.fontWeight = "900";
    element.style.fontSize = "xx-large";
    element.style.border = '1px solid #cfcfc6';
    element.classList.add("lword");
    element.classList.add("lword"+lng);
    element.classList.add("id"+wid);
    document.body.appendChild(element);
    moveDiv(element, {x: "0px", y: "0px"});

    if (isPicture) {
        var img=document.createElement("img");
        img.onload = function(){
            moveDiv(element);
            //console.log("iiiiiiii>", getRect(element));
            if (callback) {
                callback();
            }
        };
        img.src=w.substring(4);
        element.appendChild(img);
    } else {
        moveDiv(element);
        if (callback) {
            callback();
        }
    }
}
function getRect(p) {
    var ret = {};
    ret.X1 = p.offsetLeft;
    ret.Y1 = p.offsetTop;
    ret.w = p.style.width;
    ret.h = p.style.height;
    ret.X2 = p.offsetWidth + ret.X1;
    ret.Y2 = p.offsetHeight + ret.Y1;
    return ret;
}
function hasOverlap(arr, p) {
    var RectA = getRect(p);
    return arr.some(function(e, i, a){
        var RectB = getRect(e);
        var isOk = (Math.max(RectA.X1, RectB.X1) < Math.min(RectA.X2, RectB.X2) && Math.max(RectA.Y1, RectB.Y1) < Math.min(RectA.Y2, RectB.Y2));
        //console.log(">>>>>>", isOk, RectA, RectB, p.id, e.id);
        if (isOk) {
            return true;
        }
        return false;
    });
}
var yWordOffset = 21;
function moveDiv(element, pnt) {
    if (pnt) {
        element.style.left = pnt.x;
        element.style.top = pnt.y;
    } else {
        var rect = getRect(element);
        element.style.left = "" + Math.floor((Math.random() * (window.innerWidth-Math.max(150, rect.w))) + 1) + "px";
        element.style.top = "" + Math.floor((Math.random() * (window.innerHeight-yWordOffset - rect.h - 1)) + yWordOffset) + "px";
    }
}

function startGame() {
    var text = "red,красный,plum,сливовый,img:zzz1.png,тест<sup>x</sup><sub>y</sub>";
    text = "<delimeter>|</delimeter>red|красный|plum|сливовый|img:zzz1.png|тест<sup>x</sup><sub>y</sub>";
    //text = "A,эй,B,би,C,си,D,ди,E,и,F,эф,G,джи,H,эйч,I,ай,J,джей,K,кей,L,эл,M,эм,N,эн,O,оу,P,пи,Q,кью,R,а,S,эс,T,ти,U,ю,V,ви,W,дабл ю,X,экс,Y,вай,Z,зет";
    loadWors(text, ",");
}
function clearWords() {
    wordsid = [];
    wordrate = {};
    document.querySelectorAll(".lword").forEach(function(e){
        document.body.removeChild(e);
    });

    let p = document.getElementById("controls");
    yWordOffset = p.offsetHeight + p.offsetTop;
    //console.log("????????????", yWordOffset);
}
function loadWors(text, splitter) {
    let sidx1 = text.indexOf("<delimeter>");
    let sidx2 = text.indexOf("</delimeter>");
    if (sidx1>=0 && sidx2>=0 && sidx1<sidx2) {
        splitter=text.substring(sidx1 + "<delimeter>".length, sidx2);
        text=text.substring(sidx2+"</delimeter>".length);
    }
    clearWords();

    var wordDivs = [];
    var words = [];
    var other = [];

    var wordsTemp = text.split(splitter);
    for (var k = 0; k+1 < wordsTemp.length; k+=2) {
        let eId = k/2 + 1;
        words.push({ en: wordsTemp[k].trim(), ru : wordsTemp[k+1].trim(), id : eId});
    }
    
    if (words.length > 0) addWord(words[0], wordDivs, wordsid, other, words, 1);
}
function addWord(e, wordDivs, wordsid, other, arr, idx) {
// TODO on end loading
    if (other && e.id in wordrate && wordrate[e.id] > 5) {
        other.push(e);
    } else {
        wordsid.push(e);
        if (!other && wordsid.length >= 10) {
            for(; idx < arr.length; idx++) {
                wordsid.push(arr[idx]);
            }
            return;
        }
        var ew = document.createElement("div");
        var rw = document.createElement("div");
        
        printWord(ew, e.en, e.id, "en", "red", function() {
            printWord(rw, e.ru, e.id, "ru", "blue", function() {
                let cnt = true;
                var j = 1;
                var isover = hasOverlap(wordDivs, ew);
                while(isover && j < 100) {
                    moveDiv(ew);
                    isover = hasOverlap(wordDivs, ew);
                    j=j+1;
                }
                if (j >= 100) cnt = false;
                wordDivs.push(ew);
                j = 1;
                isover = hasOverlap(wordDivs, rw);
                while(isover && j < 100) {
                    moveDiv(rw);
                    isover = hasOverlap(wordDivs, rw);
                    j=j+1;
                }
                if (j >= 100) cnt = false;
                wordDivs.push(rw);
                if (cnt && idx < arr.length) {
                    addWord(arr[idx], wordDivs, wordsid, other, arr, idx+1);
                } else {
                    if (other) {
                        if (wordsid.length < 10 && other.length > 0) {
                            shuffle(other);
                            addWord(other[0], wordDivs, wordsid, null, other, 1);
                        } else {
                            other.forEach(function(el) {
                                wordsid.push(el);
                            });
                        }
                    }
                }
            });
        });
    }    
}

function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
}
</script>

<div id="controls" class="control">
<input type="file" id="files" name="files[]" />
<div class="inline">User: <input type="text" id="uname" name="uname" size="10"/></div>
<div class="inline">Theme: <input type="text" id="theme" name="theme" size="12" /></div>
<input type="button" onclick="saveSettings()" value="Save"/>
</id>

<script>
    function handleFileSelect(evt) {
        if (window.File && window.FileReader && window.FileList && window.Blob) {

        } else {
            alert('The File APIs are not fully supported in this browser.');
            return;
        }

        var files = evt.target.files;

        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
            var reader = new FileReader();
            var themename = f.name;
            var pntidx = themename.indexOf(".");
            if (pntidx >= 0) {
                themename = themename.substring(0, pntidx);
            }
            reader.readAsText (f);
            reader.onload = function(e) {
                var text = reader.result;
                try {
                    var cfg = JSON.parse(text);
                    loadSettings(cfg);
                } catch (e) {
                    document.getElementById('theme').value = themename;

                    console.log("parse json error");
                    loadWors(text, ",");
                }
            };
        }
    }

    document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>

<script>
startGame();
</script>
</body>
</html>
