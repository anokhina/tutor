<!DOCTYPE html>
<!--
Copyright 2017 Veronica Anokhina.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style type="text/css">
 .control, .control input {
     font-size: small;
 }
.lastClicked { 
    color: green !important;
    border: 3px solid green !important;
}
.lworden { 
    border-radius: 9px;
}
.noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.showword {
    background-color: yellow;
}
.inline {
    display: inline-block;
    padding: 2px;
}
.hide {
    display: none;
}
.memo {
    color:gray;
    vertical-align: baseline;
}
.memo:after {
    content: "\A";
    margin-right: 6px;
    white-space: pre;
}
  </style>

<body class="noselect">

<script>
function makeUtterance(lang, rate) {
    var ret = new SpeechSynthesisUtterance();
    ret.lang = lang;
    ret.rate = rate;
    return ret;
}

var utterance = {
    en: makeUtterance("en-UK", 1)
    //, ru: makeUtterance("ru-Ru", 1)
    , ru: null
};

var lastClicked = null;
var wordrate = {};
var wordsid = [];
var idPrefixLength = 3;
var currentSettings = null;
var startAgain = false;

function saveAs(data, filename) {
    var blob = new Blob([data], {type: "text/plain;charset=utf-8"});
    if (window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveBlob(blob, filename);
    } else {
        var elem = window.document.createElement('a');
        elem.href = window.URL.createObjectURL(blob);
        elem.download = filename;        
        document.body.appendChild(elem);
        elem.click();        
        document.body.removeChild(elem);
    }
}

function makeSettings() {
    var settings = { words : [], wordrate : {} };
    var uname = document.getElementById('uname').value;
    if (uname) {
        settings.uname = uname.trim();
    }
    var theme = document.getElementById('theme').value;
    if (theme) {
        settings.theme = theme.trim();
    } else {
        settings.theme = "";
    }

    settings.words = wordsid;
    settings.wordrate = wordrate;
    return settings;
}
function saveSettings() {
    var uname = document.getElementById('uname').value;
    if (! (uname && uname.trim().length > 0)) {
        alert("No user name");
        return;
    }
    var settings = makeSettings();
    
    var text = JSON.stringify( settings );
    var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    var todayDate = new Date().toISOString().replace(/[T\.Z]/g, "_");
    var filenameUname = "-" + uname + "-" + settings.theme + "-";
    //var filenameUname = uname.replace(/[^a-zA-Z0-9_-а-яА-Я]/gi, '_').toLowerCase();
    saveAs(blob, "configData"+filenameUname+todayDate+".json");
    return settings;
}

function loadSettings(cfg) { 
    startAgain = false;
    hidePrise();

    if ("words" in cfg) {
        clearWords();
        document.getElementById('uname').value = "";
        if ("uname" in cfg) {
            document.getElementById('uname').value = cfg.uname;
        }

        document.getElementById('theme').value = "";
        if ("theme" in cfg) {
            document.getElementById('theme').value = cfg.theme;
        }

        var wordDivs = [];
        var other = [];

        if ("wordrate" in cfg) {
            wordrate = cfg.wordrate;
        } else {
            wordrate = {};
        }

        let words = cfg.words.sort(function(a, b){
            var awr = 0;
            var bwr = 0;
            if (a.id in wordrate) {
                awr = wordrate[a.id];
            }
            if (b.id in wordrate) {
                bwr = wordrate[b.id];
            }
            return (awr < bwr);
        });
        if (words.length > 0) addWord(words[0], wordDivs, wordsid, other, words, 1);
    } else {
        alert("Wrong settings");
    }
}

function wordClicked(p) {
    var uname = document.getElementById('uname').value;
    if (! (uname && uname.trim().length > 0)) {
        alert("No user name");
        return;
    }
    var sayIt = utterance[p.lang] && p.innerText && p.innerText.length > 1;
    if (sayIt) {
        utterance[p.lang].text = p.innerText;
        speechSynthesis.speak(utterance[p.lang]);
    }
    p.classList.add("lastClicked");
    setTimeout(function(){
        if (lastClicked) {
//////        
            lastClicked.obj.classList.remove("lastClicked");
            var lc = lastClicked.obj;
            let w1id = p.id.substring(idPrefixLength);
            let w2id = lc.id.substring(idPrefixLength);
            if(lc === p) {
                lastClicked.cnt = lastClicked.cnt + 1;
                let lccnt = lastClicked.cnt;

                if (lccnt > 2) {
                    var showwords = document.querySelectorAll(".id" + w2id);
                    showwords.forEach(function(e){
                        e.classList.add("showword");
                    });
                    setTimeout(function(){
                        showwords.forEach(function(e){
//////        
                            e.classList.remove("showword");
                        });
                    }, 3000);
                } else {
                    if (w1id in wordrate) {
                        var w1 = wordrate[w1id];
                        wordrate[w1id] = w1-1;
                    } else {
                        wordrate[w1id] = -1;
                    }
                    countRates();
                }

                if (!sayIt && utterance[p.lang]) {
                    utterance[p.lang].text = p.innerHTML;
                    speechSynthesis.speak(utterance[p.lang]);
                }
                p.setAttribute("title", "" + wordrate[w1id]);
                lastClicked.obj.classList.add("lastClicked");
                return;
            }

            if (p.lang != lc.lang) {
                if (w1id === w2id) {
                    let variants = document.querySelectorAll(".id" + w2id);
                    console.log(w2id, variants);
                    let nextLastClicked = null;
                    let findVariant = true;
                    let remove2 = [];
                    
                    if (variants.length > 2) {
                        findVariant = false;
                        if (p.lang == "en") {
                            remove2.push(lc);
                            nextLastClicked = {obj : p, cnt : lastClicked.cnt};
                        } else {
                            remove2.push(p);
                            nextLastClicked = lastClicked;
                        }
                    } else {
                        remove2.push(p);
                        remove2.push(lc);
                    }
                    
                    setTimeout(function(){
                        remove2.forEach(function(r) {
                            document.body.removeChild(r);
                        });
                        if (findVariant && document.querySelectorAll(".lword").length <= 0) {
                            for (k in wordrate) {
                                if (wordrate[k] <= 5) {
                                    startAgain = true;
                                }
                            }
                            showPrise();
                            var cfg = saveSettings();
                            currentSettings = cfg;
                        }
                    }, 500);
                    lastClicked = nextLastClicked;

                    if (w1id in wordrate) {
                        var w1 = wordrate[w1id];
                        wordrate[w1id] = w1+1;
                    } else {
                        wordrate[w1id] = 1;
                    }
                    countRates();
                } else {
                    lastClicked = null;
                    if (w1id in wordrate) {
                        var w1 = wordrate[w1id];
                        wordrate[w1id] = w1-1;
                    } else {
                        wordrate[w1id] = -1;
                    }
                    if (w2id in wordrate) {
                        var w2 = wordrate[w2id];
                        wordrate[w2id] = w2-1;
                    } else {
                        wordrate[w2id] = -1;
                    }
                    countRates();
                    p.setAttribute("title", "" + wordrate[w1id]);
                    lc.setAttribute("title", "" + wordrate[w2id]);
                }
//////        
                p.classList.remove("lastClicked");
            } else {
                lastClicked = {obj : p, cnt : 1};
            }
        } else {
            lastClicked = {obj : p, cnt : 1};
        }
        if (lastClicked) {
            lastClicked.obj.classList.add("lastClicked");
        }
    }, 100);
}
function getIdPrefix(prefix) {
    if (prefix < 10) {
        return "pr" + prefix;
    }
    if (prefix < 100) {
        return "p" + prefix;
    }
    return "prr";
}
var praise = [ "&#9973;", "&#9951;", "&#9924;", "&#9972;", "&#x263a;", "&#x2708;", "&#x2655;", "&#x1F600;", "&#x1F602;", "&#x1F60A;", "&#x1F60D;", "&#x1F638;", "&#x1F639;", "&#x1F63A;", "&#x1F63B;", "&#x1F64B;", "&#x1F64C;"];
function hidePrise() {
    let p = document.getElementById("prise");
    if (p) {
        p.classList.add("hide");
    }
}
function showPrise() {
    var element = document.getElementById("prise");
    if (element) {
        element.classList.remove("hide");
        element.innerHTML = praise[Math.floor(Math.random() * praise.length)];
    } else {
        element = document.createElement("div");
        element.setAttribute("id", "prise");
        element.style.position = "absolute";
        element.style.fontWeight = "900";
        element.style.fontSize = "xx-large";
        element.innerHTML = praise[Math.floor(Math.random() * praise.length)];
        document.body.appendChild(element);
    }
    var rect = getRect(element);
    element.style.left = "" + Math.floor((window.innerWidth - rect.w)/2) + "px";
    element.style.top = "" + Math.floor((window.innerHeight - rect.h)/2) + "px";
}
function printWord(prefix, element, w, wid, lng, col, callback) {
    var isPicture = w.startsWith("img:");

    element.setAttribute("onclick", "wordClicked(this)");
    element.setAttribute("id", getIdPrefix(prefix)+wid);
    element.setAttribute("lang", lng);
    if (wid in wordrate) {
        element.setAttribute("title", wordrate[wid]);
    } else {
        element.setAttribute("title", "0");
    }

    if (!isPicture) {
        element.innerHTML = w;
    }
    element.style.color = col;
    element.style.position = "absolute";
    moveDiv(element);
    element.style.fontWeight = "900";
    if (window.innerWidth < 481 || window.innerHeight < 481) {
        element.style.fontSize = "small";
    } else {
        element.style.fontSize = "xx-large";
    }
    element.style.border = '1px solid #cfcfc6';
    element.classList.add("lword");
    element.classList.add("lword"+lng);
    element.classList.add("id"+wid);
    document.body.appendChild(element);
    moveDiv(element, {x: "0px", y: "0px"});

    if (isPicture) {
        var img=document.createElement("img");
        img.onload = function(){
            moveDiv(element);
            //console.log("iiiiiiii>", getRect(element));
            if (callback) {
                callback();
            }
        };
        img.src=w.substring(4);
        if (window.innerWidth < 481 || window.innerHeight < 481) {
            img.style.maxHeight = "40px";
        }
        element.appendChild(img);
    } else {
        moveDiv(element);
        if (callback) {
            callback();
        }
    }
}
function getRect(p) {
    var ret = {};
    ret.X1 = p.offsetLeft;
    ret.Y1 = p.offsetTop;
    ret.w = p.style.width;
    ret.h = p.style.height;
    ret.X2 = p.offsetWidth + ret.X1;
    ret.Y2 = p.offsetHeight + ret.Y1;
    return ret;
}
function hasOverlap(arr, p) {
    var RectA = getRect(p);
    return arr.some(function(e, i, a){
        var RectB = getRect(e);
        var isOk = (Math.max(RectA.X1, RectB.X1) < Math.min(RectA.X2, RectB.X2) && Math.max(RectA.Y1, RectB.Y1) < Math.min(RectA.Y2, RectB.Y2));
        //console.log(">>>>>>", isOk, RectA, RectB, p.id, e.id);
        if (isOk) {
            return true;
        }
        return false;
    });
}
var yWordOffset = 21;
function moveDiv(element, pnt) {
    var xWordWidth = 150;
    if (pnt) {
        element.style.left = pnt.x;
        element.style.top = pnt.y;
    } else {
        var rect = getRect(element);
        let xw = xWordWidth;
        if (window.innerWidth < 481 || window.innerHeight < 481) {
            xw = 50;
        }        
        element.style.left = "" + Math.floor((Math.random() * (window.innerWidth-Math.max(xw, rect.w))) + 1) + "px";
        element.style.top = "" + Math.floor((Math.random() * (window.innerHeight-yWordOffset*1.5 - rect.h - 1)) + yWordOffset) + "px";
    }
}

function startGame(startCurrent) {
    if (startCurrent) {
        if (startAgain) {
            loadSettings(currentSettings);
        } else {
            alert("THE END");
        }
    } else {
        var text = "red,крАсный,красноватый|plum,сливовый|img:zzz1.png,тест<sup>x</sup><sub>y</sub>";
        //text="4,2x2|9,3x3|16,4x4,2x8,8x2|25,5x5|36,6x6,9x4,4x9|49,7x7|64,8x8|81,9x9|6,2x3,3x2|8,4x2,2x4|10,5x2,2x5|12,6x2,2x6,3x4,4x3|18,2x9,9x2,6x3,3x6|15,3x5,5x3";
        //text = "<delimeter>|</delimeter>red|красный|plum|сливовый|img:zzz1.png|тест<sup>x</sup><sub>y</sub>";
        //text = "A,эй,B,би,C,си,D,ди,E,и,F,эф,G,джи,H,эйч,I,ай,J,джей,K,кей,L,эл,M,эм,N,эн,O,оу,P,пи,Q,кью,R,а,S,эс,T,ти,U,ю,V,ви,W,дабл ю,X,экс,Y,вай,Z,зет";
        loadWors(text, ",");
    }
}
function clearWords() {
    wordsid = [];
    wordrate = {};
    document.querySelectorAll(".lword").forEach(function(e){
        document.body.removeChild(e);
    });

    let p = document.getElementById("controls");
    yWordOffset = p.offsetHeight + p.offsetTop;
    //console.log("????????????", yWordOffset);
}
function loadWors(text, splitter) {
// <lang1></lang2><lang2></lang2>
    startAgain = false;
    hidePrise();
    let otherDelimeter = false;
    let sidx1 = text.indexOf("<delimeter>");
    let sidx2 = text.indexOf("</delimeter>");
    if (sidx1>=0 && sidx2>=0 && sidx1<sidx2) {
        otherDelimeter = true;
        splitter=text.substring(sidx1 + "<delimeter>".length, sidx2);
        text=text.substring(sidx2+"</delimeter>".length);
    }
    clearWords();

    let wordDivs = [];
    let words = [];
    let other = [];
    if (text.indexOf("|") < 0) {
        otherDelimeter = true;
    }

    if (otherDelimeter) {
        let wordsTemp = text.split(splitter);
        for (let k = 0; k+1 < wordsTemp.length; k+=2) {
            let eId = k/2 + 1;
            words.push({ en: wordsTemp[k].trim(), ru : wordsTemp[k+1].trim(), id : eId});
        }
    } else {
        let wordsTemp1 = text.split("|");
        let eId = 1;
        wordsTemp1.forEach(function(e) {
            let wordsTemp = e.split(splitter);
            if (wordsTemp.length > 1) {
                let w = { en: wordsTemp[0].trim(), ru: wordsTemp[1].trim() , id : eId};
                eId++;
                for(let j = 2; j < wordsTemp.length; j++) {
                    w[("ru"+(j-1))] = wordsTemp[j].trim();
                }
                words.push(w);
            }
        });
    }
    
    if (words.length > 0) addWord(words[0], wordDivs, wordsid, other, words, 1, function(){
        currentSettings = makeSettings();
    });
}
function addWord(e, wordDivs, wordsid, other, arr, idx, callback) {
// TODO on end loading
    if (other && e.id in wordrate && wordrate[e.id] > 5) {
        other.push(e);
        nextWord(e, wordDivs, wordsid, other, arr, idx, callback);
    } else {
        wordsid.push(e);
        if (!other && wordsid.length >= 10) {
            for(; idx < arr.length; idx++) {
                wordsid.push(arr[idx]);
            }
            return;
        }
        
        var eww = [];
        eww.push(document.createElement("div"));
        eww.push(document.createElement("div"));
        
        for (let m = 1; m < 10; m++) {
            let k = "ru" + m;
            if (k in e) {
                eww.push(document.createElement("div"));
            } else {
                break;
            }
        }
        
        var onAdd = function() {
            var cnt = true;
            eww.forEach(function(e) {
                if (cnt && tryToPlace(wordDivs, e)) {
                    wordDivs.push(e);
                } else {
                    cnt = false;
                }
            });
            
            if(!cnt) {
                eww.forEach(function(p) {
                    try {
                        document.body.removeChild(p);
                    } catch (e) {
                        console.log(e);
                    }
                });
            }
            
            if (cnt) {
                nextWord(e, wordDivs, wordsid, other, arr, idx, callback);
            } else {
                if (other) {
                    other.forEach(function(el) {
                        wordsid.push(el);
                    });
                }
                countRates();
                if (callback) {
                    callback();
                }
            }
        };
        printWord(0, eww[0], e.en, e.id, "en", "red", function() {
            printWords(e, eww, 1, onAdd);
        });
    }    
}
function countRates() {
    var allRate = 0,
        minRate,
        maxRate;
    let j = 0;
    for (let i in wordrate) {
        if (minRate === undefined) {
            minRate = wordrate[i];
        } else {
            minRate = Math.min(minRate, wordrate[i]);
        }
        if (maxRate === undefined) {
            maxRate = wordrate[i];
        } else {
            maxRate = Math.max(maxRate, wordrate[i]);
        }
        allRate += wordrate[i];
        j++;
    }
    if (j != 0) {
        allRate = allRate / j;
    }
    document.getElementById('allRate').innerHTML = "Rate:" + allRate + ", Max:" + maxRate + ", Min:" + minRate;
}
function nextWord(e, wordDivs, wordsid, other, arr, idx, callback) {
    if (idx < arr.length) {
        addWord(arr[idx], wordDivs, wordsid, other, arr, idx+1, callback);
    } else {
        if (other) {
            if (wordsid.length < 10 && other.length > 0) {
                shuffle(other);
                addWord(other[0], wordDivs, wordsid, null, other, 1, callback);
            } else {
                other.forEach(function(el) {
                    wordsid.push(el);
                });
                countRates();
                if (callback) {
                    callback();
                }
            }
        } else {
            countRates();
            if (callback) {
                callback();
            }
        }
    }
}

function printWords(e, eww, idx, onAdd) {
    if (idx < eww.length) {
        let pfix = "";
        if (idx > 1) {
            pfix = "" + (idx - 1);
        }
        printWord(idx, eww[idx], e["ru" + pfix], e.id, "ru", "blue", function () {
            printWords(e, eww, idx+1, onAdd);
        });
    } else {
        onAdd();
    }
}

function tryToPlace(wordDivs, ew) {
    let j = 1;
    let isover = hasOverlap(wordDivs, ew);
    while(isover && j < 100) {
        moveDiv(ew);
        isover = hasOverlap(wordDivs, ew);
        j=j+1;
    }
    
    if (j >= 100) return false;
    
    return true;
}

function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
}
</script>

<div id="controls" class="control">
<form class="inline" style="border: double;">
<input type="file" id="files" name="files[]" />
<button type="reset" value="Reset">x</button>
</form>
<div class="inline" id="allRate">Rate:</div>
<br>
<div class="inline">User: <input type="text" id="uname" name="uname" size="10"/></div>
<div class="inline">Theme: <input type="text" id="theme" name="theme" size="12" /></div>
<input type="button" onclick="saveSettings()" value="Save"/>
<input type="button" onclick="startGame(true)" value="Start"/>
</div>

<script>
    function handleFileSelect(evt) {
        if (window.File && window.FileReader && window.FileList && window.Blob) {

        } else {
            alert('The File APIs are not fully supported in this browser.');
            return;
        }

        var files = evt.target.files;

        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
            var reader = new FileReader();
            var themename = f.name;
            var pntidx = themename.indexOf(".");
            if (pntidx >= 0) {
                themename = themename.substring(0, pntidx);
            }
            reader.readAsText (f);
            reader.onload = function(e) {
                var text = reader.result;
                try {
                    var cfg = JSON.parse(text);
                    loadSettings(cfg);
                } catch (e) {
                    document.getElementById('theme').value = themename;

                    console.log("parse json error");
                    loadWors(text, ",");
                }
            };
        }
    }

    document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>

<script>
startGame();
</script>
</body>
</html>
