<!DOCTYPE html>
<html>
<meta charset="UTF-8">

  <style type="text/css">
   .lastClicked { 
     color: green !important;
     border-radius: 9px;
     border: 3px solid green !important;
   }
.noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.showword {
    background-color: yellow;
}
  </style>

<body class="noselect">

<script>
var utterance = new Array();
utterance["en"] = new SpeechSynthesisUtterance();
utterance["en"].lang = 'en-UK';
utterance["en"].rate = 1;

/*
utterance["ru"] = new SpeechSynthesisUtterance();
utterance["ru"].lang = 'ru-Ru';
utterance["ru"].rate = 1;
*/
utterance["ru"] = null;

var lastClicked = null;
var wordrate = {};
var wordsid = [];

function saveAs(data, filename) {
    var blob = new Blob([data], {type: "text/plain;charset=utf-8"});
    if (window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveBlob(blob, filename);
    } else {
        var elem = window.document.createElement('a');
        elem.href = window.URL.createObjectURL(blob);
        elem.download = filename;        
        document.body.appendChild(elem);
        elem.click();        
        document.body.removeChild(elem);
    }
}

function saveSettings() {
    var uname = document.getElementById('uname').value;
    if (! (uname && uname.trim().length > 0)) {
        alert("No user name");
        return;
    }
    var settings = { words : [], wordrate : {} };
    var uname = document.getElementById('uname').value;
    if (uname) {
        settings.uname = uname.trim();
    }

    settings.words = wordsid;
    settings.wordrate = wordrate;
    var text = JSON.stringify( settings );
    var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    var todayDate = new Date().toISOString().replace(/[T\.Z]/g, "_");
    var filenameUname = uname;
    //var filenameUname = uname.replace(/[^a-zA-Z0-9_-а-яА-Я]/gi, '_').toLowerCase();
    saveAs(blob, "configData"+filenameUname+todayDate+".json");
    return settings;
}

function loadSettings(cfg) { 

    if ("words" in cfg) {
        clearWords();
    	document.getElementById('uname').value = "";
        if ("uname" in cfg) {
            document.getElementById('uname').value = cfg.uname;
        }

        var wid = [];
        var wordDivs = [];
        var other = [];

        if ("wordrate" in cfg) {
            wordrate = cfg.wordrate;
        } else {
            wordrate = {};
        }

        cfg.words.sort(function(a, b){
            var awr = 0;
            var bwr = 0;
            if (a.id in wordrate) {
                awr = wordrate[a.id];
            }
            if (b.id in wordrate) {
                bwr = wordrate[b.id];
            }
            return (awr < bwr);
	}).some(function(e){
            wid.push(e);
            if ("en" in e && "ru" in e && "id" in e) {
                return !addWord(e.en, e.ru, e.id, wordDivs, wordsid, other);
            } else {
                return false;
            }
        });
        var curcnt = document.querySelectorAll(".lword").length;
        if (curcnt < 10) {
            other.some(function(e){ 
                curcnt ++;
                addWord(e.en, e.ru, e.id, wordDivs, wordsid, null);
                return (curcnt >= 10);
            });
        }

        wordsid = wid;
    } else {
        alert("Wrong settings");
    }
}

function wordClicked(p) {
    var uname = document.getElementById('uname').value;
    if (! (uname && uname.trim().length > 0)) {
        alert("No user name");
        return;
    }
    if (lastClicked) {
        lastClicked.obj.classList.remove("lastClicked");
        var lc = lastClicked.obj;
        let w1id = p.id.substring(p.lang.length);
        let w2id = lc.id.substring(lc.lang.length);
        if(lc === p) {
            lastClicked.cnt = lastClicked.cnt + 1;
            let lccnt = lastClicked.cnt;

            if (lccnt > 2) {
                var showwords = document.querySelectorAll(".id" + w2id);
                showwords.forEach(function(e){
		    e.classList.add("showword");
                });
                setTimeout(function(){
                    showwords.forEach(function(e){
                        e.classList.remove("showword");
		    });
                }, 3000);
            } else {
                if (w1id in wordrate) {
                    var w1 = wordrate[w1id];
                    wordrate[w1id] = w1-1;
                } else {
                    wordrate[w1id] = -1;
                }
            }

            if (utterance[p.lang]) {
                utterance[p.lang].text = p.innerHTML;
                speechSynthesis.speak(utterance[p.lang]);
            }
            p.setAttribute("title", "" + wordrate[w1id]);
            lastClicked.obj.classList.add("lastClicked");
            return;
        }

        if (p.lang != lc.lang) {
            if (w1id === w2id) {
                setTimeout(function(){
                    document.body.removeChild(p);
                    document.body.removeChild(lc);
                    placedWords = document.querySelectorAll(".lword").length;
                    if (placedWords <= 0) {
                        var startAgain = false;
                        for (k in wordrate) {
                            if (wordrate[k] <= 5) {
                                startAgain = true;
                                break;
                            }
                        }
			var cfg = saveSettings();
                        if (startAgain) {
                            loadSettings(cfg);
                        } else {
                            alert("THE END");
                        }
                    }
                }, 500);
                lastClicked = null;

                if (w1id in wordrate) {
                    var w1 = wordrate[w1id];
                    wordrate[w1id] = w1+1;
                } else {
                    wordrate[w1id] = 1;
                }
            } else {
                lastClicked = null;
                if (w1id in wordrate) {
                    var w1 = wordrate[w1id];
                    wordrate[w1id] = w1-1;
                } else {
                    wordrate[w1id] = -1;
                }
                if (w2id in wordrate) {
                    var w2 = wordrate[w2id];
                    wordrate[w2id] = w2-1;
                } else {
                    wordrate[w2id] = -1;
                }
                p.setAttribute("title", "" + wordrate[w1id]);
                lc.setAttribute("title", "" + wordrate[w2id]);
            }
        } else {
            lastClicked = {obj : p, cnt : 1};
        }
    } else {
        lastClicked = {obj : p, cnt : 1};
    }
    if (lastClicked) {
        lastClicked.obj.classList.add("lastClicked");
    }
}
function printWord(w, wid, lng, col) {
    var isPicture = w.startsWith("img:");

    var element = document.createElement("div");
    element.setAttribute("onclick", "wordClicked(this)");
    element.setAttribute("id", lng+wid);
    element.setAttribute("lang", lng);
    if (wid in wordrate) {
        element.setAttribute("title", wordrate[wid]);
    } else {
        element.setAttribute("title", "0");
    }

    if (!isPicture) {
        element.innerHTML = w;
    }
    element.style.color = col;
    element.style.position = "absolute";
    moveDiv(element);
    element.style.fontWeight = "900";
    element.style.fontSize = "xx-large";
    element.style.border = '1px solid #cfcfc6';
    element.classList.add("lword");
    element.classList.add("id"+wid);
    document.body.appendChild(element);

    if (isPicture) {
        var img=document.createElement("img");
        img.src=w.substring(4);
        element.appendChild(img);
    }
    return element;
}
function getRect(p) {
    var ret = {};
    ret.X1 = p.offsetLeft;
    ret.Y1 = p.offsetTop;
    ret.X2 = p.offsetWidth + p.offsetLeft;
    ret.Y2 = p.offsetHeight + p.offsetTop;
    return ret;
}
function hasOverlap(arr, p) {
    var RectA = getRect(p);
    return arr.some(function(e, i, a){
        var RectB = getRect(e);
        var isOk = (Math.max(RectA.X1, RectB.X1) < Math.min(RectA.X2, RectB.X2) && Math.max(RectA.Y1, RectB.Y1) < Math.min(RectA.Y2, RectB.Y2));
        if (isOk) {
            return true;
        }
        return false;
    });
}
function moveDiv(element) {
    element.style.left = "" + Math.floor((Math.random() * (window.innerWidth-150)) + 1) + "px";
    element.style.top = "" + Math.floor((Math.random() * (window.innerHeight-70)) + 21) + "px";
}

function startGame() {
    var text = "red,красный,plum,сливовый,img:zzz1.png,тест";
    //text = "A,эй,B,би,C,си,D,ди,E,и,F,эф,G,джи,H,эйч,I,ай,J,джей,K,кей,L,эл,M,эм,N,эн,O,оу,P,пи,Q,кью,R,а,S,эс,T,ти,U,ю,V,ви,W,дабл ю,X,экс,Y,вай,Z,зет";
    loadWors(text, ",");
}
function clearWords() {
    wordsid = [];
    wordrate = {};
    document.querySelectorAll(".lword").forEach(function(e){
        document.body.removeChild(e);
    });
}
function loadWors(text, splitter) {
    clearWords();

    var wordDivs = [];
    var words = [];
    var other = [];

    var wordsTemp = text.split(splitter);
    for (var k = 0; k+1 < wordsTemp.length; k+=2) {
	words.push([wordsTemp[k].trim(), wordsTemp[k+1].trim()]);
    }
    var i = 0;
    words.some(function(e, idx, a) {
        i++;

        return !addWord(e[0], e[1], i, wordDivs, wordsid, other);
    });
}
function addWord(e0, e1, i, wordDivs, wordsid, other) {
        var cnt = true;
	wordsid.push({ id: i, en: e0, ru: e1 });
        if (other && i in wordrate && wordrate[i] > 5) {
            other.push({ id: i, en: e0, ru: e1 });
            return cnt;
        }

            var ew = printWord(e0, i, "en", "red");
            var rw = printWord(e1, i, "ru", "blue");
            var j = 1;
            var isover = hasOverlap(wordDivs, ew);
            while(isover && j < 100) {
                moveDiv(ew);
                isover = hasOverlap(wordDivs, ew);
                j=j+1;
            }
            if (j >= 100) cnt = false;
            wordDivs.push(ew);
            j = 1;
            isover = hasOverlap(wordDivs, rw);
            while(isover && j < 100) {
                moveDiv(rw);
                isover = hasOverlap(wordDivs, rw);
                j=j+1;
            }
            if (j >= 100) cnt = false;
            wordDivs.push(rw);
    return cnt;
}

</script>

<input type="file" id="files" name="files[]" />
User: <input type="text" id="uname" name="uname" />
<input type="button" onclick="saveSettings()" value="Save"/>

<script>
    function handleFileSelect(evt) {
        if (window.File && window.FileReader && window.FileList && window.Blob) {

        } else {
            alert('The File APIs are not fully supported in this browser.');
            return;
        }

        var files = evt.target.files;

        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
            var reader = new FileReader();
            reader.readAsText (f);
            reader.onload = function(e) {
                var text = reader.result;
                try {
                    var cfg = JSON.parse(text);
                    loadSettings(cfg);
                } catch (e) {
                    console.log("parse json error");
                    loadWors(text, ",");
                }
            };
        }
    }

    document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>

<script>
startGame();
</script>
</body>
</html>
