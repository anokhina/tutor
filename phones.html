<!DOCTYPE html>
<!--
Copyright 2017 Veronica Anokhina.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!--
https://github.com/emacsmirror/addressbook/blob/master/vcard-21.txt
https://www.ietf.org/rfc/rfc2426.txt
https://tools.ietf.org/html/rfc6350
-->
<html>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style type="text/css">
html, body {
    /*height:99%;*/
    width:100%;
}   
body {
    margin: 0px;
}
.inline {
    display: inline-block;
}
.padding {
    padding: 2px;
}  
.photo {
    padding: 5px;
    float: left;
}
.rowbg {
    background-color: #ccc;
}
.rowbgm {
    background-color: #ddd;
}
.rowbgl {
    background-color: #f1f1f1;
}
.right {
    float: right;
}
table {
    border: none;
}
input {
    padding: 0px;
    margin: 0px;
}
textarea { 
    resize:vertical; 
    padding: 0px;
    margin: 0px;    
}
/* Style the tab */
div.tab {
    overflow: hidden;
    border: 1px solid #ccc;
    background-color: #e5e5e5;
}

/* Style the buttons inside the tab */
div.tab button {
    background-color: inherit;
    float: left;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 4px 6px;
    transition: 0.3s;
    font-size: large;
}

/* Change background color of buttons on hover */
div.tab button:hover {
    background-color: #ddd;
}

/* Create an active/current tablink class */
div.tab button.active {
    background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
    display: none;
    padding: 0px;
    border: 1px solid #ccc;
    border-top: none;
    background-color: #f1f1f1;
}

.tcontent {
}

/* Style the close button */
.topright {
    float: right;
    cursor: pointer;
    font-size: large;
    padding: 0px 4px 0px 0px;
}

.topright:hover {color: red;}

#opstatus {
    background-color: #bbb;
}

.controldiv {
    position: fixed;
    width: 100%;
    top: 0;
    z-index: 200;
}
.controlleddiv {
    position: relative;
    top: 50px;
}

  </style>

<body>

<script>
var UTIL = (function(e) {
    var self = {
    };
    
    self.toObject = function (arr) {
        var ret = {};
        for (let i = 0; i < arr.length; ++i) {
            ret[i] = arr[i];
        }
        ret.length = arr.length;
        return ret;
    };
    
    self.namespace = function(ns) {
        var o = this, ts = ns.split("."), t;
        while (ts.length > 0) {
            t = ts.shift();
            if (typeof o[t] === "undefined") { o[t] = {};}
            o = o[t];
        }

        return o;
    };
    
    var __escape = document.createElement('textarea');
    self.escapeHTML = function(html) {
        __escape.textContent = html;
        return __escape.innerHTML;
    }

    self.unescapeHTML = function (html) {
        __escape.innerHTML = html;
        return __escape.textContent;
    }
    
    self.parseDate = function (str) {
        if (str) {
            str = str.trim();
            var d = new Date(str + " UTC"), ds;
            if(/^(\d){8}$/.test(str)) {
                var yy = str.substr(0,4),
                    mm = str.substr(4,2) - 1,
                    dd = str.substr(6,2);
                d = new Date(Date.UTC(yy,mm,dd));
            }
            try {
                return d.toISOString().slice(0,10);
            } catch (e) {
            }
        }
        return null;
    }
    
    self.tokenize = function (s, esc, sep) {
        for (var a=[], t='', i=0, e=s.length; i<e; i++) {
            var c = s.charAt(i);
            if (c == esc) { t+=s.charAt(++i); }
            else if (c != sep) { t+=c }
            else { a.push(t); t=''; }
        }
        a.push(t);
        return a;
    }    
    
    return self;
})();

var CONST_VCARD_N = "N"; 
//is a concatenation of the Family Name (first field), 
//Given Name (second field), 
//Additional Names (third field), 
//Name Prefix (fourth field), 
//and Name Suffix (fifth field) strings.
var CONST_VCARD_N1 = "N1"; //Family Name
var CONST_VCARD_N2 = "N2"; //Given Name
var CONST_VCARD_N3 = "N3"; //Additional Name
var CONST_VCARD_N4 = "N4"; //Name Prefix
var CONST_VCARD_N5 = "N5"; //Name Suffix
var CONST_VCARD_VERSION = "VERSION";
var CONST_VCARD_FN = "FN";
var CONST_VCARD_BDAY = "BDAY";
var CONST_VCARD_TEL = "TEL";
var CONST_VCARD_PHOTO = "PHOTO";
var CONST_VCARD_NOTE = "NOTE";
var CONST_VCARD_ANNIVERSARY = "X-ANNIVERSARY";
var CONST_VCARD_EMAIL = "EMAIL"; //EMAIL;INTERNET:
var CONST_VCARD_ADR = "ADR";
var ADDR_PARTS = [
"Post office box"
,"Extended"
,"Street"
,"City"
,"Region/State"
,"Postal code"
,"Country"
];
var CONST_VCARD_URL = "URL";
var CONST_VCARD_ORG = "ORG";
var CONST_VCARD_PARAM = {}; 

var PARAM_TYPE = {
    N1: "Family Name",
    N2: "Given Name",
    N3: "Additional Name",
    N4: "Name Prefix",
    N5: "Name Suffix"
};
var PLACE_TYPE = sortObj({
    "DOM": "domestic",
    "INTL": "international",
    "POSTAL": "postal",
    "PARCEL": "parcel",
    "HOME": "home",
    "WORK": "work"
});
function sortObj(obj) {
    var tmp = [], ret = {};
    for (var i in obj) {
        tmp.push(i);
    }
    tmp.sort();
    tmp.forEach(function (e) {
        ret[e] = obj[e];
    });
    return ret;
}
var PHONE_TYPE = sortObj({
    "PREF": "preferred",
    "WORK": "work",
    "HOME": "home",
    "VOICE": "voice",
    "FAX": "facsimile (FAX)",
    "MSG": "messaging service",
    "CELL": "cellular",
    "PAGER": "pager",
    "BBS": "bulletin board service",
    "MODEM": "MODEM",
    "CAR": "car-phone",
    "ISDN": "ISDN",
    "VIDEO": "video-phone"
});

CONST_VCARD_PARAM[CONST_VCARD_N] = true;
CONST_VCARD_PARAM[CONST_VCARD_VERSION] = true;
CONST_VCARD_PARAM[CONST_VCARD_FN] = true;
CONST_VCARD_PARAM[CONST_VCARD_BDAY] = true;
CONST_VCARD_PARAM[CONST_VCARD_TEL] = true;
CONST_VCARD_PARAM[CONST_VCARD_PHOTO] = true;
CONST_VCARD_PARAM[CONST_VCARD_NOTE] = true;
CONST_VCARD_PARAM[CONST_VCARD_ANNIVERSARY] = true;
CONST_VCARD_PARAM[CONST_VCARD_EMAIL] = true;
CONST_VCARD_PARAM[CONST_VCARD_ADR] = true;
CONST_VCARD_PARAM[CONST_VCARD_URL] = true;
CONST_VCARD_PARAM[CONST_VCARD_ORG] = true;

function saveAs(data, filename) {
    var blob = new Blob([data], {type: "text/plain;charset=utf-8"});
    if (window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveBlob(blob, filename);
    } else {
        var elem = window.document.createElement('a');
        elem.href = window.URL.createObjectURL(blob);
        elem.download = filename;        
        document.body.appendChild(elem);
        elem.click();        
        document.body.removeChild(elem);
    }
}
function saveObj2FS(obj, filePrefix) {
    console.log(obj, JSON.stringify( obj, null, 2 ));
    var text = JSON.stringify( obj, null, 2 );
    let obj1 = JSON.parse(text);
    obj1.length = obj.length;
    text = JSON.stringify( obj1, null, 2 );
    
    var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    var todayDate = new Date().toISOString().replace(/[T\.Z]/g, "_");
    var filenameUname = "-" + "events" + "-";
    if (filePrefix) {
    } else {
        filePrefix = "exportData";
    }
    saveAs(blob, filePrefix+filenameUname+todayDate+".json");
}
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    if (evt) {
        evt.currentTarget.className += " active";
    }
    window.scrollTo(0, 0);
}
function showStatus(m, o, exc) {
    var now = new Date().toISOString().slice(0,19).replace("T", " ");
    if (!o) {
        o = m;
    }
    var msg = now + ": " + UTIL.escapeHTML(o);
    var msgSh = now + ": " + UTIL.escapeHTML(m);
    var statDiv = document.getElementById('opstatus');
    if (statDiv) {
        statDiv.innerHTML = msgSh;
    }
    var errDiv = document.getElementById('errorDiv');
    if (errDiv) {
        errDiv.innerHTML = msg + "<p>" + errDiv.innerHTML;
    }
    if (exc) {
        console.log(exc);
    }
}
function handleFileSelect(evt) {
    if (window.File && window.FileReader && window.FileList && window.Blob) {

    } else {
        alert('The File APIs are not fully supported in this browser.');
        return;
    }

    var files = evt.target.files;

    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
        var reader = new FileReader();
        reader.readAsText (f);
        reader.onload = function(e) {
            var text = reader.result;
            try {
                importData(text);
            } catch (e) {
                console.log("import error", e);
                showStatus("import error");
            }
        };
    }
}

function importData(text) {
    var CONST_BEGIN = "BEGIN:VCARD", CONST_END="END:VCARD";
    var bv, ev, exists = [];
    bv = text.indexOf(CONST_BEGIN);
    ev = text.indexOf(CONST_END, bv + CONST_BEGIN.length);
    while(bv >=0 && ev >0) {
        importVCard(text.substring(bv + CONST_BEGIN.length, ev), exists, null);
        bv = text.indexOf(CONST_BEGIN, ev + CONST_END.length);
        ev = text.indexOf(CONST_END, bv + CONST_BEGIN.length);
    }
    console.log("------0----", exists.length);
    if (exists.length > 0) {
        saveObj2FS(UTIL.toObject(exists), "importErrorExists");
    }
}
function importVCard(text, exists, callback) {
    var lines = text.split("\n");
    var lastProp = null, obj = {}, robj = {};
    for(let i = 0; i < lines.length; i++) {
        if (lines[i].charAt(0) === ' ') {
            if (lastProp) {
                obj[lastProp] = obj[lastProp] + lines[i];
            }
        } else if (lines[i].charAt(0) === '=' ) {
            if (lastProp) {
                obj[lastProp] = obj[lastProp] + lines[i].substring(1);
            }
        } else {
            let keyVal = lines[i].split(":");
            if (keyVal.length > 1) {
                lastProp = keyVal[0];
                obj[lastProp] = keyVal[1];
            } else {
                lastProp = null;
            }
        }
    }
    var CONST_ENC = ";CHARSET=UTF-8;ENCODING=QUOTED-PRINTABLE";
    for (var k in obj) {
        let idx = k.indexOf(CONST_ENC);
        if (k.startsWith(CONST_VCARD_N)) {
            var arr = obj[k].split(";");
            for (var arri = 0; arri < arr.length; arri++) {
                if (idx > 0) {
                    robj["N" + (arri + 1)] = fromEncodedValue(arr[arri]);
                } else {
                    robj["N" + (arri + 1)] = arr[arri];
                }
            }
        } else {
            if (idx > 0) {
                robj[k.replace(CONST_ENC, "")] = fromEncodedValue(obj[k]);
            } else {
                robj[k] = obj[k];
            }
        }
    }
    //TODO check version
    //CONST_VCARD_PARAM
    obj = {};
    for (var k in robj) {
        var used = false;
        for (var kk in CONST_VCARD_PARAM) {
            if (k.startsWith(kk)) {
                if  (k.startsWith(CONST_VCARD_VERSION)) {} else {
                    obj[k] = robj[k];
                }
                used = true;
                break;
            }
        }
        if (!used) {
            let newk = prompt("Unknown option with value " + robj[k], k);
            //TODO check entered
            if (newk) {
                let newkval =prompt("value for " + newk, robj[k]);
                obj[newk] = newkval;
                k = newk;
            } else if (!confirm("Continue?")) {
                //TODO
                break;
            }
        }
        if (k == CONST_VCARD_BDAY || k == CONST_VCARD_ANNIVERSARY) {
            var ds = UTIL.parseDate(obj[k]);
            var j = 0;
            while(!ds && j < 5) {
                ds = UTIL.parseDate(prompt("wrong value for " + k + " The date to be in YYYY-mm-dd", obj[k]));
                j++;
            }
            if (ds) {
                obj[k] = ds;
            } else {
                showStatus("The import was interrupted because of wrong data");
                return;
            }
        }
    }
    
    console.log(obj);
    addPhone(db, obj, exists, callback);
}
function fromEncodedValue(str) {
    var arr = str.split(";"), ret = "";
    for (let i = 0; i < arr.length; i++) {
        if (i > 0) ret += ";";
        if (arr[i]) {
            ret += fromEncoded(arr[i]);
        }
    }
    return ret;
}
var utf8decoder = new TextDecoder('utf-8');
function fromEncoded(str) {
    var charArr = str.split("=");
    var intArr = [];
    for(let i = 0; i < charArr.length; i++) {
        if (charArr[i]) {
            try {
                intArr.push(parseInt(charArr[i], 16))
            } catch (e) {
                console.log(e);
            }
        } else if (i > 0) {
            intArr.push(0);
        }
    }
    return utf8decoder.decode(new Uint8Array(intArr));
}
</script>
<div class="controldiv">

    <div id="opstatus">Ok</div>

    <div class="tab">
      <button class="tablinks" onclick="openTab(event, 'Find')" id="defaultOpen">Find</button>
      <button class="tablinks" onclick="openTab(event, 'Edit')">Edit</button>
      <button class="tablinks" onclick="openTab(event, 'Import')">Import</button>
      <button class="tablinks" onclick="openTab(event, 'Errors')">Errors</button>
    </div>
</div>
<div class="controlleddiv">
    <div id="Find" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
        <form id="searchForm" onsubmit="showPhones(db, 2); return false;">
            <table border=0 style="width:100%">
                <tr>
                    <td>
                        <input type="submit" value="Log">
                        <!--input type="button" onclick="showPhones(db, 2);" value="Count"/-->
                        <button type="reset" value="Reset" style="float: right;">Reset</button>
                        <div id="countDiv" class="inline" style="padding-left:5px;"></div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table border=0 style="width:100%">
                            <tr><td style="width:1%">Property:</td><td><input type="text" id="feprop" name="feprop" style="width:99%" value="adr%"/></td></tr>
                            <tr><td style="width:1%">Name:</td><td><input type="text" id="fename" name="fename" style="width:99%" value="%"/></td></tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="button" onclick="if(parseInt(document.getElementById('eoffset').value) >= parseInt(document.getElementById('elimit').value)) { document.getElementById('eoffset').value= parseInt(document.getElementById('eoffset').value) - parseInt(document.getElementById('elimit').value);showPhones(db, 2);}" value="&lt;Prev"/>
                        <div class="inline"><div class="inline" style="font-size:small">Limit:</div><input type="text"   id="elimit"  name="elimit"  value="30"          size="4" min="5"  maxlength="3" onchange="document.getElementById('eoffset').step=this.value;" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
                        <div class="inline"><div class="inline" style="font-size:small">Offset:</div><input type="number" id="eoffset" name="eoffset" value="0" step="30" size="6" min="0" maxlength="8"                                                                oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=(this.value   < 0) ? (Math.abs(this.value)) : isNaN(parseInt(this.value)) ? this.min : parseInt(this.value)"/></div>
                        <input type="button" onclick="document.getElementById('eoffset').value = parseInt(document.getElementById('eoffset').value) + parseInt(document.getElementById('elimit').value) ;showPhones(db, 2);" value="Next>"/>
                    </td>
                </tr>
            </table>
        </form>
        </div>
    </div>

    <div id="Edit" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
            <form>
            <input type="button" onclick="newPhone()" value="+ Add"/>
            <input type="button" onclick="savePhone(editPhoneObj)" value="Save"/>
            <input type="button" id="phoneEditorTableReset" value="Reset"/>
            <input type="button" onclick='addPhoneProperty(CONST_VCARD_BDAY, "", true);' value="BDAY"/>
            <input type="button" onclick='addPhoneProperty(CONST_VCARD_ANNIVERSARY, "");' value="X-ANNIVERSARY"/>
            <input type="button" onclick='addPhoneProperty(CONST_VCARD_TEL, "");' value="TEL"/>
            <input type="button" onclick='addPhoneProperty(CONST_VCARD_EMAIL, "", true);' value="EMAIL"/>
            <input type="button" onclick='addPhoneProperty(CONST_VCARD_ADR, ";;;;;;");' value="ADR"/>
            <input type="button" onclick='addPhoneProperty(CONST_VCARD_NOTE, "", true);' value="NOTE"/>
            <input type="button" onclick='addPhoneProperty(CONST_VCARD_PHOTO, "", true);' value="PHOTO"/>
            <table id="phoneEditorTable" width="100%" style="margin-top: .5em;" >
            </table>
            </form>
        </div>
        /////////////////////////////////
    </div>

    <div id="Import" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <div class="tcontent">
        <form id="exportForm">
            <table style="width:100%">
                <tr>
                    <td>
                        Import: <input type="file" id="files" name="files[]" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <button type="reset" value="Reset">Reset</button>
                        <input type="button" onclick="showTables()" value="Log"/>
                    </td>
                </tr>
            </table>
        </form>
        </div>
    </div>

    <div id="Errors" class="tabcontent">
        <span onclick="this.parentElement.style.display='none'" class="topright">x</span>
        <span onclick="document.getElementById('errorDiv').innerHTML='<p>'" class="topright">&empty;&nbsp;</span>
        <div class="tcontent">
        <div id="errorDiv">Ok</div>
        </div>
    </div>

<table id="phoneListTable" width="100%" style="margin-top: .5em;" >
</table>
<div>

<script>
function rowItem (results_rows, i) {
    if ( "item" in results_rows ) {
        return results_rows.item(i);
    } else {
        return results_rows[i];
    }
}
function showPhones(db, isCount, callback) {
    document.getElementById("countDiv").innerHTML = "";
    db.transaction(function (tx) {
        //date(l/1000,'unixepoch','localtime') //sqlite ms to date
        var limit = document.getElementById('elimit').value, 
            offset = document.getElementById('eoffset').value,
            feprop = document.getElementById('feprop').value,
            fename = document.getElementById('fename').value;
        var sqlparam = [limit, offset];
        var sqlparamCount = [];
        var sql = 
            "SELECT t1.name, t2.id, t2.cardid, t2.prop, t2.pval FROM idphone t1, phoneProp t2 WHERE t1.id=t2.cardid "+
            " AND t1.id IN ( SELECT id FROM idphone ORDER BY name LIMIT ? OFFSET ?) ORDER BY t1.name";
        var sqlCount = "SELECT count(id) AS cnt FROM idphone";
            "SELECT t1.name, t2.id, t2.cardid, t2.prop, t2.pval FROM idphone t1, phoneProp t2 WHERE t1.id=t2.cardid "+
            " AND t1.id IN ( SELECT id FROM idphone ORDER BY name LIMIT ? OFFSET ?) ORDER BY t1.name";
        if (fename) {
            if (feprop) {
                sqlparam = [feprop, fename, limit, offset];
                sqlparamCount = [feprop, fename];
                sql = 
                    "SELECT t1.name, t2.id, t2.cardid, t2.prop, t2.pval FROM idphone t1, phoneProp t2 WHERE t1.id=t2.cardid "+
                    " AND t1.id IN ( SELECT id FROM idphone WHERE id IN (SELECT cardid FROM phoneProp WHERE prop LIKE ? AND pval LIKE ? GROUP BY cardid) ORDER BY name LIMIT ? OFFSET ?) " +
                    " ORDER BY t1.name";
                sqlCount = "SELECT count(*)  AS cnt FROM (SELECT cardid FROM phoneProp WHERE prop LIKE ? AND pval LIKE ? GROUP BY cardid)";
            } else {
                sqlparam = [fename, limit, offset];
                sqlparamCount = [fename];
                sql = 
                    "SELECT t1.name, t2.id, t2.cardid, t2.prop, t2.pval FROM idphone t1, phoneProp t2 WHERE t1.id=t2.cardid "+
                    " AND t1.id IN ( SELECT id FROM idphone WHERE id IN (SELECT cardid FROM phoneProp WHERE pval LIKE ? GROUP BY cardid) ORDER BY name LIMIT ? OFFSET ?) " +
                    " ORDER BY t1.name";
                sqlCount = "SELECT count(*) AS cnt FROM (SELECT cardid FROM phoneProp WHERE pval LIKE ? GROUP BY cardid)";
            }
        }
        console.log(sqlCount, sqlparamCount);
        if (isCount) {
            tx.executeSql(sqlCount, sqlparamCount, 
                function (tx, results) {
                    var rowIt = rowItem(results.rows,0);
                    document.getElementById("countDiv").innerHTML = rowIt["cnt"];
                },
                function(err) { 
                    //console.log(err);
                    showStatus("Error");
                }
            );
        }
        if (!isCount || isCount && isCount == 2) {
            tx.executeSql(sql, sqlparam, 
                function (tx, results) {
                    if (callback) {
                        callback(results.rows);
                    } else {
                        fillTable(fillList(results.rows));
                        //fillTable(results.rows);
                    }
                },
                function(err) { 
                    //console.log(err);
                    showStatus("Error");
                }
            );
        }
    });
}
function fillList(results_rows) {
    var len = results_rows.length;
                
    //ename, ememo, id, elen, pdate, edate, dlen
    //1.name, t2.id, t2.cardid, t2.prop, t2.pval
    var columnNames = {id: "", cardid: "", name: "", prop: "", pval: ""};
    var trow = 0;
    var row;
    var ret = {};
    ret._order = [];
    for (var i = 0; i < len; i++) {
        var rowIt = rowItem(results_rows,i);
        var cardid = rowIt["cardid"],
            id = rowIt["id"],
            name = rowIt["name"],
            prop = rowIt["prop"],
            propGrp = prop,
            pval = rowIt["pval"];
        var smIdx = prop.indexOf(";");
        if (smIdx > 0) {
            propGrp = prop.substring(0, smIdx);
        }
        
        var obj = {};
        if (cardid in ret) {
            obj = ret[cardid];
        } else {
            ret[cardid] = obj;
            obj["cardid"] = cardid;
            obj["name"] = name;
            obj["props"] = {};
            ret._order.push(obj);
        }
        if (propGrp in obj["props"]) {
        } else {
            obj["props"][propGrp] = [];
        }
        obj["props"][propGrp].push({id: id, prop:prop, pval:pval});
    }
    console.log(ret);
    return ret;
}
function newPhone() {
    editPhone({
        cardid: null,
        name: "",
        props: {
            FN: [{id: null, prop: "FN", pval: ""}],
            N1: [{id: null, prop: "N1", pval: ""}],
            N2: [{id: null, prop: "N2", pval: ""}],
            N3: [{id: null, prop: "N3", pval: ""}],
            N4: [{id: null, prop: "N4", pval: ""}],
            N5: [{id: null, prop: "N5", pval: ""}],
            TEL: [{id: null, prop: "TEL", pval: ""}]
        }
    });
}
function addPhoneProperty(propName, defVal, ifNotExist) {
    if (editPhoneObj) {
        if (propName in editPhoneObj.props) {} else {
            editPhoneObj.props[propName] = [];
        }
        editPhoneObj.props[propName].push({id: null, prop:propName, pval:defVal});
        _editPhone(editPhoneObj);
    }
}
var editPhoneObj;
function editPhone(rowIt) {
    document.getElementById("phoneEditorTableReset").setAttribute("onclick", "editPhone("+JSON.stringify(rowIt)+");")
    _editPhone(rowIt);
}
function _editPhone(rowIt) {
    editPhoneObj = rowIt;
    
    console.log(rowIt);
    //phoneEditorTable
    var table = document.getElementById("phoneEditorTable");
    while(table.rows.length > 0) {
        table.deleteRow(0);
    }
    var trow = 0, j, row, cell;

    {
        row = table.insertRow(trow++);
        j = 0;
        {
            cell = row.insertCell(j);
            cell.colSpan = 1;
            j++;
            var element = document.createElement("div");
            element.classList.add("inline");
            //element.setAttribute("id", wid);
            cell.appendChild(element);
            element.innerHTML = UTIL.escapeHTML("id");
            cell.style.width = "1%";
        }
        {
            cell = row.insertCell(j);
            cell.colSpan = 2;
            j++;
            var element = document.createElement("div");
            element.classList.add("inline");
            //element.setAttribute("id", wid);
            cell.appendChild(element);
            element.innerHTML = UTIL.escapeHTML("name");
        }
    }
        row = table.insertRow(trow++);
        j = 0;
        {
            cell = row.insertCell(j);
            cell.colSpan = 1;
            j++;
            var element = document.createElement("div");
            element.classList.add("inline");
            //element.setAttribute("id", wid);
            cell.appendChild(element);
            element.innerHTML = UTIL.escapeHTML(rowIt["cardid"]);
            
            element = document.createElement("input");
            element.setAttribute('type', 'button');
            element.onclick = function () {
                alert("zzzzz");
            };
            element.value = "x";
            element.setAttribute("title", "Delete");
            cell.appendChild(element);
            cell.style.width = "1%";
        }
        {
            cell = row.insertCell(j);
            var nameCell = cell;
            cell.colSpan = 2;
            j++;
            var element = document.createElement("input");
            element.setAttribute('type', 'text');
            cell.appendChild(element);
            element.value = rowIt["name"];
            element.style.width = "100%";
            var rowItNameElement = element;
        }
        
        for (var pr in rowIt.props) {
            
            for (var k = 0; k < rowIt.props[pr].length; k++) {
                var elm = rowIt.props[pr][k];
                if (elm["_delete"]) continue;
                if (elm["prop"].startsWith("PHOTO")) {
                    {
                        var img = document.createElement("img");
                        img.src = "data:image/jpeg;base64," + elm["pval"];
                        
                        //nameCell.appendChild(img);
                        nameCell.insertBefore(img, nameCell.firstChild);
                        img.classList.add("photo");
                        //load file
                    }
                } else {
                    row = table.insertRow(trow++);
                    j = 0;
                
                    var propName = elm["prop"];
                    ["id", "prop"].forEach(function (el) {
                        cell = row.insertCell(j);
                        cell.colSpan = 1;
                        j++;
                        var element = document.createElement("div");
                        element.classList.add("inline");
                        //element.setAttribute("id", wid);
                        cell.appendChild(element);
                        if (el == "id") {
                            cell.style.width = "1%";
                            element.classList.add("right");
                            
                            if (elm["prop"] == "N" 
                                || elm["prop"] == "N1" 
                                || elm["prop"] == "N2" 
                                || elm["prop"] == "N3" 
                                || elm["prop"] == "N4" 
                                || elm["prop"] == "N5" 
                                || elm["prop"] == "FN") {
                            
                            } else {
                                element = document.createElement("input");
                                element.setAttribute('type', 'button');

                                var rowDel = row, rowId = elm["id"];
                                var belem = rowIt.props[pr][k];
                                element.onclick = function () {
                                    table.deleteRow(rowDel.rowIndex);
                                    belem._delete = true;
                                    console.log(rowIt);
                                };
                                element.value = "x";
                                element.setAttribute("title", "Delete");
                                cell.appendChild(element);
                            }
                        } else { 
                            //if (el == "prop") {
                            cell.style.width = "30%";

                            var multiSelect = function(propName, elem, typeObj, rowIt) {
                                var propValue = elem["prop"], idLine = elem["id"];
                                element.innerHTML = propName;
                                var propParams = {};
                                propValue.split(";").forEach(function(e){
                                    if (propName == e) {} else {
                                        propParams[e] = 1; //to edit with text field
                                    }
                                });
                       
                                for (var e in typeObj) {
                                    var div = document.createElement('div');
                                    div.classList.add("inline");
                                    cell.appendChild(div);
                                    
                                    var checkbox = document.createElement('input');
                                    checkbox.type = "checkbox";
                                    checkbox.name = "ch" + idLine;
                                    checkbox.value = e;
                                    (function(checkbox, propParams, propName, elem, rowIt){
                                        checkbox.onchange = function(e) {
                                            if (e.target.checked) {
                                                propParams[e.target.value] = 2;
                                            } else {
                                                propParams[e.target.value] = 0;
                                            }
                                            elem["prop"] = propName;
                                            for (var ei in propParams) {
                                                if (propParams[ei] > 0) {
                                                    elem["prop"] += (";" + ei);
                                                }
                                            }
                                            console.log(propParams, elem["prop"], rowIt);
                                        };
                                    })(checkbox, propParams, propName, elem, rowIt);
                                    if (e in propParams && propParams[e]) {
                                        checkbox.checked = true; 
                                        propParams[e] = 2;
                                    }
                                    div.appendChild(checkbox);
                                    div.appendChild(document.createTextNode(typeObj[e]));
                                }
                            };
                            
                            if (
                                elm["prop"] == "N1" 
                                || elm["prop"] == "N2" 
                                || elm["prop"] == "N3" 
                                || elm["prop"] == "N4" 
                                || elm["prop"] == "N5" 
                                ) {
                            
                                element.innerHTML = UTIL.escapeHTML(elm[el]) + " " + PARAM_TYPE[elm[el]];
                            } else if (elm["prop"].startsWith(CONST_VCARD_TEL)) {
                                multiSelect(CONST_VCARD_TEL, elm, PHONE_TYPE, rowIt);
                            } else if (elm["prop"].startsWith(CONST_VCARD_ADR)) {
                                multiSelect(CONST_VCARD_ADR, elm, PLACE_TYPE, rowIt);
                            } else if (elm["prop"].startsWith(CONST_VCARD_EMAIL)) {
                                multiSelect(CONST_VCARD_EMAIL, elm, PLACE_TYPE, rowIt);
                            } else {
                                element.innerHTML = UTIL.escapeHTML(elm[el]);
                            }
                        }
                        
                        cell.classList.add("rowbgm");
                    });
                    ["pval"].forEach(function(el) {
                        cell = row.insertCell(j);
                        cell.colSpan = 1;
                        j++;

                        (function(element) {
                            console.log(el, propName);
                        if (propName == CONST_VCARD_NOTE) {
                            element = document.createElement("textarea");
                            element.style.width = "100%";
                            element.value = elm[el];
                        } else if (propName == CONST_VCARD_ANNIVERSARY || propName == CONST_VCARD_BDAY) {
                            element = document.createElement("input");
                            element.setAttribute('type', 'text');
                            var ds = UTIL.parseDate(elm[el]);
                            if (ds) {
                                element.setAttribute('type', 'date');
                                element.value = ds;
                            } else {
                                if (!elm[el]) {
                                    element.setAttribute('type', 'date');
                                }
                                element.value = elm[el];
                            }
                        } else if (propName.startsWith(CONST_VCARD_ADR)) {
                            element = document.createElement("table");
                            element.style.width = "100%";
                            var addrtoken = UTIL.tokenize(elm[el], '\\', ';');
                            for (var i = 0; i < ADDR_PARTS.length; i++) {
                                var r = element.insertRow(i);
                                var c = r.insertCell(0);
                                c.classList.add("rowbgm");
                                c.style.width = "1%";
                                var elt = document.createElement("input");
                                elt.setAttribute('type', 'text');
                                if (i < addrtoken.length) {
                                    elt.value = addrtoken[i]; 
                                }
                                
                                c.appendChild(document.createTextNode(ADDR_PARTS[i]));
                                c = r.insertCell(1);
                                c.appendChild(elt);
                                elt.style.width = "100%";
                                (function(element, rowIt, pr, k, el, i) {
                                    element.onchange = function(e) {
                                        var addrtoken = UTIL.tokenize(rowIt.props[pr][k][el], '\\', ';');
                                        var newval = "";
                                        for(var ii = 0; ii < addrtoken.length; ii++) {
                                            if (ii > 0) {
                                                newval = newval + ";";
                                            }
                                            if (ii == i) {
                                                newval = newval + element.value.replace(";", "\\;");
                                            } else {
                                                newval = newval + addrtoken[ii].replace(";", "\\;");
                                            }
                                        }
                                        rowIt.props[pr][k][el] = newval;
                                    };
                                })(elt, rowIt, pr, k, el, i);
                            }
                            cell.appendChild(element);
                            element.style.width = "100%";
                            element = null;
                        } else if (propName == CONST_VCARD_PHOTO) { //TODO
//////////////////////////////         
               
                        } else {
                            element = document.createElement("input");
                            element.setAttribute('type', 'text');
                            element.value = elm[el];
                            element.style.width = "100%";
                        }
                        if (element) {
                            cell.appendChild(element);
                            
                            (function(element, rowIt, bpr, bk, bel) {
                                rowIt.props[bpr][bk]._bind = element;
                                element.onchange = function (e) {
                                    rowIt.props[bpr][bk][bel] = e.target.value;
                                    if (
                                        bpr == "N1" 
                                        || bpr == "N2" 
                                        || bpr == "N3" 
                                        || bpr == "N4" 
                                        || bpr == "N5" 
                                    ) {
                                        var n1 = rowIt.props["N1"][0][bel],
                                            n2 = rowIt.props["N2"][0][bel],
                                            n3 = rowIt.props["N3"][0][bel], 
                                            n4 = rowIt.props["N4"][0][bel], 
                                            n5 = rowIt.props["N5"][0][bel];
                                            
                                        rowIt.name = "";
                                        if (n1) {
                                            rowIt.name += (n1 + " ");
                                        }
                                        if (n2) {
                                            rowIt.name += (n2 + " ");
                                        }
                                        if (n3) {
                                            rowIt.name += n3;
                                        }
                                        
                                        rowIt.name = rowIt.name.trim();
                                        rowIt.props["FN"][0][bel] = "";
                                        if (n4) {
                                            rowIt.props["FN"][0][bel] += (n4 + " ");
                                        }
                                        if (rowIt.name) {
                                            rowIt.props["FN"][0][bel] += (rowIt.name + " ");
                                        }
                                        if (n5) {
                                            rowIt.props["FN"][0][bel] += n5;
                                        }
                                        rowIt.props["FN"][0][bel] = rowIt.props["FN"][0][bel].trim();
                                        rowIt.props["FN"][0]._bind.value = rowIt.props["FN"][0][bel];
                                        
                                        rowItNameElement.value = rowIt.name;
                                        rowIt.props["FN"][0]._bind.value = rowIt.props["FN"][0][bel];
                                    }
                                    console.log(rowIt,bpr,bk,bel);
                                };
                            })(element, rowIt, pr, k, el);
                        }
                        })();
                    });
                }
            }
        }
    
    openTab(null, "Edit");
}
function fillTable(results_rows) {
    var len = results_rows._order.length;
                
    var table = document.getElementById("phoneListTable");
    while(table.rows.length > 0) {
        table.deleteRow(0);
    }

    //1.name, t2.id, t2.cardid, t2.prop, t2.pval
    var columnNames = {cardid: "", name: "", id: "", prop: "", pval: ""};
    
    var trow = 0, j, row, cell;

    {
        row = table.insertRow(trow++);
        row.classList.add("rowbg");
        j = 0;
        {
            cell = row.insertCell(j);
            cell.colSpan = 1;
            j++;
            var element = document.createElement("div");
            element.classList.add("inline");
            //element.setAttribute("id", wid);
            cell.appendChild(element);
            element.innerHTML = UTIL.escapeHTML("id");
            cell.style.width = "1%";
        }
        {
            cell = row.insertCell(j);
            cell.colSpan = 2;
            j++;
            var element = document.createElement("div");
            element.classList.add("inline");
            //element.setAttribute("id", wid);
            cell.appendChild(element);
            element.innerHTML = UTIL.escapeHTML("name");
        }
    }
    for (var i = 0; i < len; i++) {
        var rowIt = rowItem(results_rows._order,i);
        row = table.insertRow(trow++);
        row.classList.add("rowbg");
        j = 0;
        {
            cell = row.insertCell(j);
            cell.colSpan = 1;
            j++;
            var element = document.createElement("div");
            element.classList.add("inline");
            //element.setAttribute("id", wid);
            cell.appendChild(element);
            element.innerHTML = UTIL.escapeHTML(rowIt["cardid"]);
            cell.setAttribute("onclick", "editPhone("+JSON.stringify(rowIt)+")");
            cell.style.width = "1%";
        }
        {
            cell = row.insertCell(j);
            var nameCell = cell;
            cell.colSpan = 2;
            j++;
            var element = document.createElement("div");
            element.classList.add("inline");
            //element.setAttribute("id", wid);
            cell.appendChild(element);
            element.innerHTML = UTIL.escapeHTML(rowIt["name"]);
        }
        
        for (var pr in rowIt.props) {
            var pra = rowIt.props[pr];

            
            for (var k = 0; k < pra.length; k++) {
                var elm = pra[k];
                if (elm["prop"].startsWith("PHOTO")) {
                    {
                        var img = document.createElement("img");
                        img.src = "data:image/jpeg;base64," + elm["pval"];
                        
                        //nameCell.appendChild(img);
                        nameCell.insertBefore(img, nameCell.firstChild);
                        img.classList.add("photo");
                    }
                } else {
                    row = table.insertRow(trow++);
                    row.classList.add("rowbgl");
                    
                    j = 0;
                
                    var propName = elm["prop"];
                    ["id", "prop", "pval"].forEach(function (el) {
                        cell = row.insertCell(j);
                        cell.colSpan = 1;
                        j++;
                        var element = document.createElement("div");
                        element.classList.add("inline");
                        //element.setAttribute("id", wid);
                        cell.appendChild(element);
                        if (propName.startsWith(CONST_VCARD_TEL) && el == "pval") {
                            var tel = UTIL.escapeHTML(elm[el]);
                            element.innerHTML = '<a href="tel: ' + tel + '">' + tel + '</a>';
                        } else {
                            element.innerHTML = UTIL.escapeHTML(elm[el]);
                        }
                        if (el == "id") {
                            element.classList.add("right");
                        }
                        if (el == "id" || el == "prop") {
                            cell.style.width = "1%";
                        }
                    });
                }
            }
        }
        
        /*
            if (p == "id") {
                cell.setAttribute("onclick", "editPhone("+JSON.stringify(rowIt)+")");
            }
        */
        //console.log(i, results_rows.item(i));
    }
}
function showTables() {
showTable(db, "idphone");
showTable(db, "phoneProp");
}

document.getElementById('files').addEventListener('change', handleFileSelect, false);
    var db = openDatabase('sevnPhones', '1.0', 'Phones db', 20 * 1024 * 1024);
//dropTables(db, ["phoneProp", "idphone"]);
    
    db.transaction(
        function(transaction) {
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS idphone ' +
                '  (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, ' +
                '   name TEXT);'
            );
            transaction.executeSql(
                'CREATE TABLE IF NOT EXISTS phoneProp ' +
                '  (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, ' +
                '   cardid INTEGER NOT NULL,'  +
                '   prop TEXT NOT NULL,'  +
                '   pval TEXT NOT NULL,' +
                '   FOREIGN KEY(cardid) REFERENCES idphone(id) );'
            );
        }
    );    
function dropTables(db, names) {
    db.transaction(
        function(transaction) {
            names.forEach(function(name) {
                transaction.executeSql(
                    'DROP TABLE IF EXISTS ' + name
                );
            });
        }
    );
}

function addPhone(db, obj, exists, callback) {
    var fn = null;
    for(let p in obj) {
        if (p.startsWith(CONST_VCARD_FN)) {
            fn = obj[p];
        }
    }

    findPhone(db, fn, 
        function() {
            exists.push(obj);
            console.log("-----------", exists.length);
            if (callback) {
                callback();
            }
        }, 
        function() {
            addPhoneDb(db, obj, fn, callback);
        }
    );
}
function savePhoneProperty(tx, editPhoneObj, parr, i) {
    if ( i < parr.length ) {
        savePhonePropertyLine(tx, editPhoneObj, parr, i, 0)
    }
}
function savePhonePropertyLine(tx, editPhoneObj, parr, i, j) {
    if (j < editPhoneObj.props[parr[i]].length) {
        savePhonePropertyElement(tx, editPhoneObj, parr, i, j, editPhoneObj.props[parr[i]][j]);
    } else {
        savePhoneProperty(tx, editPhoneObj, parr, i+1)
    }
}
function savePhonePropertyElement(tx, editPhoneObj, parr, i, j, el) {
    if (el.id) {
        var sqlParam = [el.id];
        if ("_deleted" in el && el._deleted) {
        
            tx.executeSql('DELETE FROM phoneProp WHERE id = ? ', sqlParam, 
                function(transaction, results){ 
                    showStatus("Deleted: " + results.rowsAffected);
                    //console.log(results); 
                    savePhonePropertyLine(tx, editPhoneObj, parr, i, j+1);
                }, 
                function(err) { 
                    showStatus("Error");
                    //console.log(err);
                    return true;
                }
            );                            
        } else {
            sqlParam = [el.pval, el.prop, el.id];
            tx.executeSql('UPDATE phoneProp SET pval = ?, prop = ? WHERE id = ? ', sqlParam, 
                function(transaction, results){ 
                    showStatus("Updated: " + results.rowsAffected);
                    //console.log(results); 
                    savePhonePropertyLine(tx, editPhoneObj, parr, i, j+1);
                }, 
                function(err) { 
                    showStatus("Error");
                    //console.log(err);
                    return true;
                }
            );                            
        }
    } else {
        addPhonePropDb(tx, editPhoneObj.cardid, el.prop, el.pval, function(){
            savePhonePropertyLine(tx, editPhoneObj, parr, i, j+1);
        });
    }

}
function savePhone(editPhoneObj) {
//////////////////////////////editPhoneObj
    if (editPhoneObj.cardid) {
        db.transaction(function (tx) {
            tx.executeSql('UPDATE idphone SET name = ? WHERE id = ? ', [editPhoneObj.name, editPhoneObj.cardid], 
                function(transaction, results){ 
                    showStatus("Updated: " + results.rowsAffected + " rows");
                    //console.log(tx,db); 
                    savePhoneProperty(tx, editPhoneObj, Object.keys(editPhoneObj.props), 0);
                }, 
                function(err) { 
                    showStatus("Error");
                    console.log(err);
                    return true;
                }
            );
        });
    } else {
        db.transaction(function (tx) {
            tx.executeSql('INSERT INTO idphone (name) VALUES (?)', [editPhoneObj.name], 
                function(transaction, results){ 
                    editPhoneObj.cardid = results.insertId;
                    showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
                    //console.log(tx,db); 
                    savePhoneProperty(tx, editPhoneObj, Object.keys(editPhoneObj.props), 0);
                }, 
                function(err) { 
                    showStatus("Error");
                    console.log(err);
                    return true;
                }
            );
        });    
    }
}
    
function addPhoneDb(db, obj, fn, callback) {
    if (fn) {
        db.transaction(function (tx) {
            tx.executeSql('INSERT INTO idphone (name) VALUES (?)', [fn], 
                function(transaction, results){ 
                    showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
                    //console.log(tx,db); 
                    addPhoneProp(tx, results.insertId, obj, callback);
                }, 
                function(err) { 
                    showStatus("Error");
                    console.log(err);
                    if (callback) {
                        callback(err);
                    }
                    return true;
                }
            );
        });
    }
}    
function addPhoneProp(tx, cardid, obj, callback) {
    for (var p in obj) {
        addPhonePropDb(tx, cardid, p, obj[p], null, null, callback);
    }
}
function addPhonePropDb(tx, cardid, p, obj, callbackOk, callbackErr, callback) {
    tx.executeSql('INSERT INTO phoneProp (cardid, prop, pval) VALUES (?, ?, ?)', [cardid, p, obj], 
        function(transaction, results){ 
            showStatus("Inserted: " + results.rowsAffected + " rows,  id=" + results.insertId);
            //console.log(results); 
            if (callbackOk) {
                callbackOk(null, results);
            }
            if (callback) {
                callback(null, results);
            }
        }, 
        function(err) { 
            showStatus("Error");
            console.log(err, cardid, p, obj);
            if (callbackErr) {
                callbackErr(err);
            }
            if (callback) {
                callback(err);
            }
            return true;
        }
    );
}

function findPhone(db, name, callbackFound, callbackNotFound) {
    db.transaction(function (tx) {
        tx.executeSql('SELECT id FROM idphone WHERE name = ?', [name], 
            function (tx, results) {
                if (results.rows.length) {
                    if (callbackFound) {
                        callbackFound(results);
                    }
                } else {
                    if (callbackNotFound) {
                        callbackNotFound(results);
                    }
                }
            },
            function(err) { 
                console.log(err);
            }
        );
    });
}  
function showTable(db, table) {
    db.transaction(function (tx) {
        tx.executeSql('SELECT ROWID, * FROM ' + table, [], 
            function (tx, results) {
                var len = results.rows.length;
                let msg = "<p>Found rows: " + len + "</p>";
                console.log(msg);
        
                for (let i = 0; i < len; i++) {
                    console.log(i, results.rows.item(i));
                }
            },
            function(err) { 
                console.log(err);
            }
        );
    });
}  
//showTable(db, "idphone");
//showTable(db, "phoneProp");
showPhones(db, 2);

</script>
</body>
</html>