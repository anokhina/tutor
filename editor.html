<!DOCTYPE html>
<!--
Copyright 2018 Veronica Anokhina.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!-- 
https://github.com/ajaxorg/ace-builds/
https://ace.c9.io/api/editor.html
https://github.com/ajaxorg/ace/wiki/Default-Keyboard-Shortcuts
-->
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Editor</title>
  <style type="text/css" media="screen">
    .ace_editor {
        position: relative !important;
        border: 1px solid lightgray;
        margin: auto;
        height: 200px;
        width: 100%;
    }
    .ace_editor.fullScreen {
        height: auto;
        width: auto;
        border: 0;
        margin: 0;
        position: fixed !important;
        top: 30px;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
    }
    .fullScreen {
        overflow: hidden
    }
    .fileUploadSpan {
        background-color: buttonface;
    }
    input[type="search"], select, input[type="button"], button, input[type="file"], .fileUploadSpan {
        outline: none;
        margin: 2px 0px 0px 0px;
        color: #267792;
        padding: 2px 6px;
        border: medium solid lightgray;
        border-radius: 10px 10px 10px 10px;
        box-shadow: 0 0 12px 0 lightblue;
    }
    input[type="button"], button {
        cursor: pointer;
        display: inline-block;
        text-align: center;
    }
    input[type="search"]:hover, select:hover, input[type="button"]:hover, button:hover, input[type="file"]:hover, .fileUploadSpan:hover{
        border: medium solid #3dbbe4;
    }
    .inline {
        display: inline-block;
        padding-top: 2px;
    }      

    .fileUpload {
        display: inline;
        position: relative;
        overflow: hidden;
        margin: 0px 2px;
    }
    .fileUpload input.upload {
        position: absolute;
        top: 0;
        right: 0;
        margin: 0;
        padding: 0;
        cursor: pointer;
        opacity: 0;
        filter: alpha(opacity=0);
    }
    #exportForm {
        border: medium solid lightgray;
        border-width: thin;
        border-radius: 5px;
        margin: 2px 0px 0px 0px;
    }
  </style>
</head>
<body>
<div class="controldiv">
    <div id="editorLen" class="inline"></div>
    Go to:
    <input type="search" 
        onchange="if(!isNaN(parseInt(this.value))){editor.gotoLine(this.value,0);}editor.focus();"
        id="gotoLine" name="gotoLine" 
        size="5" min="1" maxlength="5" oninput="this.value=this.value.slice(0,this.maxLength||1/1);this.value=!isNaN(parseInt(this.value)) ? ((parseInt(this.value) < parseInt(this.min))? (parseInt(this.min)) : parseInt(this.value)) : (this.value == '-') ? '-' : ''"/>
    
    Paste:<input type="search" name="clipboardDataInp" id="clipboardDataInp" onchange="selectedText=this.value">
    
    <input type="search" name="entryselMode" id="entryselMode" onKeyUp="findIt(selMode,this.value)">
    <select name="selMode" id="selMode" onchange="setMode(this)"></select>
    <input type="search" name="entryselTheme" id="entryselTheme" onKeyUp="findIt(selTheme,this.value)">
    <select name="selTheme" id="selTheme"  onchange="setTheme(this)"></select>
    <input type="button" value="Show content" onclick="alert(''+editor.getValue())" />
    <input type="button" value="Select all" onclick="editor.selectAll();" />

    <input type="button" value="Ctr+Home" onclick="editor.gotoLine(0,0);editor.focus();" />
    <input type="button" value="Ctr+End" onclick="editor.gotoLine(editor.session.getLength(), 0);editor.navigateLineEnd();editor.focus();" />
    <input type="button" value="Home" onclick="editor.navigateLineStart();editor.focus();" />
    <input type="button" value="End" onclick="editor.navigateLineEnd();editor.focus();" />
    <input type="button" value="&lt;" onclick="editor.navigateLeft();editor.focus();" />
    <input type="button" value="&gt;" onclick="editor.navigateRight();editor.focus();" />
    <input type="button" value="&uArr;" onclick="editor.navigateUp();editor.focus();" />
    <input type="button" value="&dArr;" onclick="editor.navigateDown();editor.focus();" />
    
    
    <input type="button" value="S Ctr+Home" onclick="editor.getSelection().selectFileStart();editor.focus();" />
    <input type="button" value="S Ctr+End" onclick="editor.getSelection().selectFileEnd();editor.focus();" />
    <input type="button" value="S Home" onclick="editor.getSelection().selectLineStart();editor.focus();" />
    <input type="button" value="S End" onclick="editor.getSelection().selectLineEnd();editor.focus();" />
    <input type="button" value="S &lt;" onclick="editor.getSelection().selectLeft();editor.focus();" />
    <input type="button" value="S &gt;" onclick="editor.getSelection().selectRight();editor.focus();" />
    <input type="button" value="S &uArr;" onclick="editor.getSelection().selectUp();editor.focus();" />
    <input type="button" value="S &dArr;" onclick="editor.getSelection().selectDown();editor.focus();" />
    
    <input type="button" value="Copy" onclick="editor.focus();document.execCommand('copy');" />
    <input type="button" value="Cut" onclick="editor.focus();document.execCommand('cut');" />
    <input type="button" value="Paste" onclick="editor.session.insert(editor.getCursorPosition(), selectedText);editor.focus();" />
    <input type="button" value="Undo" onclick="editor.focus();editor.undo();" />
    <input type="button" value="Redo" onclick="editor.focus();editor.redo();" />
    <input type="button" value="Fullscreen" onclick="fullScr();" />

    <input type="button" value="Find" onclick="editor.focus();editor.execCommand('find');" />
    
    <input type="button" onclick="exportData()" value="Save as..."/>
    
    <form id="exportForm">
    <table style="width:100%"><tr>
    <td>
    <button type="reset" value="Reset" class="Reset">x</button>
    <input id="uploadFile" placeholder="Open file" disabled="disabled" />
    <div class="fileUpload">
    <span class="fileUploadSpan">Open</span><input type="file" id="files1" name="files1[]" onchange="document.getElementById('uploadFile').value = this.value" class="upload"/>
    </div>
    </td>
    </tr>
    </table>
    </form>    
    
    <input type="button" onclick="newFile()" value="New"/>
</div>
<pre id="editor">function foo(items) {
    var i;
    for (i = 0; i &lt; items.length; i++) {
        alert("Ace Rocks " + items[i]);
    }

}</pre>

<script src="ace/src-noconflict/ace.js"></script>
<script src="ace/src-noconflict/ext-themelist.js"></script>
<script src="ace/src-noconflict/ext-modelist.js"></script>

<script type="text/javascript" src="jslib/UTIL.js"></script>
<script type="text/javascript" src="jslib/UTILIO.js"></script>

<script>
function findIt(selobj,field_value) {
    for(var i = 0; i < selobj.options.length; i++) {
        if (selobj.options[i].text.startsWith(field_value)) {
            selobj.value = selobj.options[i].value;
            selobj.onchange();
            break;
        }
    }
}
function setMode(sel) {
    editor.session.setMode(sel.value);    
}
function setTheme(sel) {
    editor.setTheme(sel.value);
}
var selMode = document.getElementById("selMode");
var selTheme = document.getElementById("selTheme");
var themes = ace.require("ace/ext/themelist").themes;
var themess = ace.require("ace/ext/themelist").themes.map(function(t){return t.theme});
var modes = ace.require("ace/ext/modelist").modes;
for (var i = 0; i < themes.length; i++) {
    var option = document.createElement("option");
    option.value = themes[i].theme;
    option.text = themes[i].name;
    selTheme.appendChild(option);
}
var modeExt = {
    java: "java",
    js: "javascript",
    txt: "text"
};

for (var i = 0; i < modes.length; i++) {
    var option = document.createElement("option");
    option.value = modes[i].mode;
    var modeName = modes[i].name;
    option.text = modeName;
    modes[i].extensions.split("|").forEach(function(e) {
        if ( e in modeExt) {} else {
            modeExt[e] = modeName;
        }
    });
    selMode.appendChild(option);
}
console.log(modeExt);

var $ = document.getElementById.bind(document);
var dom = ace.require("ace/lib/dom");
function fullScr() {
    var fullScreen = dom.toggleCssClass(document.body, "fullScreen")
    dom.setCssClass(editor.container, "fullScreen", fullScreen)
    editor.setAutoScrollEditorIntoView(!fullScreen)
    editor.resize()
}
var editor = ace.edit("editor");
editor.setTheme("ace/theme/twilight");
selTheme.value="ace/theme/twilight";
editor.session.setMode("ace/mode/javascript");
selMode.value="ace/mode/javascript";
editor.renderer.setScrollMargin(10, 10);
editor.setOptions({
    // "scrollPastEnd": 0.8,
    autoScrollEditorIntoView: true
});
editor.$blockScrolling = Infinity;
editor.getSession().on('change', function() {
    showRows();
});
editor.on("copy", function(text) {
    selectedText = text;
    document.getElementById("clipboardDataInp").value = selectedText;
});
editor.on("paste", function(evt) {
    selectedText = evt.text;
    document.getElementById("clipboardDataInp").value = selectedText;
});
function showRows() {
    document.getElementById("editorLen").innerHTML="Rows:" + editor.session.getLength();
}
function scroll(speed) {
    var top = editor.container.getBoundingClientRect().top
    speed = speed || 10
    if (top > 60 && speed < 500) {
        if (speed > top - speed - 50)
            speed = top - speed - 50
        else
            setTimeout(scroll, 10, speed + 10)
        window.scrollBy(0, speed)
    }
}
//window.scroll = scroll;
showRows();

var selectedText = "";
var openedFile = null;
document.getElementById('files1').addEventListener('change', 
    function(evt) {
        new UTILIO.FileOpenerText(function(text, f){
            editor.setValue(text, -1); //TODO remember line
            editor.focus();
            openedFile = f;
            var idx = f.name.lastIndexOf(".");
            if (idx > 0) {
                var ext = f.name.substring(idx+1);
                console.log(ext);
                if (ext in modeExt) {
                    findIt(selMode, modeExt[ext]);
                }
            }
        }).handleFileSelect(evt);
    }, false);

function exportData() {
    var fileName = "Unnamed";
    if (openedFile) {
        //File.webkitRelativePath 
        fileName = openedFile.name;
    }
    UTILIO.saveAs(UTILIO.text2blob(editor.getValue()), fileName);
}
function newFile() {
    if (confirm("Create a new document? All unsaved data will be lost.") == true) {
        editor.setValue("");
        openedFile = null;
    }
}
</script>

</body>
</html>